<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GabaritKDP - Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 text-gray-900">
  <header class="bg-slate-800 text-white p-4 shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <h1 id="folderName" class="text-xl font-bold text-orange-400">Marketplace</h1>
      <a href="marketplace.html" class="bg-slate-700 px-4 py-2 rounded-lg text-sm hover:bg-slate-600 border border-slate-600">← Back</a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6">
    <div id="explorerGrid" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>

    <div id="loader" class="flex flex-col items-center justify-center py-20">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mb-4"></div>
      <p class="text-gray-500 italic">Loading templates...</p>
    </div>

    <div id="debug" class="hidden max-w-4xl mx-auto mt-6 p-4 rounded-lg border border-red-200 bg-red-50 text-red-800 text-sm whitespace-pre-wrap"></div>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const lang = localStorage.getItem('preferredLanguage') || 'en';
    const CDN_BASE = "https://gabaritkdp.b-cdn.net";

    let path = params.get('path') || 'FULL COVER';
    path = (path || '').trim();

    // ✅ détecte si on est dans la section BACKGROUNDS
    const isBackgroundPath = (path || '').toLowerCase().startsWith('backgrounds/');

    function encodeBunnyPath(p) {
      return p.split('/').map(seg => encodeURIComponent(seg)).join('/');
    }

    // Option A: 1 vignette per folder (webp -> jpg -> png), plus legacy nested fallback
    function vignetteCandidates(folderPath) {
      const base = `${CDN_BASE}/${encodeBunnyPath(folderPath)}`;
      const last = folderPath.split('/').filter(Boolean).pop();
      const baseLegacy = `${base}/${encodeURIComponent(last)}`;
      const names = ["vignette.webp", "vignette.jpg", "vignette.png"];
      const out = [];
      names.forEach(n => out.push(`${base}/${n}`));
      names.forEach(n => out.push(`${baseLegacy}/${n}`));
      return out;
    }

    function setImgFallback(imgEl) {
      const list = (imgEl.dataset.fallbacks || "").split("|").filter(Boolean);
      const i = parseInt(imgEl.dataset.fallbackIndex || "0", 10);

      if (i < list.length - 1) {
        imgEl.dataset.fallbackIndex = String(i + 1);
        imgEl.src = list[i + 1];
        return;
      }

      const label = ((imgEl.dataset.fallbackLabel || "KDP") + "").toUpperCase().slice(0, 24);
      const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#1e293b"/>
      <stop offset="1" stop-color="#334155"/>
    </linearGradient>
  </defs>
  <rect width="100%" height="100%" fill="url(#g)"/>
  <text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle"
        font-family="system-ui, -apple-system, Segoe UI, Arial" font-size="64"
        fill="white" font-weight="800">${label}</text>
</svg>`;
      imgEl.src = "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg.trim());
    }

    function showDebug(msg) {
      const box = document.getElementById('debug');
      box.classList.remove('hidden');
      box.textContent = msg;
    }

    function getButtonLabel(isDir) {
      if (isDir) return (lang === 'fr' ? 'OUVRIR' : 'OPEN');
      return (lang === 'fr' ? 'UTILISER' : 'USE TEMPLATE');
    }

    function makeCard({ title, imgSrc, isDir, onClick, fallbacks }) {
      const card = document.createElement('div');
      card.className = "bg-white rounded-xl border border-gray-200 overflow-hidden cursor-pointer shadow-sm p-2 hover:shadow-md transition";
      card.innerHTML = `
        <div class="aspect-[4/3] bg-gray-100 rounded-lg overflow-hidden">
          <img src="${imgSrc}" class="w-full h-full object-cover"
               data-fallbacks="${fallbacks || ''}"
               data-fallback-label="${title}"
               data-fallback-index="0"
               onerror="setImgFallback(this)">
        </div>
        <div class="p-3">
          <h3 class="font-semibold text-xs truncate text-gray-800">${title}</h3>
          <button class="mt-3 w-full ${isDir ? 'bg-gray-100 text-gray-600' : 'bg-orange-500 text-white'} py-2 rounded-lg text-[10px] font-black uppercase">
            ${getButtonLabel(isDir)}
          </button>
        </div>
      `;
      card.onclick = onClick;
      return card;
    }

    async function init() {
      const grid = document.getElementById('explorerGrid');
      const loader = document.getElementById('loader');

      const folderName = path.split('/').filter(Boolean).pop() || 'Marketplace';
      document.getElementById('folderName').innerText = folderName;

      try {
        const url = `/.netlify/functions/list-bunny?path=${encodeURIComponent(path)}`;
        const response = await fetch(url);

        if (!response.ok) {
          const txt = await response.text();
          throw new Error(`Netlify function error (${response.status})\nURL: ${url}\n\n${txt}`);
        }

        const items = await response.json();
        loader.classList.add('hidden');

        if (!Array.isArray(items)) {
          throw new Error(`Unexpected response (not an array):\n${JSON.stringify(items, null, 2)}`);
        }

        // Ignore vignette files as standalone items
        const filtered = items.filter(it => {
          const n = (it.name || '').toLowerCase();
          return n !== 'vignette.png' && n !== 'vignette.jpg' && n !== 'vignette.webp';
        });

        const dirs = filtered.filter(it => it.isDir);
        const files = filtered.filter(it => !it.isDir);

        // Folders first
        dirs.forEach(dir => {
          const cands = vignetteCandidates(dir.path);
          grid.appendChild(makeCard({
            title: dir.name,
            imgSrc: cands[0],
            fallbacks: cands.join("|"),
            isDir: true,
            onClick: () => window.location.href = `category.html?path=${encodeURIComponent(dir.path)}`
          }));
        });

        // Then files
        files.forEach(file => {
          grid.appendChild(makeCard({
            title: file.name,
            imgSrc: file.url,
            fallbacks: "",
            isDir: false,
            onClick: () => {
              // ✅ BACKGROUNDS => recto (img=)
              // ✅ FULL COVER / autres => full cover (template=)
              const target = isBackgroundPath
                ? `generator.html?trim=6x9&img=${encodeURIComponent(file.url)}&src=backgrounds`
                : `generator.html?trim=6x9&template=${encodeURIComponent(file.url)}&src=templates`;

              window.location.href = target;
            }
          }));
        });

        if (dirs.length === 0 && files.length === 0) {
          showDebug(`No items found.\n\nPath: ${path}\nHint: check Bunny folder name/case and whether the folder contains subfolders/files.`);
        }

      } catch (err) {
        loader.classList.add('hidden');
        showDebug(String(err && err.message ? err.message : err));
      }
    }

    init();
  </script>
</body>
</html>
