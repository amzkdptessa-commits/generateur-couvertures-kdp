<script>
    const params = new URLSearchParams(window.location.search);
    let path = params.get('path') || 'FULL COVER';
    // On récupère la langue actuelle
    const lang = localStorage.getItem('preferredLanguage') || 'en';

    async function initExplorer() {
        const grid = document.getElementById('explorerGrid');
        const loader = document.getElementById('loader');
        const statusArea = document.getElementById('statusArea');
        document.getElementById('folderName').innerText = path.split('/').pop() || 'Marketplace';

        try {
            const response = await fetch(`/.netlify/functions/list-bunny?path=${encodeURIComponent(path)}`);
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            const items = await response.json();

            loader.classList.add('hidden');
            statusArea.classList.remove('py-20');

            items.forEach(item => {
                if (item.name.toLowerCase() === 'vignette.png') return;

                const card = document.createElement('div');
                card.className = "card bg-white rounded-xl border border-gray-200 overflow-hidden cursor-pointer shadow-sm";
                
                // Labels traduits
                const labelOpen = lang === 'fr' ? 'OUVRIR' : 'OPEN';
                const labelUse = lang === 'fr' ? 'UTILISER' : 'USE TEMPLATE';

                card.innerHTML = `
                    <div class="aspect-[4/3] bg-gray-100 relative">
                        <img src="${item.url}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/400x300?text=KDP+Template'" loading="lazy">
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-sm truncate text-gray-800">${item.name}</h3>
                        <button class="mt-3 w-full ${item.isDir ? 'bg-gray-100 text-gray-700' : 'bg-orange-500 text-white'} py-2 rounded-lg text-[10px] font-black uppercase tracking-widest">
                            ${item.isDir ? labelOpen : labelUse}
                        </button>
                    </div>
                `;

                card.onclick = () => {
                    if (item.isDir) {
                        window.location.href = `category.html?path=${encodeURIComponent(item.path)}`;
                    } else {
                        window.location.href = `generator.html?template=${encodeURIComponent(item.url)}`;
                    }
                };
                grid.appendChild(card);
            });
        } catch (err) {
            loader.innerHTML = `<p class="text-red-500">Erreur : ${err.message}</p>`;
        }
    }
    document.addEventListener('DOMContentLoaded', initExplorer);
</script>