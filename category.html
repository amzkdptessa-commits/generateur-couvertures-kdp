<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GabaritKDP - Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">

<header class="bg-slate-800 text-white p-4 shadow-md sticky top-0 z-50">
  <div class="max-w-7xl mx-auto flex justify-between items-center">
    <h1 id="title" class="text-xl font-bold">Explorer</h1>
    <button id="backBtn" class="bg-slate-600 hover:bg-slate-500 px-4 py-2 rounded-lg text-sm hidden">← Back</button>
  </div>
</header>

<main class="max-w-7xl mx-auto p-6">
  <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
  <p id="loading" class="text-center text-gray-500 mt-8">Loading…</p>
</main>

<script>
  // ===== Option A : 1 vignette par dossier =====
  // Pour un dossier: <dossier>/vignette.webp puis .png puis .jpg
  // Pour un fichier: on utilise item.url
  // Remplacement d'une vignette (même nom) => Bunny peut servir l'ancienne version (cache) : purge ou cache-bust.

  const API_ENDPOINT = '/.netlify/functions/list-bunny';
  const CDN_BASE = 'https://gabaritkdp.b-cdn.net';

  // Cache-bust léger (change toutes les 10 minutes) : pratique quand vous remplacez une vignette.
  const CACHE_BUST = Math.floor(Date.now() / (10 * 60 * 1000));

  const titleEl = document.getElementById('title');
  const backBtn = document.getElementById('backBtn');
  const grid = document.getElementById('grid');
  const loading = document.getElementById('loading');

  function svgPlaceholder(text) {
    const safe = String(text || 'Preview').slice(0, 40).replace(/[&<>]/g, '');
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="800" height="600">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#0f172a" />
            <stop offset="1" stop-color="#334155" />
          </linearGradient>
        </defs>
        <rect width="100%" height="100%" fill="url(#g)" />
        <text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle"
              font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial"
              font-size="42" fill="#ffffff" opacity="0.92">${safe}</text>
      </svg>`;
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
  }

  function encodePath(path) {
    return String(path || '')
      .split('/')
      .filter(Boolean)
      .map(seg => encodeURIComponent(seg))
      .join('/');
  }

  function vignetteCandidatesForDir(dirPath) {
    const enc = encodePath(dirPath);
    return [
      `${CDN_BASE}/${enc}/vignette.webp?v=${CACHE_BUST}`,
      `${CDN_BASE}/${enc}/vignette.png?v=${CACHE_BUST}`,
      `${CDN_BASE}/${enc}/vignette.jpg?v=${CACHE_BUST}`
    ];
  }

  function setImgWithCandidates(img, candidates, label) {
    let i = 0;
    const tryNext = () => {
      if (i >= candidates.length) {
        img.onerror = null;
        img.src = svgPlaceholder(label);
        return;
      }
      img.src = candidates[i++];
    };
    img.onerror = tryNext;
    tryNext();
  }

  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  let currentPath = getParam('path') || '';

  function updateTitle() {
    if (!currentPath) {
      titleEl.textContent = 'Explorer';
      backBtn.classList.add('hidden');
      return;
    }
    const parts = currentPath.split('/').filter(Boolean);
    titleEl.textContent = parts[parts.length - 1] || 'Explorer';
    backBtn.classList.remove('hidden');
  }

  function parentPath(p) {
    const parts = String(p || '').split('/').filter(Boolean);
    parts.pop();
    return parts.join('/');
  }

  backBtn.addEventListener('click', () => {
    const p = parentPath(currentPath);
    const url = new URL(window.location.href);
    if (p) url.searchParams.set('path', p);
    else url.searchParams.delete('path');
    window.location.href = url.toString();
  });

  async function fetchItems(path) {
    const url = `${API_ENDPOINT}?path=${encodeURIComponent(path || '')}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`API error: ${res.status}`);
    return res.json();
  }

  function createCard(item) {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-xl shadow hover:shadow-lg transition overflow-hidden border';

    const img = document.createElement('img');
    img.className = 'w-full h-44 object-cover bg-slate-200';
    img.alt = item.name;

    if (item.isDir) {
      setImgWithCandidates(img, vignetteCandidatesForDir(item.path), item.name);
    } else {
      img.src = item.url || svgPlaceholder(item.name);
      img.onerror = () => { img.src = svgPlaceholder(item.name); };
    }

    const body = document.createElement('div');
    body.className = 'p-4';

    const h3 = document.createElement('h3');
    h3.className = 'font-semibold text-sm tracking-wide uppercase';
    h3.textContent = item.name;

    const p = document.createElement('p');
    p.className = 'text-xs text-gray-500 mt-1';
    p.textContent = item.isDir ? 'Folder' : 'File';

    const btn = document.createElement('button');
    btn.className = 'mt-3 w-full bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg text-sm';
    btn.textContent = item.isDir ? 'Open' : 'Use';

    btn.addEventListener('click', () => {
      if (item.isDir) {
        const url = new URL(window.location.href);
        url.searchParams.set('path', item.path);
        window.location.href = url.toString();
      } else if (item.url) {
        window.open(item.url, '_blank');
      }
    });

    body.appendChild(h3);
    body.appendChild(p);
    body.appendChild(btn);

    card.appendChild(img);
    card.appendChild(body);

    return card;
  }

  async function render() {
    updateTitle();
    grid.innerHTML = '';
    loading.style.display = 'block';

    try {
      const data = await fetchItems(currentPath);
      const items = (data && data.items) ? data.items : [];

      // folders first
      items.sort((a, b) => {
        const ad = a.isDir ? -1 : 1;
        const bd = b.isDir ? -1 : 1;
        if (ad !== bd) return ad - bd;
        return String(a.name).localeCompare(String(b.name), 'fr', { sensitivity: 'base' });
      });

      items.forEach(item => grid.appendChild(createCard(item)));

      if (!items.length) {
        const empty = document.createElement('div');
        empty.className = 'col-span-full text-center text-gray-500 py-12';
        empty.textContent = 'No items found.';
        grid.appendChild(empty);
      }

    } catch (e) {
      console.error(e);
      const err = document.createElement('div');
      err.className = 'col-span-full bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg';
      err.innerHTML = `<div class="font-semibold">Unable to load this folder.</div>
                       <div class="text-sm mt-1">${String(e.message || e)}</div>`;
      grid.appendChild(err);
    } finally {
      loading.style.display = 'none';
    }
  }

  render();
</script>

</body>
</html>
