<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>GabaritKDP - Analyse 12 Mois</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; }
        .accent { color: #f97316; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-bold italic">GabaritKDP <span class="accent text-xl">Analyse Annuelle</span></h1>
                <p class="text-slate-400 text-sm">Compte : peacestreet@hotmail.com</p>
            </div>
            <div class="text-right">
                <div id="statusBadge" class="bg-slate-800 px-4 py-1 rounded-full text-xs mb-2 text-green-400 font-bold">Connecté</div>
                <button onclick="loadAnalytics()" class="bg-orange-600 hover:bg-orange-700 px-6 py-2 rounded-lg font-bold transition">
                    <i class="fas fa-sync-alt mr-2"></i> ACTUALISER LE DASHBOARD
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 text-center">
            <div class="card"><h4 class="text-slate-500 text-xs uppercase font-bold">Royalties (12 mois)</h4><div class="text-4xl font-bold accent" id="valMoney">0.00 €</div></div>
            <div class="card"><h4 class="text-slate-500 text-xs uppercase font-bold">Unités Totales</h4><div class="text-4xl font-bold" id="valUnits">0</div></div>
            <div class="card"><h4 class="text-slate-500 text-xs uppercase font-bold">Livres avec ventes</h4><div class="text-4xl font-bold text-blue-400" id="valBooks">0</div></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 card">
                <h3 class="font-bold mb-6 flex items-center gap-2"><i class="fas fa-book accent"></i> Détails par Livre</h3>
                <div class="overflow-x-auto h-96">
                    <table class="w-full text-left text-sm">
                        <thead class="text-slate-500 border-b border-slate-700">
                            <tr><th class="pb-3">Titre du livre</th><th class="pb-3">Unités</th><th class="pb-3">Royalties Est.</th></tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-800">
                            <tr><td colspan="3" class="py-20 text-center text-slate-500">Cliquez sur Actualiser...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h3 class="font-bold mb-6 flex items-center gap-2"><i class="fas fa-globe accent"></i> Répartition Pays</h3>
                <div class="h-64"><canvas id="chartPays"></canvas></div>
                <div id="marketLegend" class="mt-6 space-y-2 text-xs text-slate-400"></div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://bgcspojhiupcrpzlkwax.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJnY3Nwb2poaXVwY3Jwemxrd2F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3Nzc1NjUsImV4cCI6MjA4MDM1MzU2NX0.8-kcGquwHwv8BCFYZtWu1Op7TLMIfWjXghES2IwJl7Q';
        const sb = window.supabase.createClient(SB_URL, SB_KEY);
        let myChart = null;

        async function loadAnalytics() {
            try {
                // 1. Récupérer le tout dernier rapport
                const { data, error } = await sb.from('kdp_reports').select('*').eq('user_email', 'peacestreet@hotmail.com').order('created_at', { ascending: false }).limit(1);
                
                if (error) throw error;
                if (!data || data.length === 0) return;

                const payload = data[0].payload;
                console.log("Structure reçue d'Amazon :", payload);

                // 2. LOGIQUE SCANNER : On cherche où sont les ventes dans le JSON d'Amazon
                // On essaie les 4 formats connus de KDP
                let rawBooks = [];
                if (payload.data && payload.data.rows) rawBooks = payload.data.rows; // Format API v1
                else if (payload.entries) rawBooks = payload.entries; // Format API v2
                else if (payload.reports) rawBooks = payload.reports; // Format API v3
                else if (Array.isArray(payload)) rawBooks = payload; // Format direct

                render(rawBooks);
            } catch (e) {
                console.error("Erreur Dashboard:", e);
            }
        }

        function render(books) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            let units = 0;
            let money = 0;
            const markets = {};

            if (!books || books.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="py-20 text-center text-slate-500 italic">Aucune donnée trouvée dans le rapport. Assurez-vous d\'avoir des ventes sur les 12 derniers mois.</td></tr>';
                return;
            }

            books.forEach(b => {
                // On s'adapte aux noms de colonnes d'Amazon qui varient
                const title = b.title || b.bookTitle || b.asin || "Livre inconnu";
                const u = parseInt(b.units || b.totalUnits || b.quantity || 0);
                const r = parseFloat(b.royalty || b.totalRoyalty || b.estimatedRoyalty || 0);
                const m = b.marketplace || b.market || "US";

                units += u;
                money += r;
                markets[m] = (markets[m] || 0) + u;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-800/50">
                        <td class="py-4 pr-4 font-medium">${title}</td>
                        <td class="py-4">${u}</td>
                        <td class="py-4 font-bold accent">${r.toFixed(2)} €</td>
                    </tr>`;
            });

            document.getElementById('valUnits').textContent = units;
            document.getElementById('valMoney').textContent = money.toFixed(2) + " €";
            document.getElementById('valBooks').textContent = books.length;

            updateChart(markets);
        }

        function updateChart(markets) {
            const ctx = document.getElementById('chartPays').getContext('2d');
            if (myChart) myChart.destroy();
            const labels = Object.keys(markets);
            const data = Object.values(markets);

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#f97316', '#3b82f6', '#10b981', '#a855f7', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const legend = document.getElementById('marketLegend');
            legend.innerHTML = '';
            labels.forEach((l, i) => {
                legend.innerHTML += `<div class="flex justify-between"><span>Marché ${l}</span><span class="font-bold text-white">${data[i]} unités</span></div>`;
            });
        }

        window.onload = loadAnalytics;
    </script>
</body>
</html>