<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard – GabaritKDP</title>

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous"
        referrerpolicy="no-referrer"/>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tailwind (utile si ton footer.html utilise Tailwind) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg-dark:#0f1115;
      --card-bg:#1a1d23;
      --accent:#ff8c1a;
      --text-dim:#b0b0b0;
      --border:#2b2f38;
    }

    body{margin:0;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg-dark);color:#fff}

    /* ===== HEADER CSS (indispensable car header.html n’embarque pas le style) ===== */
    .header-nav{background:linear-gradient(135deg,#1e293b 0%,#334155 100%);padding:15px 0;box-shadow:0 4px 20px rgba(0,0,0,.2);position:sticky;top:0;z-index:1000}
    .nav-container{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:0 20px;flex-wrap:wrap;gap:0}
    .logo-nav{display:flex;align-items:center;gap:15px;text-decoration:none;color:#fff}
    .logo-nav img{height:40px;width:auto}
    .logo-nav span{font-size:1.3rem;font-weight:800;color:#FF9900}
    .nav-links{width:100%;display:flex;justify-content:center;align-items:center;gap:25px;flex-wrap:wrap;margin-top:10px}
    .nav-links a{color:#fff;text-decoration:none;font-weight:600;transition:.2s;padding:10px 14px;border-radius:10px;display:flex;align-items:center;gap:8px;font-size:.95rem}
    .nav-links a:hover{color:#FF9900;background:rgba(255,153,0,.12)}
    .nav-links a.active{color:#FF9900;background:rgba(255,153,0,.18)}
    .express-nav-btn{background:linear-gradient(135deg,#10b981,#059669)!important;color:#fff!important;border-radius:10px!important;padding:10px 14px!important}
    .express-nav-btn:hover{background:linear-gradient(135deg,#0d9488,#047857)!important;transform:translateY(-2px)!important;box-shadow:0 4px 15px rgba(16,185,129,.35)!important}

    .language-selector{display:flex;align-items:center;gap:0;background:#fff;border-radius:999px;padding:4px;box-shadow:0 4px 14px rgba(0,0,0,.15)}
    .lang-btn{padding:8px 16px;border:none;background:transparent;border-radius:999px;cursor:pointer;transition:.2s;font-weight:800;font-size:.85rem;color:#64748b;min-width:45px}
    .lang-btn.active{background:#FF9900;color:#fff;box-shadow:0 2px 8px rgba(255,153,0,.3)}

    .mobile-menu{display:none;position:fixed;top:0;left:0;width:100%;height:100vh;background:rgba(0,0,0,.95);backdrop-filter:blur(10px);z-index:2000;padding:80px 20px 20px;overflow-y:auto}
    .mobile-menu.active{display:block}
    .mobile-menu-links{display:flex;flex-direction:column;gap:15px;max-width:420px;margin:0 auto}
    .mobile-menu-links a{color:#fff;text-decoration:none;font-weight:800;padding:15px 20px;border-radius:14px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);display:flex;align-items:center;gap:12px;font-size:1.1rem}
    .mobile-menu-close{position:absolute;top:20px;right:20px;background:none;border:none;color:#fff;font-size:1.8rem;cursor:pointer;padding:8px;border-radius:999px}
    .mobile-menu-toggle{display:none;background:none;border:none;color:#fff;font-size:1.6rem;cursor:pointer;padding:8px;border-radius:10px;margin-left:auto}
    @media (max-width:768px){.nav-links{display:none}.mobile-menu-toggle{display:block}}

    /* ===== UI ===== */
    .dashboard-container{max-width:1200px;margin:auto;padding:28px 18px}
    .banner{
      display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
      background:linear-gradient(135deg,#1c140d,#24180f);
      border:1px solid var(--accent);border-radius:14px;padding:18px 18px;margin-bottom:18px
    }
    .btn{
      border:none;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:900;
      display:inline-flex;align-items:center;gap:10px
    }
    .btn-primary{background:var(--accent);color:#000}
    .btn-secondary{background:#374151;color:#fff}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:10px}
    .card{background:var(--card-bg);border:1px solid var(--border);border-radius:14px;padding:18px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    .card h4{margin:0 0 10px 0;color:var(--text-dim);font-size:.82rem;letter-spacing:.08em;text-transform:uppercase}
    .value{font-size:2rem;font-weight:950;color:var(--accent)}

    /* Mode d’emploi */
    .howto-title{margin:0 0 10px 0;font-size:1.05rem;font-weight:900;display:flex;align-items:center;gap:10px}
    .howto-desc{margin:0 0 14px 0;color:var(--text-dim);line-height:1.6}
    .howto-steps{margin:0;padding-left:18px;color:#e5e7eb;line-height:1.7}
    .howto-steps li{margin:6px 0}

    /* Login overlay */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:2500;padding:16px}
    .overlay.active{display:flex}
    .modal{width:100%;max-width:520px;background:var(--card-bg);border:1px solid var(--border);border-radius:18px;padding:22px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
    .modal h2{margin:0 0 6px 0;font-size:1.3rem}
    .modal p{margin:0 0 14px 0;color:var(--text-dim)}
    .modal input{width:100%;padding:14px;border-radius:12px;border:1px solid #3a3f4a;background:#0f1115;color:#fff;outline:none}
    .modal input:focus{border-color:var(--accent)}
    .modal .row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .modal .row .btn{flex:1;justify-content:center}
    .close-x{background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;float:right}
    .hint{margin-top:10px;text-align:center;color:var(--text-dim);font-size:.9rem}
    .error-box{margin-top:12px;color:#ffb4b4;background:rgba(255,0,0,.08);border:1px solid rgba(255,0,0,.25);padding:10px;border-radius:12px;display:none}
    .error-box.active{display:block}
  </style>
</head>

<body>

  <!-- HEADER -->
  <div id="header-placeholder"></div>

  <!-- LOGIN OVERLAY -->
  <div class="overlay" id="loginOverlay" aria-hidden="true">
    <div class="modal">
      <button class="close-x" onclick="closeLogin()">×</button>
      <h2 data-fr="Accès rapide" data-en="Quick access">Accès rapide</h2>
      <p data-fr="Entre ton email GabaritKDP pour afficher tes ventes."
         data-en="Enter your GabaritKDP email to display your sales.">
        Entre ton email GabaritKDP pour afficher tes ventes.
      </p>

      <input type="email" id="userEmail" placeholder="email@exemple.com" />

      <div class="row">
        <button class="btn btn-primary" onclick="handleLogin()">
          <i class="fa-solid fa-right-to-bracket"></i>
          <span data-fr="Se connecter" data-en="Login">Se connecter</span>
        </button>
        <button class="btn btn-secondary" onclick="clearEmail()">
          <i class="fa-solid fa-eraser"></i>
          <span data-fr="Effacer" data-en="Clear">Effacer</span>
        </button>
      </div>

      <div id="loginError" class="error-box"></div>

      <div class="hint" data-fr="Tu peux rouvrir ce panneau via le bouton “Login” du header."
           data-en="You can reopen this panel via the header “Login” button.">
        Tu peux rouvrir ce panneau via le bouton “Login” du header.
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="dashboard-container" id="dashboardSection" style="display:none;">

    <!-- MODE D’EMPLOI + EXTENSION -->
    <div class="card" style="margin-bottom:18px;">
      <h3 class="howto-title">
        <i class="fa-brands fa-chrome" style="color:var(--accent)"></i>
        <span data-fr="Mode d’emploi – Synchroniser tes ventes" data-en="How it works – Sync your sales">
          Mode d’emploi – Synchroniser tes ventes
        </span>
      </h3>

      <p class="howto-desc"
         data-fr="Pour voir tes ventes Amazon KDP ici : installe l’extension Chrome, va sur KDP Reports, clique sur l’icône de l’extension puis sur “Synchronize”. Ensuite reviens ici et clique sur “Rafraîchir”."
         data-en="To see your Amazon KDP sales here: install the Chrome extension, open KDP Reports, click the extension icon then “Synchronize”. Come back here and click “Refresh”.">
        Pour voir tes ventes Amazon KDP ici : installe l’extension Chrome, va sur KDP Reports, clique sur l’icône de l’extension puis sur “Synchronize”. Ensuite reviens ici et clique sur “Rafraîchir”.
      </p>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <a class="btn btn-primary"
           href="https://chromewebstore.google.com/detail/gabaritkdp-tracker/mbngmlkggdapbbncgoijjcbmbcgeomip"
           target="_blank"
           rel="noopener noreferrer"
           style="text-decoration:none;">
          <i class="fa-brands fa-chrome"></i>
          <span data-fr="Télécharger l’extension" data-en="Download extension">Télécharger l’extension</span>
        </a>

        <a class="btn btn-secondary"
           href="https://kdpreports.amazon.com"
           target="_blank"
           rel="noopener noreferrer"
           style="text-decoration:none;">
          <i class="fa-solid fa-arrow-up-right-from-square"></i>
          <span data-fr="Ouvrir KDP Reports" data-en="Open KDP Reports">Ouvrir KDP Reports</span>
        </a>

        <button class="btn btn-secondary" onclick="openLogin(true)">
          <i class="fa-solid fa-user-pen"></i>
          <span data-fr="Changer d’email" data-en="Change email">Changer d’email</span>
        </button>
      </div>

      <div style="margin-top:14px;border-top:1px solid var(--border);padding-top:14px;">
        <ol class="howto-steps">
          <li data-fr="Installe l’extension Chrome (bouton ci-dessus)." data-en="Install the Chrome extension (button above).">Installe l’extension Chrome (bouton ci-dessus).</li>
          <li data-fr="Connecte-toi à KDP Reports : kdpreports.amazon.com." data-en="Log in to KDP Reports: kdpreports.amazon.com.">Connecte-toi à KDP Reports : kdpreports.amazon.com.</li>
          <li data-fr="Clique sur l’icône de l’extension puis sur “Synchronize”." data-en="Click the extension icon then “Synchronize”.">Clique sur l’icône de l’extension puis sur “Synchronize”.</li>
          <li data-fr="Reviens ici et clique sur “Rafraîchir” pour afficher tes ventes." data-en="Come back here and click “Refresh” to display your sales.">Reviens ici et clique sur “Rafraîchir” pour afficher tes ventes.</li>
        </ol>
      </div>
    </div>

    <!-- BANNIÈRE -->
    <div class="banner">
      <div>
        <strong data-fr="GabaritKDP Tracker connecté" data-en="GabaritKDP Tracker Connected">GabaritKDP Tracker connecté</strong><br>
        <small id="lastSync" style="color:var(--text-dim)">Dernière synchronisation : --</small>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="fetchKDPData()">
          <i class="fa-solid fa-rotate"></i>
          <span data-fr="Rafraîchir" data-en="Refresh">Rafraîchir</span>
        </button>

        <button class="btn btn-secondary" onclick="openLogin(true)">
          <i class="fa-solid fa-user-pen"></i>
          <span data-fr="Se connecter / changer d’email" data-en="Login / change email">Se connecter / changer d’email</span>
        </button>
      </div>
    </div>

    <!-- STATS -->
    <div class="stats-grid">
      <div class="card">
        <h4 data-fr="Totalisation des redevances" data-en="Total royalties">Totalisation des redevances</h4>
        <div class="value" id="royaltiesAmt">0,00 €</div>
      </div>
      <div class="card">
        <h4 data-fr="Unités vendues" data-en="Units sold">Unités vendues</h4>
        <div class="value" id="ordersAmt">0</div>
      </div>
      <div class="card">
        <h4 data-fr="KENP lu" data-en="KENP read">KENP lu</h4>
        <div class="value" id="kenpAmt">0</div>
      </div>
      <div class="card">
        <h4 data-fr="Marché principal" data-en="Top marketplace">Marché principal</h4>
        <div class="value" id="topMarket">--</div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div id="footer-placeholder"></div>

  <script>
    /* =========================
       ✅ SUPABASE kdp_reports
       ========================= */
    const SB_URL = 'https://bgcspojhiupcrpzlkwax.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJnY3Nwb2poaXVwY3Jwemxrd2F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3Nzc1NjUsImV4cCI6MjA4MDM1MzU2NX0.8-kcGquwHwv8BCFYZtWu1Op7TLMIfWjXghES2IwJl7Q';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    /* --------------------------
       Header/Footer injection
       -------------------------- */
    async function inject() {
      const headerHtml = await fetch('./header.html', { cache: 'no-cache' }).then(r => r.text());
      document.getElementById('header-placeholder').innerHTML = headerHtml;

      const footerHtml = await fetch('./footer.html', { cache: 'no-cache' }).then(r => r.text());
      document.getElementById('footer-placeholder').innerHTML = footerHtml;

      // Active Dashboard link
      document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
      const dash = document.querySelector('.nav-links a[href="./dashboard.html"], .nav-links a[href="dashboard.html"]');
      if (dash) dash.classList.add('active');

      hookLoginLinks();
    }

    function hookLoginLinks() {
      const links = Array.from(document.querySelectorAll('a'));
      const loginLinks = links.filter(a => {
        const txt = (a.textContent || '').toLowerCase();
        const href = (a.getAttribute('href') || '').toLowerCase();
        return txt.includes('login') || txt.includes('connect') || href.includes('connexion');
      });

      loginLinks.forEach(a => {
        a.addEventListener('click', (e) => {
          const href = (a.getAttribute('href') || '').toLowerCase();
          if (href.includes('inscription')) return;
          e.preventDefault();
          openLogin(false);
        });
      });
    }

    /* Mobile menu helper */
    window.toggleMobileMenu = function () {
      const mobileMenu = document.getElementById('mobileMenu');
      if (!mobileMenu) return;
      mobileMenu.classList.toggle('active');
      document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
    };

    /* --------------------------
       Langue (preferredLanguage + data-fr/data-en)
       -------------------------- */
    function applyLanguage(lang) {
      document.querySelectorAll('[data-' + lang + ']').forEach(el => {
        const txt = el.getAttribute('data-' + lang);
        if (txt) el.innerHTML = txt;
      });
      document.querySelectorAll('.lang-btn').forEach(btn => {
        const l = btn.getAttribute('data-lang');
        btn.classList.toggle('active', l === lang);
      });
    }
    window.switchLanguage = function (lang) {
      localStorage.setItem('preferredLanguage', lang);
      applyLanguage(lang);
    };
    function initLanguage() {
      const lang = localStorage.getItem('preferredLanguage') || 'fr';
      applyLanguage(lang);
    }

    /* --------------------------
       Connexion (email + localStorage)
       -------------------------- */
    function setLoginError(msg) {
      const box = document.getElementById('loginError');
      if (!msg) { box.classList.remove('active'); box.textContent = ''; return; }
      box.textContent = msg;
      box.classList.add('active');
    }

    function openLogin(prefill) {
      setLoginError('');
      const overlay = document.getElementById('loginOverlay');
      overlay.classList.add('active');
      overlay.setAttribute('aria-hidden', 'false');

      const input = document.getElementById('userEmail');
      if (prefill) {
        const saved = localStorage.getItem('kdp_user_email') || '';
        if (saved) input.value = saved;
      }
      input.focus();
    }

    function closeLogin() {
      const overlay = document.getElementById('loginOverlay');
      overlay.classList.remove('active');
      overlay.setAttribute('aria-hidden', 'true');
    }

    function clearEmail() {
      localStorage.removeItem('kdp_user_email');
      document.getElementById('userEmail').value = '';
      setLoginError('');
    }

    async function handleLogin() {
      const email = (document.getElementById('userEmail').value || '').trim();
      if (!email || !email.includes('@')) {
        setLoginError('Email invalide.');
        return;
      }
      localStorage.setItem('kdp_user_email', email);
      closeLogin();
      showDashboard();
      await fetchKDPData();
    }

    function showDashboard() {
      document.getElementById('dashboardSection').style.display = 'block';
    }

    /* --------------------------
       Marketplace parsing (d’après ton ancien code)
       Source: histogram.title === "RoyaltiesDistributionByMarketplace"
       -------------------------- */
    function normalizeMarketplaceFromBin(bin) {
      if (!bin) return null;
      // ex: "Amazon.fr" -> "FR"
      const s = String(bin).trim();
      const m = s.match(/amazon\.([a-z]{2})/i);
      if (m && m[1]) return m[1].toUpperCase();

      // fallback : garde les 2-3 lettres si déjà code
      const up = s.toUpperCase().replace('AMAZON.', '').trim();
      if (/^[A-Z]{2,3}$/.test(up)) return up;

      return null;
    }

    function marketLabel(code) {
      const map = { FR:'France', US:'USA', UK:'UK', GB:'UK', DE:'Germany', ES:'Spain', IT:'Italy', CA:'Canada', AU:'Australia', JP:'Japan', IN:'India', BR:'Brazil', MX:'Mexico', NL:'Netherlands' };
      return map[code] || code;
    }

    function computeTopMarketplaceFromPages(pages) {
      const counts = {}; // code -> score/orders
      const sections = ['dashboard', 'month_current', 'unknown', 'pmr'];

      sections.forEach(sec => {
        const section = pages?.[sec];
        if (!section?.payloads) return;

        Object.values(section.payloads).forEach(item => {
          if (item?.histogram?.title === 'RoyaltiesDistributionByMarketplace' && Array.isArray(item.histogram.data)) {
            item.histogram.data.forEach(entry => {
              const code = normalizeMarketplaceFromBin(entry?.bin);
              if (!code) return;
              const orders = Number(entry?.values?.Orders || 0);
              counts[code] = (counts[code] || 0) + orders;
            });
          }
        });
      });

      // pick max by orders
      let best = null;
      let bestVal = -1;
      Object.entries(counts).forEach(([code, val]) => {
        if (val > bestVal) { best = code; bestVal = val; }
      });

      return best; // ex: "FR"
    }

    /* --------------------------
       ✅ VENTES : lecture kdp_reports + top marketplace
       -------------------------- */
    async function fetchKDPData() {
      const email = localStorage.getItem('kdp_user_email');
      if (!email) { openLogin(false); return; }

      document.getElementById('lastSync').textContent = 'Chargement…';

      const { data, error } = await sb
        .from('kdp_reports')
        .select('*')
        .eq('user_email', email)
        .order('created_at', { ascending: false })
        .limit(1);

      if (error) {
        console.error(error);
        document.getElementById('lastSync').textContent = 'Erreur de chargement (voir console).';
        return;
      }

      if (!data || !data[0]) {
        document.getElementById('lastSync').textContent = "Aucune donnée trouvée pour cet email.";
        document.getElementById('royaltiesAmt').textContent = "0,00 €";
        document.getElementById('ordersAmt').textContent = "0";
        document.getElementById('kenpAmt').textContent = "0";
        document.getElementById('topMarket').textContent = "--";
        return;
      }

      const row = data[0];
      const payload = row.payload;
      const pages = (payload && payload.pages) ? payload.pages : payload;

      // last sync label
      const lang = localStorage.getItem('preferredLanguage') || 'fr';
      const label = (lang === 'fr') ? 'Dernière synchronisation : ' : 'Last sync: ';
      document.getElementById('lastSync').textContent = label + new Date(row.created_at).toLocaleString();

      // totals (comme ton code)
      let r = 0, o = 0, k = 0;
      ['dashboard', 'month_current', 'unknown', 'pmr'].forEach(sec => {
        const section = pages?.[sec];
        if (section && section.payloads) {
          Object.values(section.payloads).forEach(item => {
            if (item.overviewWidget) {
              r = item.overviewWidget.totalRoyalties || r;
              o = (item.overviewWidget.printOrders + item.overviewWidget.digitalOrders) || o;
              k = item.overviewWidget.kenpRead || k;
            }
          });
        }
      });

      document.getElementById('royaltiesAmt').textContent = Number(r).toFixed(2).replace('.', ',') + " €";
      document.getElementById('ordersAmt').textContent = String(Math.floor(o));
      document.getElementById('kenpAmt').textContent = String(Math.floor(k));

      // ✅ Top marketplace (depuis RoyaltiesDistributionByMarketplace)
      const topCode = computeTopMarketplaceFromPages(pages);
      document.getElementById('topMarket').textContent = topCode ? marketLabel(topCode) : "--";
    }

    /* --------------------------
       Init
       -------------------------- */
    document.addEventListener('DOMContentLoaded', async () => {
      await inject();
      initLanguage();

      const saved = localStorage.getItem('kdp_user_email');
      if (saved) {
        showDashboard();
        await fetchKDPData();
      } else {
        openLogin(false);
      }
    });

    // overlay close rules
    document.addEventListener('click', (e) => {
      const overlay = document.getElementById('loginOverlay');
      if (!overlay.classList.contains('active')) return;
      const modal = overlay.querySelector('.modal');
      if (modal && !modal.contains(e.target) && e.target === overlay) closeLogin();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key !== 'Escape') return;
      const overlay = document.getElementById('loginOverlay');
      if (overlay.classList.contains('active')) closeLogin();
    });
  </script>
</body>
</html>
