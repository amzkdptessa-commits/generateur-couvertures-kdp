<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - GabaritKDP Tracker</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{background:#0b1220;color:#e5e7eb;font-family:Segoe UI,Arial,sans-serif}
    .card{background:#111a2e;border:1px solid rgba(255,255,255,.08);border-radius:16px}
    .muted{color:#93a4c7}
  </style>
</head>
<body class="p-6">
  <div class="max-w-7xl mx-auto space-y-4">

    <!-- Bandeau BETA -->
    <div class="card p-4">
      <div class="flex items-start gap-3">
        <div class="text-2xl">üöß</div>
        <div class="flex-1">
          <div class="font-extrabold text-orange-400">Dashboard en phase b√™ta</div>
          <div class="muted mt-1">
            Ce tableau de bord est en cours de construction. Les donn√©es affich√©es sont r√©elles mais peuvent √™tre incompl√®tes ou √©voluer.
            N‚Äôutilise pas encore ces chiffres pour des d√©cisions finales.
          </div>
          <div class="muted mt-2 text-sm">
            ‚ÑπÔ∏è L‚Äôemail affich√© correspond √† ton compte <b>GabaritKDP Tracker</b> (cl√© de tes donn√©es), ce n‚Äôest pas ton identifiant vendeur Amazon KDP.
          </div>
        </div>
        <button id="btnRefresh" class="bg-orange-500 hover:bg-orange-600 text-black font-extrabold px-4 py-2 rounded-xl">
          Actualiser
        </button>
      </div>
    </div>

    <!-- Header -->
    <div class="card p-4 flex flex-wrap items-center justify-between gap-3">
      <div>
        <div class="text-xl font-extrabold text-orange-400">GabaritKDP Tracker</div>
        <div class="muted text-sm" id="lastSync">Derni√®re synchro : --</div>
      </div>
      <div class="muted text-sm">
        Compte Tracker : <span class="font-mono text-white" id="userEmail">--</span>
      </div>
    </div>

    <!-- KPI -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="card p-4">
        <div class="muted text-xs uppercase tracking-widest">Royalties (snapshot)</div>
        <div class="text-4xl font-extrabold text-orange-400 mt-2" id="kpiRoyalties">0.00</div>
        <div class="muted text-sm mt-1" id="kpiCurrency">Devise : --</div>
      </div>

      <div class="card p-4">
        <div class="muted text-xs uppercase tracking-widest">Unit√©s (snapshot)</div>
        <div class="text-4xl font-extrabold mt-2" id="kpiUnits">0</div>
        <div class="muted text-sm mt-1"><span id="kpiPrint">0</span> print ‚Ä¢ <span id="kpiDigital">0</span> digital</div>
      </div>

      <div class="card p-4">
        <div class="muted text-xs uppercase tracking-widest">KENP lus (snapshot)</div>
        <div class="text-4xl font-extrabold mt-2" id="kpiKenp">0</div>
        <div class="muted text-sm mt-1">Pages KENP</div>
      </div>

      <div class="card p-4">
        <div class="muted text-xs uppercase tracking-widest">Statut</div>
        <div class="text-3xl font-extrabold mt-3" id="kpiStatus">OK</div>
        <div class="muted text-sm mt-1" id="kpiHint">Source : kdp_metrics_daily</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card p-4 h-[320px]">
        <div class="font-bold mb-2">30 derniers jours ‚Äî Royalties</div>
        <canvas id="chartRoyalties"></canvas>
      </div>
      <div class="card p-4 h-[320px]">
        <div class="font-bold mb-2">30 derniers jours ‚Äî Unit√©s</div>
        <canvas id="chartUnits"></canvas>
      </div>
    </div>

    <!-- Table -->
    <div class="card p-4">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="font-bold">Derniers enregistrements</div>
        <div class="muted text-sm" id="rowInfo">--</div>
      </div>

      <div class="overflow-auto mt-3">
        <table class="w-full text-left text-sm">
          <thead class="muted text-xs uppercase border-b border-white/10">
            <tr>
              <th class="py-2">Date</th>
              <th class="py-2">Devise</th>
              <th class="py-2">Royalties</th>
              <th class="py-2">KENP</th>
              <th class="py-2">Print</th>
              <th class="py-2">Digital</th>
              <th class="py-2">Source</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    const SUPABASE_URL = "https://kucwdaicplajljpfkzhu.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_HGEXYCHK0H3JzKEluWy2GQ_tdmb8UWg";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const FALLBACK_EMAIL = "peacestreet@hotmail.com";

    let chartR = null;
    let chartU = null;

    function fmtMoney(x){ return Number(x ?? 0).toFixed(2); }
    function fmtInt(x){ return Number(x ?? 0).toLocaleString("fr-FR"); }
    function isoMinusDays(n){
      const d = new Date(Date.now() - (n-1)*86400000);
      return d.toISOString().slice(0,10);
    }

    async function getEmail() {
      try {
        const { data } = await sb.auth.getSession();
        const email = data?.session?.user?.email;
        if (email) return email;
      } catch(_) {}
      const ls = localStorage.getItem("kdp_email");
      if (ls && ls.includes("@")) return ls;
      return FALLBACK_EMAIL;
    }

    async function load() {
      const email = await getEmail();
      document.getElementById("userEmail").textContent = email;

      // Latest snapshot
      const { data: latestRows, error: e1 } = await sb
        .from("kdp_metrics_daily")
        .select("metric_date,currency,royalties,kenp_read,print_orders,digital_orders,created_at,updated_at,source_report_id")
        .eq("user_email", email)
        .order("metric_date", { ascending: false })
        .limit(1);

      if (e1) {
        document.getElementById("kpiStatus").textContent = "Erreur";
        document.getElementById("kpiHint").textContent = e1.message || "Erreur Supabase";
        return;
      }

      const latest = latestRows?.[0] || null;

      if (!latest) {
        document.getElementById("kpiStatus").textContent = "Vide";
        document.getElementById("kpiHint").textContent = "Aucune donn√©e. Lance une synchro.";
        return;
      }

      const units = (latest.print_orders || 0) + (latest.digital_orders || 0);
      document.getElementById("kpiRoyalties").textContent = fmtMoney(latest.royalties);
      document.getElementById("kpiCurrency").textContent = "Devise : " + (latest.currency || "--");
      document.getElementById("kpiKenp").textContent = fmtInt(latest.kenp_read);
      document.getElementById("kpiUnits").textContent = fmtInt(units);
      document.getElementById("kpiPrint").textContent = fmtInt(latest.print_orders);
      document.getElementById("kpiDigital").textContent = fmtInt(latest.digital_orders);

      const dt = new Date(latest.updated_at || latest.created_at || Date.now());
      document.getElementById("lastSync").textContent = "Derni√®re synchro : " + dt.toLocaleString("fr-FR");

      // 30 days series
      const fromDate = isoMinusDays(30);
      const { data: rows, error: e2 } = await sb
        .from("kdp_metrics_daily")
        .select("metric_date,currency,royalties,kenp_read,print_orders,digital_orders,source_report_id")
        .eq("user_email", email)
        .gte("metric_date", fromDate)
        .order("metric_date", { ascending: true });

      if (e2) {
        document.getElementById("kpiStatus").textContent = "Erreur";
        document.getElementById("kpiHint").textContent = e2.message || "Erreur m√©triques";
        return;
      }

      const safeRows = rows || [];
      document.getElementById("rowInfo").textContent = `${safeRows.length} ligne(s) ‚Äî ${fromDate} ‚Üí aujourd'hui`;

      // Table
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";
      safeRows.slice().reverse().forEach(r => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-white/10";
        tr.innerHTML = `
          <td class="py-2">${r.metric_date}</td>
          <td class="py-2 muted">${r.currency || "--"}</td>
          <td class="py-2">${fmtMoney(r.royalties)}</td>
          <td class="py-2">${fmtInt(r.kenp_read)}</td>
          <td class="py-2">${fmtInt(r.print_orders)}</td>
          <td class="py-2">${fmtInt(r.digital_orders)}</td>
          <td class="py-2 muted font-mono text-xs">${String(r.source_report_id || "--").slice(0,8)}‚Ä¶</td>
        `;
        tbody.appendChild(tr);
      });

      // Charts
      const labels = safeRows.map(r => r.metric_date.slice(5));
      const dataR = safeRows.map(r => Number(r.royalties || 0));
      const dataU = safeRows.map(r => Number((r.print_orders || 0) + (r.digital_orders || 0)));

      const opts = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: "#93a4c7" }, grid: { color: "rgba(255,255,255,.06)" } },
          y: { ticks: { color: "#93a4c7" }, grid: { color: "rgba(255,255,255,.06)" } }
        }
      };

      if (chartR) chartR.destroy();
      chartR = new Chart(document.getElementById("chartRoyalties"), {
        type: "line",
        data: { labels: labels.length ? labels : ["--"], datasets: [{ data: dataR.length ? dataR : [0], fill: true, tension: 0.35 }] },
        options: opts
      });

      if (chartU) chartU.destroy();
      chartU = new Chart(document.getElementById("chartUnits"), {
        type: "bar",
        data: { labels: labels.length ? labels : ["--"], datasets: [{ data: dataU.length ? dataU : [0] }] },
        options: opts
      });
    }

    document.getElementById("btnRefresh").addEventListener("click", load);
    load();
  </script>
</body>
</html>
