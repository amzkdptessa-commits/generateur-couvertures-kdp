<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - GabaritKDP Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #121212; color: white; font-family: 'Segoe UI', sans-serif; }
        .stat-card { background: #2d2d2d; padding: 20px; border-radius: 10px; border: 1px solid #3e3e3e; }
        .accent { color: #f97316; }
    </style>
</head>
<body class="p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold accent">üìä Dashboard KDP Tracker</h1>
            <div class="text-right">
                <p class="text-gray-400">Utilisateur : <span id="userDisplay">--</span></p>
                <p class="text-sm text-gray-500" id="lastSync">Derni√®re synchro : Jamais</p>
            </div>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stat-card">
                <h4 class="text-gray-400 text-sm uppercase">Total Synchronisations</h4>
                <div class="text-4xl font-bold accent" id="totalSyncs">0</div>
            </div>
            <div class="stat-card">
                <h4 class="text-gray-400 text-sm uppercase">Statut Serveur</h4>
                <div class="text-xl font-bold text-green-500">Connect√©</div>
            </div>
            <div class="stat-card">
                <!-- Correction ici : appel de la fonction par son nouveau nom -->
                <button onclick="loadDataFromServer()" class="bg-orange-600 hover:bg-orange-700 w-full py-3 rounded-lg font-bold transition">
                    <i class="fas fa-sync-alt mr-2"></i> Actualiser les donn√©es
                </button>
            </div>
        </div>

        <!-- Graphique -->
        <div class="bg-[#2d2d2d] p-6 rounded-lg border border-[#3e3e3e] mb-8">
            <h3 class="mb-4 font-bold">Activit√© des derni√®res synchros</h3>
            <div style="height: 300px;">
                <canvas id="syncChart"></canvas>
            </div>
        </div>

        <!-- Liste des rapports -->
        <div class="bg-[#2d2d2d] p-6 rounded-lg border border-[#3e3e3e]">
            <h3 class="mb-4 font-bold">Historique des donn√©es re√ßues</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b border-gray-700 text-gray-400">
                            <th class="py-2">Date</th>
                            <th>Marketplace</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const SB_URL = 'https://bgcspojhiupcrpzlkwax.supabase.co';
        const SB_KEY = 'COLLE_TA_CLE_ANON_ICI'; // <-- TA CL√â ANON
        const USER_EMAIL = 'peacestreet@hotmail.com';

        // Initialisation du client (nom de variable modifi√© pour √©viter le conflit)
        const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);
        
        let myChart = null;

        // Fonction principale renomm√©e pour √™tre s√ªr
        async function loadDataFromServer() {
            console.log("Tentative de r√©cup√©ration des donn√©es...");
            document.getElementById('userDisplay').textContent = USER_EMAIL;

            try {
                const { data, error } = await supabaseClient
                    .from('kdp_reports')
                    .select('*')
                    .eq('user_email', USER_EMAIL)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Mise √† jour de l'affichage
                document.getElementById('totalSyncs').textContent = data.length;
                
                if (data.length > 0) {
                    const lastDate = new Date(data[0].created_at);
                    document.getElementById('lastSync').textContent = "Derni√®re synchro : " + lastDate.toLocaleString();
                    
                    const tableBody = document.getElementById('reportsTable');
                    tableBody.innerHTML = '';
                    
                    data.forEach(report => {
                        const row = `
                            <tr class="border-b border-gray-800 hover:bg-gray-800">
                                <td class="py-3 text-sm">${new Date(report.created_at).toLocaleString()}</td>
                                <td class="text-orange-400 font-bold">${report.payload?.marketplace || 'US'}</td>
                                <td class="text-gray-400">${report.user_email}</td>
                            </tr>`;
                        tableBody.innerHTML += row;
                    });

                    updateSyncChart(data);
                }
            } catch (err) {
                console.error("Erreur d√©taill√©e:", err);
                alert("Erreur de connexion : " + err.message);
            }
        }

        function updateSyncChart(data) {
            const ctx = document.getElementById('syncChart').getContext('2d');
            const lastData = data.slice(0, 10).reverse();
            const labels = lastData.map(d => new Date(d.created_at).toLocaleTimeString());
            const values = lastData.map((_, i) => i + 1);

            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Historique des envois',
                        data: values,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // Lancement automatique au chargement de la page
        window.onload = loadDataFromServer;
    </script>
</body>
</html>