<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - GabaritKDP Tracker</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tailwind (‚ö†Ô∏è warning OK en beta) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --bg-dark: #121212;
      --card-bg: #2d2d2d;
      --accent-orange: #f97316;
      --text-main: #ffffff;
      --text-dim: #b3b3b3;
      --border: #3e3e3e;
      --danger: #ff4c4c;
      --ok: #4cff4c;
    }

    body{
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      margin: 0;
    }

    .dashboard-container{
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ======= TON HEADER / NAV (inchang√©) ======= */
    .header-nav{background:linear-gradient(135deg,#1e293b 0%,#334155 100%);padding:15px 0;box-shadow:0 4px 20px rgba(0,0,0,.1)}
    .nav-container{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:0 20px;flex-wrap:wrap;gap:0}
    .logo-nav{display:flex;align-items:center;gap:15px;text-decoration:none;color:#fff}
    .logo-nav span{font-size:1.3rem;font-weight:700;color:#FF9900}
    .nav-links{width:100%;display:flex;justify-content:center;align-items:center;gap:25px;flex-wrap:wrap;margin-top:10px}
    .nav-links a{color:#fff;text-decoration:none;font-weight:500;transition:.3s;padding:10px 14px;border-radius:8px;position:relative;display:flex;align-items:center;gap:6px;font-size:.95rem}
    .nav-links a:hover{color:#FF9900;background:rgba(255,153,0,.1)}
    .nav-links a.active{color:#FF9900;background:rgba(255,153,0,.15)}
    .express-nav-btn{background:linear-gradient(135deg,#10b981,#059669)!important;color:#fff!important;border-radius:8px!important;padding:10px 14px!important}
    .express-nav-btn:hover{background:linear-gradient(135deg,#0d9488,#047857)!important;transform:translateY(-2px)!important;box-shadow:0 4px 15px rgba(16,185,129,.4)!important}
    .express-nav-btn::before{content:"‚ö°";margin-right:4px}

    /* Mobile Menu */
    .mobile-menu{display:none;position:fixed;top:0;left:0;width:100%;height:100vh;background:rgba(0,0,0,.95);backdrop-filter:blur(10px);z-index:999;padding:80px 20px 20px;overflow-y:auto}
    .mobile-menu.active{display:block;animation:slideIn .3s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    .mobile-menu-links{display:flex;flex-direction:column;gap:15px;max-width:400px;margin:0 auto}
    .mobile-menu-links a{color:#fff;text-decoration:none;font-weight:600;padding:15px 20px;border-radius:12px;background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);transition:.3s;display:flex;align-items:center;gap:12px;font-size:1.1rem}
    .mobile-menu-links a:hover{background:rgba(255,255,255,.2);transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.3)}
    .mobile-menu-close{position:absolute;top:20px;right:20px;background:none;border:none;color:#fff;font-size:1.8rem;cursor:pointer;padding:8px;border-radius:50%;transition:.3s}
    .mobile-menu-close:hover{background:rgba(255,255,255,.1);transform:rotate(90deg)}
    .mobile-menu-toggle{display:none;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;padding:8px;border-radius:4px;margin-left:auto}
    .mobile-menu-toggle:hover{background:rgba(255,255,255,.1)}
    @media (max-width:768px){
      .nav-links{display:none}
      .mobile-menu-toggle{display:block}
    }

    /* Language Toggle Switch (inchang√©) */
    .language-selector {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: #fff;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0,0,0,.1);
      padding: 4px;
      display: flex;
      gap: 0;
    }
    .lang-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      border-radius: 50px;
      cursor: pointer;
      transition: all .3s;
      font-weight: 600;
      font-size: .85rem;
      color: #64748b;
      min-width: 45px;
    }
    .lang-btn.active {
      background: #FF9900;
      color: #fff;
      box-shadow: 0 2px 8px rgba(255, 153, 0, 0.3);
    }
    .lang-btn:hover:not(.active) { color: #334155; }

    /* ======= Dashboard UI (nouveau, bas√© sur tes KPI) ======= */
    .loading { display:none; text-align:center; padding:40px; }
    .loading.active { display:block; }

    .beta-box{
      background: rgba(249,115,22,0.08);
      border: 1px solid var(--accent-orange);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 18px;
    }
    .beta-title{font-weight:800;color:var(--accent-orange);margin:0 0 6px 0}
    .beta-text{color:var(--text-dim);margin:0;line-height:1.5}

    .extension-banner {
      background: rgba(249, 115, 22, 0.05);
      border: 1px solid var(--accent-orange);
      border-radius: 8px;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn-sync {
      background: var(--accent-orange);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      white-space: nowrap;
    }
    .btn-sync:hover { background:#ea580c; }

    .email-box{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .email-box input{
      background:#1a1a1a;border:1px solid var(--border);color:#fff;
      padding:10px 12px;border-radius:8px;min-width:260px;
    }
    .tag{font-size:.9rem;color:var(--text-dim)}

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .stat-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    .stat-card h4 {
      margin: 0;
      font-size: 0.75rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .stat-card .value {
      font-size: 1.8rem;
      font-weight: bold;
      margin-top: 10px;
      color: var(--accent-orange);
    }
    .stat-card .sub{
      margin-top: 8px;
      color: var(--text-dim);
      font-size: .9rem;
    }

    .charts-row {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 15px;
      margin-bottom: 25px;
    }
    .chart-container {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--border);
      height: 320px;
    }
    @media (max-width: 900px){
      .charts-row{grid-template-columns:1fr;}
      .chart-container{height:300px;}
    }

    .table-box{
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
    }
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    th{color:var(--text-dim);font-size:.75rem;text-transform:uppercase;letter-spacing:.08em}
    td{color:#e5e7eb;font-size:.95rem}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.85rem;color:var(--text-dim)}
    .error{color:var(--danger);font-weight:800}
    .ok{color:var(--ok);font-weight:800}
  </style>
</head>

<body>

  <!-- Navigation Header (TON header) -->
  <header class="header-nav">
    <div class="nav-container">
      <a href="./index.html" class="logo-nav">
        <img src="logo-gabarit-kdp-site-web.png" alt="GabaritKDP Logo" style="height: 32px;">
        <span>GabaritKDP</span>
      </a>

      <!-- Menu Hamburger - Mobile -->
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Open menu">
        <i class="fas fa-bars"></i>
      </button>

      <!-- Navigation Desktop -->
      <nav class="nav-links">
        <a href="./index.html">üè† Home</a>
        <a href="./dashboard.html" class="active">üìä Dashboard</a>
        <a href="./generator.html" class="express-nav-btn">Express Generator</a>
        <a href="./generator-magic.html">Magic Generator</a>
        <a href="./marketplace.html">Marketplace</a>
        <a href="./inscription.html">üìù Sign Up</a>
        <a href="./connexion.html">üîì Login</a>
      </nav>
    </div>
  </header>

  <!-- Menu Mobile -->
  <div class="mobile-menu" id="mobileMenu">
    <button class="mobile-menu-close" onclick="toggleMobileMenu()" aria-label="Close menu"><i class="fas fa-times"></i></button>
    <div class="mobile-menu-links">
      <a href="./index.html">üè† Home</a>
      <a href="./dashboard.html">üìä Dashboard</a>
      <a href="./generator.html" style="background:linear-gradient(135deg,#10b981,#059669);border-color:#10b981;">‚ö° Express Generator</a>
      <a href="./generator-magic.html">Magic Generator</a>
      <a href="./marketplace.html">Marketplace</a>
      <a href="./inscription.html" style="background:rgba(34,197,94,.2);border-color:#22c55e;">üìù Sign Up</a>
      <a href="./connexion.html">üîì Login</a>
    </div>
  </div>

  <!-- Language Switcher (TON switch) -->
  <div class="language-selector">
    <button class="lang-btn active" onclick="switchLanguage('en')" id="btn-en">EN</button>
    <button class="lang-btn" onclick="switchLanguage('fr')" id="btn-fr">FR</button>
  </div>

  <!-- Dashboard Content -->
  <div class="dashboard-container">

    <div class="loading active" id="loadingState">
      <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--accent-orange);"></i>
      <p style="margin-top: 20px; color: var(--text-dim);" data-en="Loading your dashboard..." data-fr="Chargement de ton dashboard...">Loading your dashboard...</p>
    </div>

    <div id="dashboardContent" style="display:none;">

      <!-- BETA banner -->
      <div class="beta-box">
        <h3 class="beta-title" data-en="üöß Beta ‚Äî Under Construction" data-fr="üöß B√™ta ‚Äî En cours de construction">üöß Beta ‚Äî Under Construction</h3>
        <p class="beta-text" data-en="This dashboard is in beta. Data is real but may be incomplete or change. Do not use for final decisions yet."
           data-fr="Ce dashboard est en b√™ta. Les donn√©es sont r√©elles mais peuvent √™tre incompl√®tes ou √©voluer. Ne l‚Äôutilise pas encore pour des d√©cisions finales.">
          This dashboard is in beta. Data is real but may be incomplete or change. Do not use for final decisions yet.
        </p>
        <p class="beta-text" style="margin-top:10px"
           data-en="‚ÑπÔ∏è The email shown is your Tracker account key (used to load your data). It is NOT your Amazon KDP seller ID."
           data-fr="‚ÑπÔ∏è L‚Äôemail affich√© correspond √† ton compte Tracker (cl√© pour charger tes donn√©es). Ce n‚Äôest PAS ton identifiant vendeur KDP.">
          ‚ÑπÔ∏è The email shown is your Tracker account key (used to load your data). It is NOT your Amazon KDP seller ID.
        </p>
        <p class="beta-text" style="margin-top:10px">
          <span id="statusLine" class="ok">OK</span>
          <span class="beta-text"> ‚Ä¢ </span>
          <span id="lastSync" class="beta-text" data-en="Last sync: --" data-fr="Derni√®re synchro : --">Last sync: --</span>
        </p>
      </div>

      <!-- Extension banner + email selector -->
      <div class="extension-banner">
        <div>
          <strong data-en="GabaritKDP Tracker Connected" data-fr="GabaritKDP Tracker connect√©">GabaritKDP Tracker Connected</strong><br>
          <small style="color: var(--text-dim);" id="subSync"
                 data-en="Source: kdp_metrics_daily" data-fr="Source : kdp_metrics_daily">Source: kdp_metrics_daily</small>
        </div>

        <div class="email-box">
          <span class="tag" data-en="Tracker email:" data-fr="Email Tracker :">Tracker email:</span>
          <input id="emailInput" type="email" placeholder="peacestreet@hotmail.com">
          <button class="btn-sync" id="btnSaveEmail" type="button" data-en="SAVE" data-fr="ENREGISTRER">SAVE</button>
          <button class="btn-sync" id="btnRefresh" type="button">
            <i class="fas fa-sync"></i> <span data-en="REFRESH" data-fr="ACTUALISER">REFRESH</span>
          </button>
        </div>
      </div>

      <div id="apiError" style="display:none;margin-bottom:18px;">
        <span class="error">‚ùå</span>
        <span id="apiErrorText" class="error"></span>
      </div>

      <!-- KPI cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <h4 data-en="Royalties (snapshot)" data-fr="Royalties (snapshot)">Royalties (snapshot)</h4>
          <div class="value" id="kpiRoyalties">0.00</div>
          <div class="sub" id="kpiCurrency">--</div>
        </div>

        <div class="stat-card">
          <h4 data-en="Units (snapshot)" data-fr="Unit√©s (snapshot)">Units (snapshot)</h4>
          <div class="value" id="kpiUnits">0</div>
          <div class="sub"><span id="kpiPrint">0</span> print ‚Ä¢ <span id="kpiDigital">0</span> digital</div>
        </div>

        <div class="stat-card">
          <h4 data-en="KENP read (snapshot)" data-fr="KENP lus (snapshot)">KENP read (snapshot)</h4>
          <div class="value" id="kpiKenp">0</div>
          <div class="sub" data-en="KENP pages" data-fr="Pages KENP">KENP pages</div>
        </div>

        <div class="stat-card">
          <h4 data-en="Status" data-fr="Statut">Status</h4>
          <div class="value" id="kpiStatus">OK</div>
          <div class="sub" id="kpiHint" data-en="Reading kdp_metrics_daily" data-fr="Lecture de kdp_metrics_daily">Reading kdp_metrics_daily</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-row">
        <div class="chart-container">
          <h3 style="margin:0 0 10px 0; font-size:0.9rem;">
            <i class="fas fa-chart-line"></i>
            <span data-en="30 days ‚Äî Royalties" data-fr="30 jours ‚Äî Royalties">30 days ‚Äî Royalties</span>
          </h3>
          <canvas id="revenueChart"></canvas>
        </div>

        <div class="chart-container">
          <h3 style="margin:0 0 10px 0; font-size:0.9rem;">
            <i class="fas fa-chart-bar"></i>
            <span data-en="30 days ‚Äî Units" data-fr="30 jours ‚Äî Unit√©s">30 days ‚Äî Units</span>
          </h3>
          <canvas id="unitsChart"></canvas>
        </div>
      </div>

      <!-- Table -->
      <div class="table-box">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
          <strong data-en="Latest records" data-fr="Derniers enregistrements">Latest records</strong>
          <small id="rowInfo" class="mono">--</small>
        </div>

        <table>
          <thead>
            <tr>
              <th data-en="Date" data-fr="Date">Date</th>
              <th data-en="Currency" data-fr="Devise">Currency</th>
              <th data-en="Royalties" data-fr="Royalties">Royalties</th>
              <th data-en="KENP" data-fr="KENP">KENP</th>
              <th data-en="Print" data-fr="Print">Print</th>
              <th data-en="Digital" data-fr="Digital">Digital</th>
              <th data-en="Source" data-fr="Source">Source</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <p class="beta-text" style="margin-top:10px"
           data-en="Note: a 0 day can simply mean ‚Äúno sales‚Äù at the time of the run."
           data-fr="Note : une journ√©e √† 0 peut simplement signifier ‚Äúaucune vente‚Äù au moment du run.">
          Note: a 0 day can simply mean ‚Äúno sales‚Äù at the time of the run.
        </p>
      </div>

      <!-- CTA footer (ton bloc CTA, inchang√©) -->
      <div class="cta-footer" style="text-align: center; padding: 40px; border: 1px dashed var(--accent-orange); border-radius: 15px; background: #1a1a1a; margin-top: 20px;">
        <h3 data-en="Go to marketplace and create your next book" data-fr="Va sur la marketplace et cr√©e ton prochain livre">Go to marketplace and create your next book</h3>
        <a href="https://gabaritkdp.com/marketplace.html" class="btn-marketplace" style="background: #2563eb; color: white; padding: 15px 40px; border-radius: 30px; text-decoration: none; font-weight: bold; display: inline-block; margin-top: 15px; transition: 0.3s;">
          <span data-en="ACCESS MARKETPLACE" data-fr="ACC√âDER √Ä LA MARKETPLACE">ACCESS MARKETPLACE</span> <i class="fas fa-rocket"></i>
        </a>
      </div>

    </div>
  </div>

  <!-- FOOTER (TON footer exact) -->
  <footer class="bg-gray-900 text-gray-300 py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="social-section">
        <h4 class="text-white font-semibold mb-4 text-center" data-fr="üöÄ Suivez-nous pour les derni√®res actualit√©s KDP !" data-en="üöÄ Follow us for the latest KDP news!">üöÄ Suivez-nous pour les derni√®res actualit√©s KDP !</h4>
        <div class="social-links">
          <a href="https://www.youtube.com/@Gabaritkdp" class="social-link youtube" title="YouTube - Tutoriels KDP" target="_blank" rel="noopener noreferrer"><i class="fab fa-youtube"></i></a>
          <a href="https://www.facebook.com/profile.php?id=61578785408904" class="social-link facebook" title="Facebook - Communaut√© auteurs" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook-f"></i></a>
          <a href="https://www.instagram.com/gabaritkdp/" class="social-link instagram" title="Instagram - Inspirations couvertures" target="_blank" rel="noopener noreferrer"><i class="fab fa-instagram"></i></a>
          <a href="https://fr.pinterest.com/Gabaritkdp/" class="social-link pinterest" title="Pinterest - Designs couvertures" target="_blank" rel="noopener noreferrer"><i class="fab fa-pinterest-p"></i></a>
          <a href="https://www.tiktok.com/@gabaritkdp" class="social-link tiktok" title="TikTok - Tips rapides KDP" target="_blank" rel="noopener noreferrer"><i class="fab fa-tiktok"></i></a>
          <a href="https://www.linkedin.com/in/gabarit-kdp-073368378/" class="social-link linkedin" title="LinkedIn - Publishers & Agences" target="_blank" rel="noopener noreferrer"><i class="fab fa-linkedin-in"></i></a>
        </div>
        <p class="text-center text-sm text-gray-400 mt-4" data-fr="Astuces KDP ‚Ä¢ Tutoriels ‚Ä¢ Actualit√©s ‚Ä¢ Communaut√© d'auteurs" data-en="KDP Tips ‚Ä¢ Tutorials ‚Ä¢ News ‚Ä¢ Authors Community">Astuces KDP ‚Ä¢ Tutoriels ‚Ä¢ Actualit√©s ‚Ä¢ Communaut√© d'auteurs</p>
      </div>

      <div class="grid md:grid-cols-4 gap-8">
        <div>
          <div class="flex items-center mb-4">
            <img src="logo-gabarit-kdp-site-web.png" alt="GabaritKDP" class="h-8 w-auto">
            <span class="ml-2 text-white font-bold">GabaritKDP</span>
          </div>
          <p class="text-gray-400" data-fr="Le g√©n√©rateur de couvertures KDP 100% conformes Amazon." data-en="The 100% Amazon-compliant KDP cover generator.">The 100% Amazon-compliant KDP cover generator.</p>
        </div>

        <div>
          <h4 class="text-white font-semibold mb-4" data-fr="Produit" data-en="Product">Produit</h4>
          <ul class="space-y-2">
            <li style="margin-bottom: 10px;"><a href="generator.html" class="hover:text-white transition f-exp-gene" data-fr="G√©n√©rateur Express" data-en="Express Generator">G√©n√©rateur Express</a></li>
            <li><a href="generator-magic.html" class="hover:text-white transition" data-fr="G√©n√©rateur Magique" data-en="Magic Generator">G√©n√©rateur Magique</a></li>
            <li><a href="./marketplace.html"  class="hover:text-white transition">Marketplace</a></li>
            <li><a href="#tarifs" class="hover:text-white transition" data-fr="Tarifs" data-en="Pricing">Tarifs</a></li>
            <li><a href="fonctionnalites.html" class="hover:text-white transition" data-fr="Fonctionnalit√©s" data-en="Features">Fonctionnalit√©s</a></li>
          </ul>
        </div>

        <div>
          <h4 class="text-white font-semibold mb-4">Support</h4>
          <ul class="space-y-2">
            <li><a href="api-pro.html" class="hover:text-white transition">API</a></li>
            <li><a href="faq.html" class="hover:text-white transition">FAQ</a></li>
            <li><a href="contact.html" class="hover:text-white transition">Contact</a></li>
            <li><a href="guide.html" class="hover:text-white transition" data-fr="Guide utilisateur" data-en="User Guide">Guide utilisateur</a></li>
            <li><a href="updates.html" class="hover:text-white transition" data-fr="Mises √† jour / Nouveaut√©s" data-en="Updates / What's New">Mises √† jour / Nouveaut√©s</a></li>
          </ul>
        </div>

        <div>
          <h4 class="text-white font-semibold mb-4" data-fr="L√©gal" data-en="Legal">L√©gal</h4>
          <ul class="space-y-2">
            <li><a href="mentions-legales.html" class="hover:text-white transition" data-fr="Mentions l√©gales" data-en="Legal Notice">L√©gal Notice</a></li>
            <li><a href="cgu.html" class="hover:text-white transition" data-fr="Conditions d'utilisation" data-en="Terms of Use">Conditions d'utilisation</a></li>
            <li><a href="confidentialite.html" class="hover:text-white transition" data-fr="Politique de confidentialit√©" data-en="Privacy Policy">Privacy Policy</a></li>
          </ul>
        </div>
      </div>

      <div class="border-t border-gray-800 mt-8 pt-8 text-center">
        <p data-fr="&copy; 2025 GabaritKDP. Tous droits r√©serv√©s." data-en="&copy; 2025 GabaritKDP. All rights reserved.">&copy; 2025 GabaritKDP. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    // ======================
    // Mobile menu (TON code)
    // ======================
    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenu');
      if (!mobileMenu) return;
      mobileMenu.classList.toggle('active');
      document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
    }
    document.addEventListener('click', (e) => {
      const mobileMenu = document.getElementById('mobileMenu');
      if (!mobileMenu || !mobileMenu.classList.contains('active')) return;
      const target = e.target.closest('a');
      if (target && target.closest('#mobileMenu')) toggleMobileMenu();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key !== 'Escape') return;
      const mobileMenu = document.getElementById('mobileMenu');
      if (mobileMenu && mobileMenu.classList.contains('active')) toggleMobileMenu();
    });

    // ======================
    // Language switch (TON logique, mais sans reload forc√©)
    // ======================
    function applyLanguage(lang){
      // Active buttons
      document.getElementById('btn-en').classList.toggle('active', lang === 'en');
      document.getElementById('btn-fr').classList.toggle('active', lang === 'fr');

      // Switch texts via data-en/data-fr
      document.querySelectorAll('[data-en][data-fr]').forEach(el=>{
        el.textContent = (lang === 'fr') ? el.getAttribute('data-fr') : el.getAttribute('data-en');
      });
    }
    function switchLanguage(lang){
      localStorage.setItem('language', lang);
      applyLanguage(lang);
    }

    // ======================
    // Supabase + Dashboard logic
    // ======================

    // ‚ö†Ô∏è Mets ici le projet Supabase qui contient kdp_metrics_daily
    const SUPABASE_URL = 'https://kucwdaicplajljpfkzhu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJnY3Nwb2poaXVwY3Jwemxrd2F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3Nzc1NjUsImV4cCI6MjA4MDM1MzU2NX0.8-kcGquwHwv8BCFYZtWu1Op7TLMIfWjXghES2IwJl7Q';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let revenueChart = null;
    let unitsChart = null;

    const DEFAULT_EMAIL = "peacestreet@hotmail.com";

    function getTrackerEmail(){
      return localStorage.getItem('kdp_email') || DEFAULT_EMAIL;
    }

    function setError(msg){
      document.getElementById('apiError').style.display = 'block';
      document.getElementById('apiErrorText').textContent = msg;
      document.getElementById('statusLine').textContent = 'ERROR';
      document.getElementById('statusLine').className = 'error';
      document.getElementById('kpiStatus').textContent = 'ERROR';
      document.getElementById('kpiHint').textContent = msg;
    }
    function clearError(){
      document.getElementById('apiError').style.display = 'none';
      document.getElementById('apiErrorText').textContent = '';
      document.getElementById('statusLine').textContent = 'OK';
      document.getElementById('statusLine').className = 'ok';
    }

    function fmtMoney(n){ return Number(n ?? 0).toFixed(2); }
    function fmtInt(n){ return Number(n ?? 0).toLocaleString('fr-FR'); }

    function isoMinusDays(n){
      const d = new Date(Date.now() - (n-1)*86400000);
      return d.toISOString().slice(0,10);
    }

    async function loadDashboard(){
      clearError();

      const email = getTrackerEmail();
      document.getElementById('emailInput').value = email;

      // Latest
      const { data: latestRows, error: e1 } = await supabaseClient
        .from('kdp_metrics_daily')
        .select('metric_date,currency,royalties,kenp_read,print_orders,digital_orders,created_at,updated_at,source_report_id')
        .eq('user_email', email)
        .order('metric_date', { ascending: false })
        .limit(1);

      if (e1) {
        // 404 ici = mauvais projet Supabase / table inexistante sur CE projet
        setError(`Supabase error: ${e1.message || e1}`);
        document.getElementById('loadingState').classList.remove('active');
        document.getElementById('dashboardContent').style.display = 'block';
        return;
      }

      const latest = latestRows?.[0] || null;
      if (!latest){
        document.getElementById('kpiStatus').textContent = 'EMPTY';
        document.getElementById('kpiHint').textContent = 'No data yet. Run a sync.';
        document.getElementById('lastSync').textContent = 'Last sync: Never';
        document.getElementById('loadingState').classList.remove('active');
        document.getElementById('dashboardContent').style.display = 'block';
        return;
      }

      const units = (latest.print_orders || 0) + (latest.digital_orders || 0);

      document.getElementById('kpiRoyalties').textContent = fmtMoney(latest.royalties);
      document.getElementById('kpiCurrency').textContent = `Currency: ${latest.currency || '--'}`;
      document.getElementById('kpiKenp').textContent = fmtInt(latest.kenp_read);
      document.getElementById('kpiUnits').textContent = fmtInt(units);
      document.getElementById('kpiPrint').textContent = fmtInt(latest.print_orders);
      document.getElementById('kpiDigital').textContent = fmtInt(latest.digital_orders);

      document.getElementById('kpiStatus').textContent = 'OK';
      document.getElementById('kpiHint').textContent = 'Reading kdp_metrics_daily';

      const dt = new Date(latest.updated_at || latest.created_at || Date.now());
      document.getElementById('lastSync').textContent = `Last sync: ${dt.toLocaleString()}`;

      // Series 30 days
      const fromDate = isoMinusDays(30);
      const { data: rows, error: e2 } = await supabaseClient
        .from('kdp_metrics_daily')
        .select('metric_date,currency,royalties,kenp_read,print_orders,digital_orders,source_report_id')
        .eq('user_email', email)
        .gte('metric_date', fromDate)
        .order('metric_date', { ascending: true });

      if (e2){
        setError(`Supabase error: ${e2.message || e2}`);
        document.getElementById('loadingState').classList.remove('active');
        document.getElementById('dashboardContent').style.display = 'block';
        return;
      }

      const safeRows = rows || [];
      document.getElementById('rowInfo').textContent = `${safeRows.length} rows ‚Äî ${fromDate} ‚Üí today`;

      // Table
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      safeRows.slice().reverse().forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.metric_date}</td>
          <td>${r.currency || '--'}</td>
          <td>${fmtMoney(r.royalties)}</td>
          <td>${fmtInt(r.kenp_read)}</td>
          <td>${fmtInt(r.print_orders)}</td>
          <td>${fmtInt(r.digital_orders)}</td>
          <td class="mono">${String(r.source_report_id || '--').slice(0,8)}‚Ä¶</td>
        `;
        tbody.appendChild(tr);
      });

      // Charts
      const labels = safeRows.map(r=>r.metric_date.slice(5));
      const revenueData = safeRows.map(r=>Number(r.royalties || 0));
      const unitsData = safeRows.map(r=>Number((r.print_orders||0)+(r.digital_orders||0)));

      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: "#cbd5e1" }, grid: { color: "rgba(255,255,255,.06)" } },
          y: { ticks: { color: "#cbd5e1" }, grid: { color: "rgba(255,255,255,.06)" } }
        }
      };

      if (revenueChart) revenueChart.destroy();
      revenueChart = new Chart(document.getElementById('revenueChart'), {
        type:'line',
        data:{ labels: labels.length ? labels : ['--'], datasets:[{ data: revenueData.length ? revenueData : [0], borderColor:'#f97316', backgroundColor:'rgba(249,115,22,.15)', fill:true, tension:0.35 }] },
        options: commonOptions
      });

      if (unitsChart) unitsChart.destroy();
      unitsChart = new Chart(document.getElementById('unitsChart'), {
        type:'bar',
        data:{ labels: labels.length ? labels : ['--'], datasets:[{ data: unitsData.length ? unitsData : [0], backgroundColor:'rgba(37,99,235,.65)' }] },
        options: commonOptions
      });

      document.getElementById('loadingState').classList.remove('active');
      document.getElementById('dashboardContent').style.display = 'block';

      // Apply language after load (ensures texts are switched)
      applyLanguage(localStorage.getItem('language') || 'en');
    }

    // Events
    document.getElementById('btnRefresh').addEventListener('click', loadDashboard);
    document.getElementById('btnSaveEmail').addEventListener('click', ()=>{
      const v = document.getElementById('emailInput').value.trim();
      if (!v || !v.includes('@')) {
        setError('Invalid email. Example: peacestreet@hotmail.com');
        return;
      }
      localStorage.setItem('kdp_email', v);
      loadDashboard();
    });

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      const lang = localStorage.getItem('language') || 'en';
      applyLanguage(lang);

      // prefill
      document.getElementById('emailInput').value = getTrackerEmail();

      loadDashboard();
    });
  </script>
</body>
</html>
