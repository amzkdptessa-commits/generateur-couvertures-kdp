<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GabaritKDP Tracker ‚Äì Dashboard</title>

  <!-- Cette ligne supprime l'erreur rouge "404 Favicon" dans la console -->
  <link rel="icon" href="data:,">

  <!-- Supabase + Tailwind -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; }
    .kpi-card { background: #1e293b; border: 1px solid #334155; transition: transform 0.2s; }
    .kpi-card:hover { transform: translateY(-5px); border-color: #f97316; }
    .panel { background: rgba(249,115,22,0.08); border: 1px solid rgba(249,115,22,0.55); }
    .footer-card { background:#0b1220; border-top: 1px solid rgba(148,163,184,.15); }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- ===== HEADER (ajout) ===== -->
  <header class="bg-slate-900 border-b border-slate-800">
    <div class="max-w-6xl mx-auto px-6 py-5 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <!-- Si tu as un logo sur la page, tu peux d√©commenter -->
        <!-- <img src="logo-gabarit-kdp-site-web.png" alt="GabaritKDP" class="h-8"> -->
        <div>
          <div class="text-orange-500 font-black text-xl tracking-tight">GabaritKDP</div>
          <div class="text-slate-400 text-xs">Tracker ‚Ä¢ Dashboard (B√™ta)</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <a
          href="https://chromewebstore.google.com/detail/gabaritkdp-tracker/mbngmlkggdapbbncgoijjcbmbcgeomip?hl=fr&utm_source=ext_sidebar"
          target="_blank"
          rel="noopener noreferrer"
          class="bg-orange-600 hover:bg-orange-500 transition px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-widest"
        >
          Installer l‚Äôextension
        </a>

        <button
          onclick="fetchKDPData()"
          class="bg-slate-800 hover:bg-slate-700 transition px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-widest"
        >
          Actualiser
        </button>
      </div>
    </div>
  </header>

  <!-- ===== BETA STRIP (ajout) ===== -->
  <div class="text-center text-xs font-bold py-2 bg-gradient-to-r from-orange-500 to-amber-400 text-slate-900">
    ‚ö†Ô∏è Version B√äTA ‚Äî Les donn√©es affich√©es sont r√©elles mais peuvent √™tre incompl√®tes.
  </div>

  <main class="flex-1 p-6 md:p-12">
    <div class="max-w-6xl mx-auto space-y-10">

      <!-- ===== HOW TO (ajout) ===== -->
      <section class="panel rounded-2xl p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 class="text-lg font-black text-orange-400">Marche √† suivre</h2>
            <p class="text-slate-200 text-sm mt-1">
              Pour voir vos ventes ici, installez l‚Äôextension puis synchronisez depuis Amazon KDP Reports.
            </p>
          </div>
          <a
            href="https://chromewebstore.google.com/detail/gabaritkdp-tracker/mbngmlkggdapbbncgoijjcbmbcgeomip?hl=fr&utm_source=ext_sidebar"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center justify-center bg-orange-600 hover:bg-orange-500 transition px-5 py-3 rounded-xl font-extrabold text-sm"
          >
            ‚¨á Installer GabaritKDP Tracker
          </a>
        </div>

        <ol class="list-decimal list-inside text-slate-200 text-sm mt-4 space-y-2">
          <li>Installez l‚Äôextension Chrome <strong>GabaritKDP Tracker</strong>.</li>
          <li>Connectez-vous √† <strong>kdpreports.amazon.com</strong> avec votre compte Amazon KDP.</li>
          <li>Cliquez sur l‚Äôic√¥ne de l‚Äôextension dans Chrome, puis lancez la synchronisation.</li>
          <li>Revenez ici : vos KPIs (royalties, commandes, KENP) se mettent √† jour.</li>
        </ol>

        <p class="text-slate-300 text-xs mt-4">
          üîí RGPD : l‚Äôextension collecte uniquement les donn√©es visibles lorsque vous √™tes connect√© √† Amazon KDP.
          Vous pouvez d√©sactiver/d√©sinstaller l‚Äôextension √† tout moment.
        </p>
      </section>

      <!-- ===== Dashboard header original (conserv√©) ===== -->
      <header class="flex justify-between items-center mb-2">
        <div>
          <h1 class="text-4xl font-black text-orange-500 tracking-tighter italic">
            KDP <span class="text-white not-italic">Analytics</span>
          </h1>
          <p id="lastSync" class="text-slate-500 text-sm mt-2 font-mono italic">Mise √† jour en cours...</p>
          <p id="statusLine" class="text-slate-500 text-xs mt-1"></p>
        </div>
      </header>

      <!-- KPI CARDS (conserv√©) -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="kpi-card p-8 rounded-[2rem] shadow-2xl">
          <p class="text-slate-400 text-xs uppercase font-black tracking-widest">Royalties Estim√©es</p>
          <div class="flex items-baseline gap-2 mt-4">
            <p id="royaltiesAmt" class="text-6xl font-black text-orange-500">0.00</p>
            <span class="text-2xl font-bold text-orange-400">‚Ç¨</span>
          </div>
        </div>

        <div class="kpi-card p-8 rounded-[2rem] shadow-2xl">
          <p class="text-slate-400 text-xs uppercase font-black tracking-widest">Commandes Totales</p>
          <p id="ordersAmt" class="text-7xl font-black text-white mt-4">0</p>
          <p class="text-slate-500 text-xs mt-4 italic font-medium">Ventes du mois</p>
        </div>

        <div class="kpi-card p-8 rounded-[2rem] shadow-2xl">
          <p class="text-slate-400 text-xs uppercase font-black tracking-widest">Pages Lues (KENP)</p>
          <p id="kenpAmt" class="text-7xl font-black text-blue-400 mt-4">0</p>
          <p class="text-slate-500 text-xs mt-4 italic font-medium">Lectures Kindle</p>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== FOOTER (ajout) ===== -->
  <footer class="footer-card mt-10">
    <div class="max-w-6xl mx-auto px-6 py-8 text-slate-400 text-xs space-y-2">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <span class="text-white font-bold">GabaritKDP Tracker</span> ‚Äî Dashboard (B√™ta)
        </div>
        <div class="flex gap-4">
          <a class="hover:text-white" target="_blank" rel="noopener noreferrer"
             href="https://chromewebstore.google.com/detail/gabaritkdp-tracker/mbngmlkggdapbbncgoijjcbmbcgeomip?hl=fr&utm_source=ext_sidebar">
            Extension Chrome
          </a>
          <a class="hover:text-white" target="_blank" rel="noopener noreferrer"
             href="https://chromewebstore.google.com/search/GabaritKDP%20Tracker?hl=fr&utm_source=ext_sidebar">
            Rechercher sur le Store
          </a>
        </div>
      </div>
      <div>
        ¬© 2026 ‚Äî GabaritKDP. Donn√©es techniques uniquement. Respect RGPD.
      </div>
    </div>
  </footer>

  <script>
    // === CONFIG (identique √† ta version qui marche) ===
    const SB_URL = 'https://bgcspojhiupcrpzlkwax.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJnY3Nwb2poaXVwY3Jwemxrd2F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3Nzc1NjUsImV4cCI6MjA4MDM1MzU2NX0.8-kcGquwHwv8BCFYZtWu1Op7TLMIfWjXghES2IwJl7Q';

    const sb = supabase.createClient(SB_URL, SB_KEY);

    function clean(val) {
      if (!val) return 0;
      if (typeof val === 'number') return val;
      let s = val.toString().replace(/[‚Ç¨$*]/g, '').replace(/\s/g, '').replace(',', '.').trim();
      let n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    async function fetchKDPData() {
      const email = 'peacestreet@hotmail.com';

      const { data, error } = await sb
        .from('kdp_reports')
        .select('*')
        .eq('user_email', email)
        .order('created_at', { ascending: false })
        .limit(1);

      // Status line (diagnostic utile)
      const statusEl = document.getElementById('statusLine');
      if (error) {
        statusEl.textContent = "Erreur lecture donn√©es: " + (error.message || JSON.stringify(error));
        statusEl.className = "text-red-300 text-xs mt-1";
        return;
      } else {
        statusEl.textContent = "";
      }

      if (data && data[0]) {
        const report = data[0];
        const payload = report.payload;
        const pages = payload.pages || payload;

        document.getElementById('lastSync').innerText =
          `Derni√®re synchro : ${new Date(report.created_at).toLocaleString()}`;

        let r = 0, o = 0, k = 0;

        // EXACTEMENT ta logique stable
        ['dashboard', 'month_current', 'unknown', 'pmr'].forEach(sec => {
          const section = pages[sec];
          if (section && section.payloads) {
            Object.values(section.payloads).forEach(item => {
              if (item.overviewWidget) {
                r = item.overviewWidget.totalRoyalties || r;
                o = (item.overviewWidget.printOrders + item.overviewWidget.digitalOrders) || o;
                k = item.overviewWidget.kenpRead || k;
              }
            });
          }
        });

        document.getElementById('royaltiesAmt').innerText = clean(r).toFixed(2);
        document.getElementById('ordersAmt').innerText = Math.floor(clean(o));
        document.getElementById('kenpAmt').innerText = Math.floor(clean(k));
      }
    }

    fetchKDPData();
    setInterval(fetchKDPData, 300000);
  </script>
</body>
</html>
