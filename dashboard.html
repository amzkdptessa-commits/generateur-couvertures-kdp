<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - GabaritKDP Tracker</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#121212;
      --card:#2d2d2d;
      --accent:#f97316;
      --text:#fff;
      --dim:#b3b3b3;
      --border:#3e3e3e;
    }
    body{margin:0;font-family:Segoe UI,sans-serif;background:var(--bg);color:var(--text);}
    .header-nav{background:linear-gradient(135deg,#1e293b 0%,#334155 100%);padding:15px 0;box-shadow:0 4px 20px rgba(0,0,0,.1)}
    .nav-container{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:0 20px;flex-wrap:wrap}
    .logo-nav{display:flex;align-items:center;gap:15px;text-decoration:none;color:#fff}
    .logo-nav span{font-size:1.3rem;font-weight:700;color:#FF9900}
    .nav-links{display:flex;justify-content:center;align-items:center;gap:25px;flex-wrap:wrap}
    .nav-links a{color:#fff;text-decoration:none;font-weight:500;transition:.3s;padding:10px 14px;border-radius:8px;display:flex;align-items:center;gap:6px;font-size:.95rem}
    .nav-links a:hover{color:#FF9900;background:rgba(255,153,0,.1)}
    .nav-links a.active{color:#FF9900;background:rgba(255,153,0,.15)}
    .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-orange{background:var(--accent);color:#fff}
    .btn-orange:hover{background:#ea580c}
    .btn-ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.25)}
    .btn-ghost:hover{border-color:rgba(255,255,255,.5)}
    .dashboard-container{max-width:1400px;margin:0 auto;padding:20px}
    .beta-box{background:rgba(249,115,22,.06);border:1px solid var(--accent);border-radius:14px;padding:16px 18px;margin:20px 0}
    .beta-box strong{color:var(--accent)}
    .grid{display:grid;gap:16px}
    .grid-4{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px}
    .kpi-title{font-size:.75rem;letter-spacing:.08em;text-transform:uppercase;color:var(--dim);margin:0}
    .kpi-val{font-size:2rem;font-weight:800;color:var(--accent);margin-top:10px}
    .sub{color:var(--dim);font-size:.9rem}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .chart-wrap{height:320px}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:7px 12px;border:1px solid rgba(255,255,255,.15);color:var(--dim);font-size:.9rem}
    .pill.ok{border-color:rgba(16,185,129,.45);color:#a7f3d0}
    .pill.err{border-color:rgba(239,68,68,.45);color:#fecaca}
    .language-selector{position:fixed;top:20px;right:20px;z-index:1000;background:#fff;border-radius:50px;box-shadow:0 4px 15px rgba(0,0,0,.1);padding:4px;display:flex}
    .lang-btn{padding:8px 16px;border:none;background:transparent;border-radius:50px;cursor:pointer;font-weight:700;font-size:.85rem;color:#64748b}
    .lang-btn.active{background:#FF9900;color:#fff;box-shadow:0 2px 8px rgba(255,153,0,.3)}
    footer{margin-top:28px;padding:28px 20px;border-top:1px solid rgba(255,255,255,.08);color:var(--dim);text-align:center}
    a{color:inherit}
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header-nav">
    <div class="nav-container">
      <a href="./index.html" class="logo-nav">
        <img src="logo-gabarit-kdp-site-web.png" alt="GabaritKDP" style="height:32px;">
        <span>GabaritKDP</span>
      </a>

      <nav class="nav-links">
        <a href="./index.html">üè† <span data-en="Home" data-fr="Accueil">Accueil</span></a>
        <a href="./dashboard.html" class="active">üìä <span data-en="Dashboard" data-fr="Tableau de bord">Tableau de bord</span></a>
        <a href="./generator.html">‚ö° <span data-en="Express Generator" data-fr="G√©n√©rateur Express">G√©n√©rateur Express</span></a>
        <a href="./marketplace.html">üìö <span data-en="Marketplace" data-fr="March√©">March√©</span></a>
        <button class="btn btn-ghost" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> <span data-en="Logout" data-fr="D√©connexion">D√©connexion</span></button>
      </nav>
    </div>
  </header>

  <!-- Language Switch -->
  <div class="language-selector">
    <button class="lang-btn active" id="btn-en">EN</button>
    <button class="lang-btn" id="btn-fr">FR</button>
  </div>

  <div class="dashboard-container">
    <div class="beta-box">
      <strong data-en="Beta ‚Äî Under construction" data-fr="B√™ta ‚Äî En cours de construction">B√™ta ‚Äî En cours de construction</strong><br>
      <span class="sub" data-en="Data is real but may be incomplete. Do not use for final decisions."
            data-fr="Les donn√©es sont r√©elles mais peuvent √™tre incompl√®tes. Ne pas utiliser pour des d√©cisions finales.">
      </span>
      <div style="margin-top:10px" class="row">
        <span class="pill" id="whoami"><i class="fa-regular fa-user"></i> ‚Ä¶</span>
        <span class="pill" id="lastSyncPill"><i class="fa-regular fa-clock"></i> ‚Ä¶</span>
        <span class="pill ok" id="statusPill"><i class="fa-solid fa-circle-check"></i> OK</span>
        <button class="btn btn-orange" id="refreshBtn"><i class="fa-solid fa-rotate"></i> <span data-en="Refresh" data-fr="Rafra√Æchir">Rafra√Æchir</span></button>
      </div>
    </div>

    <div class="grid grid-4">
      <div class="card">
        <p class="kpi-title" data-en="Royalties (latest day)" data-fr="Droits d‚Äôauteur (dernier jour)">Droits d‚Äôauteur (dernier jour)</p>
        <div class="kpi-val" id="royalties">‚Äî</div>
        <div class="sub" id="currency">‚Äî</div>
      </div>

      <div class="card">
        <p class="kpi-title" data-en="Units (latest day)" data-fr="Unit√©s (dernier jour)">Unit√©s (dernier jour)</p>
        <div class="kpi-val" id="units">‚Äî</div>
        <div class="sub" id="unitsDetail">print + digital + vvab</div>
      </div>

      <div class="card">
        <p class="kpi-title" data-en="KENP Read (latest day)" data-fr="Lecture KENP (dernier jour)">Lecture KENP (dernier jour)</p>
        <div class="kpi-val" id="kenp">‚Äî</div>
        <div class="sub" data-en="KENP pages" data-fr="Pages KENP">Pages KENP</div>
      </div>

      <div class="card">
        <p class="kpi-title" data-en="Status" data-fr="Statut">Statut</p>
        <div class="kpi-val" id="statusTxt" style="color:#a7f3d0">OK</div>
        <div class="sub" id="statusSub">‚Äî</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;grid-template-columns:1.5fr 1fr;">
      <div class="card">
        <div class="row">
          <h3 style="margin:0;font-size:1rem"><i class="fa-solid fa-chart-line"></i> <span data-en="30 days ‚Äî Royalties" data-fr="30 jours ‚Äî Redevances">30 jours ‚Äî Redevances</span></h3>
          <span class="sub">beta</span>
        </div>
        <div class="chart-wrap"><canvas id="revChart"></canvas></div>
      </div>

      <div class="card">
        <div class="row">
          <h3 style="margin:0;font-size:1rem"><i class="fa-solid fa-chart-column"></i> <span data-en="30 days ‚Äî Units" data-fr="30 jours ‚Äî Unit√©s">30 jours ‚Äî Unit√©s</span></h3>
          <span class="sub">beta</span>
        </div>
        <div class="chart-wrap"><canvas id="unitsChart"></canvas></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <i class="fa-solid fa-lock"></i>
      <strong data-en="Privacy" data-fr="Confidentialit√©">Confidentialit√©</strong>
      <div class="sub"
        data-en="This dashboard does not expose Supabase keys in the browser. Data is accessed through a secure server API."
        data-fr="Ce tableau de bord n‚Äôexpose aucune cl√© Supabase dans le navigateur. Les donn√©es passent par une API serveur s√©curis√©e.">
      </div>
    </div>
  </div>

  <footer>
    <div data-en="¬© 2025 GabaritKDP. All rights reserved." data-fr="¬© 2025 GabaritKDP. Tous droits r√©serv√©s.">
      ¬© 2025 GabaritKDP. Tous droits r√©serv√©s.
    </div>
  </footer>

  <script>
    let lang = localStorage.getItem("language") || "fr";
    const btnEn = document.getElementById("btn-en");
    const btnFr = document.getElementById("btn-fr");

    function applyLang() {
      document.querySelectorAll("[data-en]").forEach(el => {
        el.textContent = (lang === "en") ? el.getAttribute("data-en") : el.getAttribute("data-fr");
      });
      btnEn.classList.toggle("active", lang === "en");
      btnFr.classList.toggle("active", lang === "fr");
    }
    btnEn.onclick = () => { lang = "en"; localStorage.setItem("language", lang); applyLang(); };
    btnFr.onclick = () => { lang = "fr"; localStorage.setItem("language", lang); applyLang(); };

    function fmtMoney(v) {
      if (v === null || v === undefined) return "‚Äî";
      const n = Number(v);
      if (!Number.isFinite(n)) return "‚Äî";
      return n.toFixed(2);
    }

    let revChart, unitsChart;

    async function apiGet(url) {
      const r = await fetch(url, { credentials: "include" });
      if (!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    async function load() {
      try {
        const me = await apiGet("/api/me");
        document.getElementById("whoami").innerHTML = `<i class="fa-regular fa-user"></i> ${me.email}`;

        const latest = await apiGet("/api/kdp/latest");
        if (!latest) {
          document.getElementById("statusPill").className = "pill err";
          document.getElementById("statusPill").innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ERR`;
          document.getElementById("statusTxt").textContent = "ERREUR";
          document.getElementById("statusTxt").style.color = "#fecaca";
          document.getElementById("statusSub").textContent = (lang === "en")
            ? "No data yet. Run the sync first."
            : "Pas de donn√©es. Lance d‚Äôabord la synchronisation.";
          return;
        }

        document.getElementById("royalties").textContent = fmtMoney(latest.royalties);
        document.getElementById("currency").textContent = latest.currency || "‚Äî";
        const units = (Number(latest.print_orders||0) + Number(latest.digital_orders||0) + Number(latest.vvab_orders||0));
        document.getElementById("units").textContent = String(units);
        document.getElementById("kenp").textContent = String(latest.kenp_read ?? 0);

        const last = latest.metric_date || latest.created_at;
        document.getElementById("lastSyncPill").innerHTML = `<i class="fa-regular fa-clock"></i> ${(lang==="en"?"Last sync":"Derni√®re synchronisation")}: ${String(last)}`;
        document.getElementById("statusSub").textContent = `source_report_id: ${latest.source_report_id || "‚Äî"}`;

        const series = await apiGet("/api/kdp/series?days=30");
        const labels = series.map(r => r.metric_date);
        const rev = series.map(r => Number(r.royalties || 0));
        const u = series.map(r => Number(r.print_orders||0) + Number(r.digital_orders||0) + Number(r.vvab_orders||0));

        if (revChart) revChart.destroy();
        revChart = new Chart(document.getElementById("revChart"), {
          type: "line",
          data: { labels, datasets: [{ data: rev, fill: true, tension: 0.35 }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
        });

        if (unitsChart) unitsChart.destroy();
        unitsChart = new Chart(document.getElementById("unitsChart"), {
          type: "bar",
          data: { labels, datasets: [{ data: u }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
        });

      } catch (e) {
        // non logg√© / session expir√©e => login
        window.location.href = "./login.html";
      }
    }

    document.getElementById("refreshBtn").onclick = load;
    document.getElementById("logoutBtn").onclick = async () => {
      await fetch("/api/logout", { method:"POST", credentials:"include" });
      window.location.href = "./login.html";
    };

    applyLang();
    load();
  </script>
</body>
</html>
