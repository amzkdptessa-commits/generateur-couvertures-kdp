<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tableau de bord — GabaritKDP Tracker</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#141a22;
      --panel-2:#1c2430;
      --accent:#f97316;
      --text:#ffffff;
      --muted:#b3b3b3;
      --border:rgba(255,255,255,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Segoe UI,system-ui,-apple-system,BlinkMacSystemFont;
      background:var(--bg);
      color:var(--text);
    }

    /* ===== HEADER ===== */
    header{
      background:linear-gradient(135deg,#1e293b,#0f172a);
      border-bottom:1px solid var(--border);
    }
    .header-inner{
      max-width:1200px;
      margin:0 auto;
      padding:14px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      font-size:18px;
      color:var(--accent);
    }
    .nav{
      display:flex;
      gap:10px;
    }
    .btn{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      background:transparent;
      color:#fff;
      cursor:pointer;
      font-weight:700;
    }
    .btn-orange{
      background:var(--accent);
      border:none;
    }
    .btn-orange:hover{background:#ea580c}

    /* ===== PAGE ===== */
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:24px 20px;
    }

    /* ===== BETA BOX ===== */
    .beta{
      border:1px solid var(--accent);
      background:rgba(249,115,22,.08);
      border-radius:16px;
      padding:18px;
      margin-bottom:22px;
    }
    .beta h2{
      margin:0 0 8px 0;
      color:var(--accent);
      font-size:18px;
    }
    .beta p{
      margin:6px 0;
      color:var(--muted);
      line-height:1.5;
    }

    /* ===== GRID ===== */
    .grid{
      display:grid;
      gap:16px;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    }

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px;
    }

    .k{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .v{
      font-size:30px;
      font-weight:900;
      color:var(--accent);
      margin-top:8px;
    }
    .sub{
      color:var(--muted);
      margin-top:4px;
      font-size:13px;
    }

    canvas{height:280px !important}

    /* ===== FOOTER ===== */
    footer{
      margin-top:40px;
      border-top:1px solid var(--border);
      background:#0f172a;
    }
    .footer-inner{
      max-width:1200px;
      margin:0 auto;
      padding:20px;
      display:grid;
      gap:14px;
      font-size:13px;
      color:var(--muted);
    }
    .footer-inner strong{
      color:#fff;
    }
  </style>
</head>

<body>

<!-- ===== HEADER ===== -->
<header>
  <div class="header-inner">
    <div class="brand">GabaritKDP Tracker</div>
    <div class="nav">
      <button class="btn" id="refresh">Rafraîchir</button>
      <button class="btn btn-orange" id="logout">Déconnexion</button>
    </div>
  </div>
</header>

<!-- ===== CONTENT ===== -->
<div class="wrap">

  <!-- ===== BETA MESSAGE ===== -->
  <div class="beta">
    <h2>Version bêta — En cours de construction</h2>

    <p>
      Ce tableau de bord est actuellement en <strong>version bêta</strong>.
      Les données affichées sont <strong>réelles</strong>, mais certaines fonctionnalités
      peuvent être incomplètes ou évoluer.
    </p>

    <p>
      <strong>Important :</strong> pour que les données apparaissent,
      vous devez <strong>installer l’extension GabaritKDP Tracker</strong>
      puis vous <strong>connecter avec le même compte</strong>.
    </p>

    <p>
      L’extension collecte automatiquement vos rapports KDP
      lorsque vous consultez <em>kdpreports.amazon.com</em>.
      Aucune donnée n’est collectée sans votre action.
    </p>

    <p id="who">—</p>
  </div>

  <!-- ===== KPI ===== -->
  <div class="grid">
    <div class="card">
      <div class="k">Droits d’auteur (dernier jour)</div>
      <div class="v" id="roy">—</div>
      <div class="sub" id="cur">—</div>
    </div>

    <div class="card">
      <div class="k">Unités (dernier jour)</div>
      <div class="v" id="units">—</div>
      <div class="sub">print + digital + vvb</div>
    </div>

    <div class="card">
      <div class="k">Lecture KENP (dernier jour)</div>
      <div class="v" id="kenp">—</div>
      <div class="sub">pages lues</div>
    </div>

    <div class="card">
      <div class="k">Statut</div>
      <div class="v" id="status">—</div>
      <div class="sub" id="sync">—</div>
    </div>
  </div>

  <!-- ===== CHARTS ===== -->
  <div class="grid" style="margin-top:18px;grid-template-columns:1.5fr 1fr;">
    <div class="card">
      <div class="k">30 jours — Redevances (bêta)</div>
      <canvas id="c1"></canvas>
    </div>
    <div class="card">
      <div class="k">30 jours — Unités (bêta)</div>
      <canvas id="c2"></canvas>
    </div>
  </div>

</div>

<!-- ===== FOOTER ===== -->
<footer>
  <div class="footer-inner">
    <div>
      <strong>GabaritKDP Tracker</strong> — outil d’analyse indépendant pour Amazon KDP.
    </div>
    <div>
      Version bêta. Les données restent la propriété exclusive de l’utilisateur.
      Aucune revente, aucune exploitation commerciale.
    </div>
    <div>
      <strong>EN:</strong> This dashboard is in beta. Data is collected only after explicit user action via the browser extension.
      No credentials are shared with Amazon.
    </div>
    <div>
      © 2026 — GabaritKDP. All rights reserved.
    </div>
  </div>
</footer>

<script>
  let c1, c2;

  async function api(url){
    const r = await fetch(url, { credentials:"include" });
    if(!r.ok) throw new Error("not-auth");
    return await r.json();
  }

  async function load(){
    try{
      const me = await api("/api/me");
      document.getElementById("who").textContent =
        "Connectée : " + me.email + " — via l’extension GabaritKDP Tracker";

      const latest = await api("/api/kdp/latest");
      if(!latest) return;

      document.getElementById("roy").textContent = Number(latest.royalties||0).toFixed(2);
      document.getElementById("cur").textContent = latest.currency || "EUR";

      const u = (Number(latest.print_orders||0)+Number(latest.digital_orders||0)+Number(latest.vvab_orders||0));
      document.getElementById("units").textContent = u;

      document.getElementById("kenp").textContent = latest.kenp_read ?? 0;
      document.getElementById("status").textContent = "OK";
      document.getElementById("sync").textContent = "Dernière synchro : " + (latest.metric_date || latest.created_at);

      const series = await api("/api/kdp/series?days=30");
      const labels = series.map(x=>x.metric_date);
      const rev = series.map(x=>Number(x.royalties||0));
      const units = series.map(x=>Number(x.print_orders||0)+Number(x.digital_orders||0)+Number(x.vvab_orders||0));

      if(c1) c1.destroy();
      c1 = new Chart(document.getElementById("c1"), {
        type:"line",
        data:{ labels, datasets:[{ data:rev, tension:.35, fill:true }] },
        options:{ plugins:{ legend:{ display:false } } }
      });

      if(c2) c2.destroy();
      c2 = new Chart(document.getElementById("c2"), {
        type:"bar",
        data:{ labels, datasets:[{ data:units }] },
        options:{ plugins:{ legend:{ display:false } } }
      });

    }catch(e){
      window.location.href="/login.html";
    }
  }

  document.getElementById("refresh").onclick = load;
  document.getElementById("logout").onclick = async () => {
    await fetch("/api/logout", { method:"POST", credentials:"include" });
    window.location.href="/login.html";
  };

  load();
</script>

</body>
</html>
