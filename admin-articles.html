<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Articles - GabaritKDP</title>
  <meta name="robots" content="noindex, nofollow" />

  <link rel="icon" type="image/png" href="logo-gabarit-kdp-site-web.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="bg-gray-50">
  <div id="header-placeholder"></div>
  <script>
    fetch('./header.html').then(r => r.text()).then(html => {
      const el = document.getElementById('header-placeholder');
      if (el) el.innerHTML = html;
    }).catch(() => {});
  </script>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900">Admin · Articles</h1>
        <p class="text-gray-600 mt-2">Create, edit, publish and manage your guides without touching the code.</p>
      </div>

      <div class="flex items-center gap-2">
        <button id="btn-new" class="px-4 py-2 rounded-lg bg-orange-500 text-white font-semibold hover:bg-orange-600 transition">+ New</button>
        <button id="btn-logout" class="px-4 py-2 rounded-lg border bg-white font-semibold">Logout</button>
      </div>
    </div>

    <div id="auth-warning" class="hidden mt-6 p-4 rounded-xl bg-red-50 border border-red-200 text-red-800"></div>

    <div class="mt-8 grid lg:grid-cols-3 gap-6">
      <!-- LIST -->
      <section class="bg-white border rounded-2xl p-5 lg:col-span-1">
        <div class="flex items-center justify-between gap-2">
          <h2 class="font-bold text-gray-900">Your articles</h2>
          <select id="filter" class="text-sm px-3 py-2 border rounded-lg bg-white">
            <option value="all">All</option>
            <option value="draft">Draft</option>
            <option value="published">Published</option>
          </select>
        </div>

        <input id="search" type="text" placeholder="Search title..." class="mt-4 w-full px-3 py-2 border rounded-lg" />

        <div id="list" class="mt-4 space-y-3"></div>
      </section>

      <!-- EDITOR -->
      <section class="bg-white border rounded-2xl p-5 lg:col-span-2">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <h2 class="font-bold text-gray-900">Editor</h2>
          <div class="flex items-center gap-2 flex-wrap">
            <button id="btn-save" class="px-4 py-2 rounded-lg border bg-white font-semibold">Save</button>
            <button id="btn-publish" class="px-4 py-2 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 transition">Publish</button>
            <button id="btn-unpublish" class="px-4 py-2 rounded-lg bg-gray-800 text-white font-semibold hover:bg-black transition">Unpublish</button>
            <button id="btn-delete" class="px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition">Delete</button>
          </div>
        </div>

        <div class="mt-5 grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-semibold text-gray-700">Title</label>
            <input id="title" class="mt-1 w-full px-3 py-2 border rounded-lg" />
          </div>
          <div>
            <label class="text-sm font-semibold text-gray-700">Slug (URL)</label>
            <input id="slug" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="ex: pourquoi-kdp-rejette-vos-fichiers" />
            <p class="text-xs text-gray-500 mt-1">Tip: only lowercase, numbers and dashes.</p>
          </div>
          <div>
            <label class="text-sm font-semibold text-gray-700">Language</label>
            <select id="language" class="mt-1 w-full px-3 py-2 border rounded-lg bg-white">
              <option value="fr">FR</option>
              <option value="en">EN</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-semibold text-gray-700">Cover image URL (optional)</label>
            <input id="cover" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="https://..." />
          </div>
        </div>

        <div class="mt-4">
          <label class="text-sm font-semibold text-gray-700">Excerpt (optional)</label>
          <textarea id="excerpt" rows="3" class="mt-1 w-full px-3 py-2 border rounded-lg"></textarea>
        </div>

        <div class="mt-4">
          <label class="text-sm font-semibold text-gray-700">Content (Markdown)</label>
          <textarea id="content" rows="18" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="# Title\n\nYour content..."></textarea>
          <div class="mt-2 text-xs text-gray-500">
            Markdown supported. Use <code>**bold**</code>, <code>## headings</code>, lists, links, etc.
          </div>
        </div>

        <div class="mt-5 bg-gray-50 border rounded-xl p-4">
          <p class="text-sm text-gray-700"><span class="font-semibold">Public URL:</span> <span id="public-url" class="text-gray-900"></span></p>
          <p class="text-xs text-gray-500 mt-1">This works after you publish.</p>
        </div>

        <div id="toast" class="hidden mt-5 p-3 rounded-xl border"></div>
      </section>
    </div>
  </main>

  <script>
    // ------------------------
    // CONFIG
    // ------------------------
    const SUPABASE_URL = 'PUT_YOUR_SUPABASE_URL_HERE';
    const SUPABASE_ANON_KEY = 'PUT_YOUR_SUPABASE_ANON_KEY_HERE';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ------------------------
    // Helpers
    // ------------------------
    const $ = (id) => document.getElementById(id);

    function showToast(msg, type = 'ok') {
      const el = $('toast');
      if (!el) return;
      el.classList.remove('hidden');
      el.className = 'mt-5 p-3 rounded-xl border';
      if (type === 'ok') el.classList.add('bg-green-50','border-green-200','text-green-800');
      if (type === 'warn') el.classList.add('bg-yellow-50','border-yellow-200','text-yellow-800');
      if (type === 'err') el.classList.add('bg-red-50','border-red-200','text-red-800');
      el.textContent = msg;
      window.clearTimeout(window.__toastTimer);
      window.__toastTimer = window.setTimeout(() => el.classList.add('hidden'), 2500);
    }

    function slugify(s) {
      return (s || '')
        .toLowerCase()
        .trim()
        .replace(/\s+/g, '-')
        .replace(/[^a-z0-9\-]/g, '')
        .replace(/\-\-+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function setPublicUrl() {
      const slug = ($('slug')?.value || '').trim();
      const url = slug ? `${location.origin}/article.html?slug=${encodeURIComponent(slug)}` : '';
      $('public-url').textContent = url;
    }

    // ------------------------
    // Auth + Admin check
    // ------------------------
    let sessionUser = null;
    let activeId = null; // article id currently in editor

    async function requireAdmin() {
      const { data: sessData } = await supabase.auth.getSession();
      sessionUser = sessData?.session?.user || null;

      if (!sessionUser) {
        $('auth-warning').classList.remove('hidden');
        $('auth-warning').innerHTML = 'You are not logged in. Please login first, then come back to <b>admin-articles.html</b>.';
        throw new Error('Not logged in');
      }

      // Check admin_users table (RLS allows selecting self if exists)
      const { data: adminRow, error } = await supabase
        .from('admin_users')
        .select('id')
        .eq('id', sessionUser.id)
        .maybeSingle();

      if (error || !adminRow) {
        $('auth-warning').classList.remove('hidden');
        $('auth-warning').innerHTML = 'Access denied: your account is not in <b>admin_users</b>. Add your user id in Supabase SQL editor.';
        throw new Error('Not admin');
      }

      $('auth-warning').classList.add('hidden');
    }

    // ------------------------
    // Data
    // ------------------------
    async function loadList() {
      const filter = $('filter')?.value || 'all';
      const q = ($('search')?.value || '').trim();

      let query = supabase
        .from('articles')
        .select('id,title,slug,status,language,published_at,updated_at')
        .order('updated_at', { ascending: false });

      if (filter !== 'all') query = query.eq('status', filter);
      if (q) query = query.ilike('title', `%${q}%`);

      const { data, error } = await query;
      if (error) {
        showToast('Error loading list: ' + (error.message || ''), 'err');
        return;
      }

      const list = $('list');
      if (!list) return;

      const items = (data || []).filter(Boolean);
      if (!items.length) {
        list.innerHTML = '<div class="text-sm text-gray-600">No articles.</div>';
        return;
      }

      list.innerHTML = items.map(it => {
        const badge = it.status === 'published'
          ? '<span class="text-xs px-2 py-1 rounded-full bg-green-50 border border-green-200 text-green-800">published</span>'
          : '<span class="text-xs px-2 py-1 rounded-full bg-gray-100 border text-gray-700">draft</span>';

        return `
          <button data-id="${it.id}" class="w-full text-left p-3 rounded-xl border hover:bg-gray-50 transition">
            <div class="flex items-center justify-between gap-2">
              <div class="font-semibold text-gray-900">${it.title || '(Untitled)'}</div>
              ${badge}
            </div>
            <div class="mt-1 text-xs text-gray-500">/${it.slug} · ${String(it.language || 'fr').toUpperCase()}</div>
          </button>
        `;
      }).join('');

      list.querySelectorAll('button[data-id]').forEach(btn => {
        btn.addEventListener('click', () => openArticle(btn.getAttribute('data-id')));
      });
    }

    async function openArticle(id) {
      if (!id) return;

      const { data, error } = await supabase
        .from('articles')
        .select('*')
        .eq('id', id)
        .single();

      if (error || !data) {
        showToast('Error opening article', 'err');
        return;
      }

      activeId = data.id;
      $('title').value = data.title || '';
      $('slug').value = data.slug || '';
      $('language').value = data.language || 'fr';
      $('cover').value = data.cover_image_url || '';
      $('excerpt').value = data.excerpt || '';
      $('content').value = data.content_md || '';
      setPublicUrl();

      showToast('Loaded', 'ok');
    }

    function clearEditor() {
      activeId = null;
      $('title').value = '';
      $('slug').value = '';
      $('language').value = 'fr';
      $('cover').value = '';
      $('excerpt').value = '';
      $('content').value = '';
      setPublicUrl();
    }

    function getPayload() {
      const title = ($('title')?.value || '').trim();
      const slug = ($('slug')?.value || '').trim();
      const language = $('language')?.value || 'fr';
      const cover = ($('cover')?.value || '').trim();
      const excerpt = ($('excerpt')?.value || '').trim();
      const content = ($('content')?.value || '').trim();

      if (!title) throw new Error('Title is required');
      if (!slug) throw new Error('Slug is required');
      if (!content) throw new Error('Content is required');

      return {
        title,
        slug,
        language,
        cover_image_url: cover || null,
        excerpt: excerpt || null,
        content_md: content,
      };
    }

    async function saveDraft() {
      try {
        const payload = getPayload();
        payload.status = 'draft';
        payload.published_at = null;

        if (!sessionUser?.id) throw new Error('No user');

        if (!activeId) {
          // insert
          payload.author_id = sessionUser.id;
          const { data, error } = await supabase
            .from('articles')
            .insert(payload)
            .select('id')
            .single();

          if (error) throw error;
          activeId = data.id;
          showToast('Draft created', 'ok');
        } else {
          const { error } = await supabase
            .from('articles')
            .update(payload)
            .eq('id', activeId);

          if (error) throw error;
          showToast('Draft saved', 'ok');
        }

        await loadList();
        setPublicUrl();
      } catch (e) {
        showToast(e.message || 'Save error', 'err');
      }
    }

    async function publish() {
      try {
        const payload = getPayload();
        payload.status = 'published';
        payload.published_at = new Date().toISOString();

        if (!sessionUser?.id) throw new Error('No user');

        if (!activeId) {
          payload.author_id = sessionUser.id;
          const { data, error } = await supabase
            .from('articles')
            .insert(payload)
            .select('id')
            .single();
          if (error) throw error;
          activeId = data.id;
        } else {
          const { error } = await supabase
            .from('articles')
            .update(payload)
            .eq('id', activeId);
          if (error) throw error;
        }

        showToast('Published', 'ok');
        await loadList();
        setPublicUrl();
      } catch (e) {
        showToast(e.message || 'Publish error', 'err');
      }
    }

    async function unpublish() {
      if (!activeId) return showToast('Open an article first', 'warn');
      const { error } = await supabase
        .from('articles')
        .update({ status: 'draft', published_at: null })
        .eq('id', activeId);

      if (error) return showToast('Unpublish error: ' + error.message, 'err');
      showToast('Unpublished (back to draft)', 'ok');
      await loadList();
    }

    async function remove() {
      if (!activeId) return showToast('Open an article first', 'warn');
      if (!confirm('Delete this article? This cannot be undone.')) return;

      const { error } = await supabase
        .from('articles')
        .delete()
        .eq('id', activeId);

      if (error) return showToast('Delete error: ' + error.message, 'err');
      showToast('Deleted', 'ok');
      clearEditor();
      await loadList();
    }

    // ------------------------
    // Events
    // ------------------------
    $('btn-new')?.addEventListener('click', () => {
      clearEditor();
      showToast('New article', 'ok');
    });

    $('btn-save')?.addEventListener('click', saveDraft);
    $('btn-publish')?.addEventListener('click', publish);
    $('btn-unpublish')?.addEventListener('click', unpublish);
    $('btn-delete')?.addEventListener('click', remove);

    $('filter')?.addEventListener('change', loadList);
    $('search')?.addEventListener('input', () => {
      window.clearTimeout(window.__admSearchTimer);
      window.__admSearchTimer = window.setTimeout(loadList, 200);
    });

    $('title')?.addEventListener('input', () => {
      // auto slug if empty
      const s = $('slug').value.trim();
      if (!s) $('slug').value = slugify($('title').value);
      setPublicUrl();
    });
    $('slug')?.addEventListener('input', () => {
      $('slug').value = slugify($('slug').value);
      setPublicUrl();
    });

    $('btn-logout')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      location.href = './index.html';
    });

    // ------------------------
    // Init
    // ------------------------
    (async function init() {
      try {
        await requireAdmin();
        clearEditor();
        await loadList();
      } catch (e) {
        // stop
      }
    })();
  </script>
</body>
</html>
