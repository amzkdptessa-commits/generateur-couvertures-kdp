<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Connexion Canva - GabaritKDP</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    }
    .card {
      width:100%; max-width:480px; background:#fff; border-radius:14px;
      padding:36px; box-shadow: 0 20px 50px rgba(0,0,0,0.25); text-align:center;
    }
    .spinner {
      width:56px; height:56px; margin:0 auto 18px; border-radius:50%;
      border:4px solid #f3f4f6; border-top-color:#667eea;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    h2 { font-size:1.25rem; color:#111827; margin-bottom:8px; }
    p { color:#6b7280; }
  </style>
</head>
<body>
  <main class="card">
    <div class="spinner"></div>
    <h2>Connexion Ã  Canva...</h2>
    <p>Redirection en cours, veuillez patienter.</p>
  </main>

  <script>
    (async function () {
      const CLIENT_ID = "OC-AZnaRLvMwpXk";
      const REDIRECT_URI = "https://gabaritkdp.com/auth/callback.html";
      const OAUTH_URL = "https://www.canva.com/api/oauth/authorize";
      const SCOPES = "design:meta:read design:content:read asset:read";

      function generateVerifier() {
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        return btoa(String.fromCharCode(...array))
          .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
      }

      async function generateChallenge(verifier) {
        const encoder = new TextEncoder();
        const data = encoder.encode(verifier);
        const digest = await crypto.subtle.digest('SHA-256', data);
        return btoa(String.fromCharCode(...new Uint8Array(digest)))
          .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
      }

      const verifier = generateVerifier();
      const challenge = await generateChallenge(verifier);

      // Sauvegarder dans localStorage ET sessionStorage
      localStorage.setItem('canva_pkce_verifier', verifier);
      sessionStorage.setItem('canva_pkce_verifier', verifier);

      // Passer le verifier dans state aussi comme backup
      const stateData = btoa(JSON.stringify({ v: verifier, ts: Date.now() }));

      const params = new URLSearchParams({
        client_id: CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        response_type: 'code',
        scope: SCOPES,
        code_challenge: challenge,
        code_challenge_method: 'S256',
        state: stateData
      });

      window.location.href = OAUTH_URL + '?' + params.toString();
    })();
  </script>
</body>
</html>
