<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connexion √† Canva - GabaritKDP</title>
  <link rel="icon" type="image/png" href="/logo-gabarit-kdp-site-web.png">
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }

    .card {
      width: 100%;
      max-width: 480px;
      background: #fff;
      border-radius: 20px;
      padding: 48px 36px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Logo GabaritKDP */
    .logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #FF9900, #FF6B00);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 900;
      color: #fff;
      box-shadow: 0 8px 20px rgba(255, 153, 0, 0.3);
    }

    /* Spinner de chargement */
    .spinner {
      width: 64px;
      height: 64px;
      margin: 0 auto 24px;
      border-radius: 50%;
      border: 5px solid #f3f4f6;
      border-top-color: #667eea;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Ic√¥nes de statut */
    .status-icon {
      font-size: 72px;
      margin: 0 auto 20px;
      display: block;
      animation: scaleIn 0.5s ease;
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.5);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .success-icon {
      color: #10b981;
    }

    .error-icon {
      color: #ef4444;
    }

    .warning-icon {
      color: #f59e0b;
    }

    /* Titres */
    h2 {
      font-size: 1.5rem;
      color: #111827;
      margin-bottom: 12px;
      font-weight: 700;
      line-height: 1.3;
    }

    /* Sous-titres */
    p {
      color: #6b7280;
      margin-bottom: 8px;
      line-height: 1.6;
      font-size: 0.95rem;
    }

    p.highlight {
      background: #fef3c7;
      padding: 12px 16px;
      border-radius: 10px;
      border-left: 4px solid #f59e0b;
      margin: 16px 0;
      font-weight: 500;
      color: #92400e;
    }

    /* Boutons */
    .btn {
      display: inline-block;
      margin-top: 20px;
      padding: 14px 28px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      font-size: 1rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      box-shadow: none;
      margin-left: 12px;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    /* Barre de progression */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e5e7eb;
      border-radius: 4px;
      margin: 24px 0 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 4px;
      animation: progress 2s ease;
    }

    @keyframes progress {
      from { width: 0%; }
      to { width: 100%; }
    }

    /* Messages techniques */
    .tech-details {
      margin-top: 16px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #6b7280;
      text-align: left;
    }

    .tech-details code {
      background: #e5e7eb;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      color: #374151;
    }

    /* Responsive */
    @media (max-width: 500px) {
      .card {
        padding: 36px 24px;
      }
      
      h2 {
        font-size: 1.3rem;
      }
      
      .btn {
        width: 100%;
        margin-left: 0 !important;
        margin-top: 10px;
      }
    }

    /* Animation du logo Canva */
    .canva-logo {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      animation: pulse 2s ease infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.05);
      }
    }
  </style>
</head>
<body>
  <main class="card" id="card">
    <!-- Contenu dynamique inject√© par JavaScript -->
    <div class="logo">K</div>
    <div class="spinner"></div>
    <h2>Connexion √† Canva en cours...</h2>
    <p>Veuillez patienter pendant que nous s√©curisons votre connexion.</p>
    <div class="progress-bar">
      <div class="progress-fill"></div>
    </div>
  </main>

  <script>
    (async function() {
      'use strict';

      // ‚öôÔ∏è CONFIGURATION - √Ä adapter √† votre environnement
      const CONFIG = {
        WORKER_URL: 'https://canva-token.amzkdptessa.workers.dev',
        SITE_ORIGIN: window.location.origin, // D√©tection automatique
        CALLBACK_PATH: '/auth/callback.html',
        FINAL_REDIRECT: '/generator.html',
        REDIRECT_DELAY: 1800 // ms avant redirection (succ√®s)
      };

      const card = document.getElementById('card');

      // =========================================================================
      // FONCTIONS D'AFFICHAGE
      // =========================================================================

      /**
       * Affiche l'√©tat de chargement
       */
      function renderLoading() {
        card.innerHTML = `
          <div class="logo">K</div>
          <div class="spinner"></div>
          <h2>üîê Authentification en cours...</h2>
          <p>√âchange s√©curis√© avec Canva en cours.<br>Cela ne prend que quelques secondes.</p>
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
        `;
      }

      /**
       * Affiche le succ√®s et redirige automatiquement
       */
      function renderSuccessAndRedirect() {
        card.innerHTML = `
          <div class="logo">K</div>
          <div class="status-icon success-icon">‚úì</div>
          <h2>üéâ Connexion r√©ussie !</h2>
          <p>Votre compte Canva est maintenant connect√© √† GabaritKDP.</p>
          <p>Vous pouvez d√©sormais importer vos designs Canva directement dans le g√©n√©rateur.</p>
          <p class="highlight">Redirection automatique dans ${CONFIG.REDIRECT_DELAY/1000} secondes...</p>
          <a class="btn" href="${CONFIG.FINAL_REDIRECT}">Acc√©der au g√©n√©rateur maintenant ‚Üí</a>
        `;

        // Redirection automatique apr√®s d√©lai
        setTimeout(() => {
          window.location.href = CONFIG.FINAL_REDIRECT;
        }, CONFIG.REDIRECT_DELAY);
      }

      /**
       * Affiche une erreur avec message personnalis√©
       */
      function renderError(message, technical = null) {
        card.innerHTML = `
          <div class="logo">K</div>
          <div class="status-icon error-icon">‚úó</div>
          <h2>‚ùå Erreur d'authentification</h2>
          <p>${message}</p>
          <p>Veuillez r√©essayer ou contacter notre support si le probl√®me persiste.</p>
          ${technical ? `
            <div class="tech-details">
              <strong>D√©tails techniques :</strong><br>
              <code>${technical}</code>
            </div>
          ` : ''}
          <a class="btn" href="${CONFIG.FINAL_REDIRECT}">Retour au g√©n√©rateur</a>
          <a class="btn btn-secondary" href="mailto:support@gabaritkdp.com">Contacter le support</a>
        `;
      }

      /**
       * Affiche l'√©tat "connexion annul√©e"
       */
      function renderCancelled() {
        card.innerHTML = `
          <div class="logo">K</div>
          <div class="status-icon warning-icon">‚ö†</div>
          <h2>‚ö†Ô∏è Connexion annul√©e</h2>
          <p>Vous avez refus√© l'acc√®s √† Canva.</p>
          <p>Pour utiliser vos designs Canva dans GabaritKDP, vous devez autoriser l'acc√®s √† vos designs.</p>
          <p class="highlight">
            Rassurez-vous : GabaritKDP peut uniquement <strong>lire</strong> vos designs.<br>
            Nous ne pouvons ni les modifier, ni les supprimer.
          </p>
          <a class="btn" href="${CONFIG.FINAL_REDIRECT}">R√©essayer la connexion</a>
          <a class="btn btn-secondary" href="${CONFIG.FINAL_REDIRECT}">Continuer sans Canva</a>
        `;
      }

      /**
       * Affiche l'erreur "session expir√©e"
       */
      function renderSessionExpired() {
        card.innerHTML = `
          <div class="logo">K</div>
          <div class="status-icon warning-icon">‚è±</div>
          <h2>‚è±Ô∏è Session expir√©e</h2>
          <p>Votre session de connexion a expir√©.</p>
          <p>Cela arrive si vous avez pris trop de temps pour autoriser l'acc√®s, ou si vous avez rafra√Æchi la page.</p>
          <p class="highlight">
            <strong>Solution :</strong> Relancez la connexion depuis le g√©n√©rateur.
          </p>
          <a class="btn" href="${CONFIG.FINAL_REDIRECT}">Retour au g√©n√©rateur</a>
        `;
      }

      // =========================================================================
      // LOGIQUE PRINCIPALE
      // =========================================================================

      try {
        renderLoading();

        // R√©cup√©rer les param√®tres de l'URL
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const error = params.get('error');

        // Cas 1 : L'utilisateur a refus√© l'acc√®s
        if (error) {
          console.log('‚ùå Erreur OAuth:', error);
          return renderCancelled();
        }

        // Cas 2 : Pas de code d'autorisation
        if (!code) {
          console.error('‚ùå Code d\'autorisation manquant');
          return renderError(
            'Le code d\'autorisation est manquant dans l\'URL.',
            'Param√®tre "code" absent'
          );
        }

        // Cas 3 : R√©cup√©ration du PKCE code_verifier
        const verifier = 
          sessionStorage.getItem('pkce_code_verifier') ||
          localStorage.getItem('canva_pkce_verifier') ||
          localStorage.getItem('pkce_code_verifier') ||
          localStorage.getItem('code_verifier');

        if (!verifier) {
          console.error('‚ùå PKCE code_verifier manquant');
          return renderSessionExpired();
        }

        console.log('‚úÖ Code et verifier r√©cup√©r√©s, √©change en cours...');

        // Cas 4 : √âchange du code contre un access_token
        const redirectUri = CONFIG.SITE_ORIGIN + CONFIG.CALLBACK_PATH;
        
        const response = await fetch(CONFIG.WORKER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            code: code,
            code_verifier: verifier,
            redirect_uri: redirectUri
          }),
          credentials: 'include'
        });

        // Parse de la r√©ponse
        let data;
        try {
          data = await response.json();
        } catch (parseError) {
          console.error('‚ùå Erreur parsing JSON:', parseError);
          return renderError(
            'Le serveur a renvoy√© une r√©ponse invalide.',
            'JSON parse error'
          );
        }

        // Gestion des erreurs HTTP
        if (!response.ok) {
          console.error('‚ùå Token exchange failed:', response.status, data);
          
          const errorMsg = data?.error_description || data?.error || 'Erreur inconnue';
          
          // Messages d'erreur adapt√©s
          if (response.status === 400 && errorMsg.includes('code')) {
            return renderError(
              'Le code d\'autorisation est invalide ou a d√©j√† √©t√© utilis√©.',
              errorMsg
            );
          }
          
          if (response.status === 401) {
            return renderError(
              'Les credentials de l\'application sont incorrects.',
              'V√©rifier CLIENT_ID et CLIENT_SECRET'
            );
          }

          return renderError(
            `Une erreur s'est produite lors de l'√©change du token (${response.status}).`,
            errorMsg
          );
        }

        // V√©rification de la pr√©sence du token
        if (!data.access_token) {
          console.error('‚ùå R√©ponse sans access_token:', data);
          return renderError(
            'Le serveur n\'a pas renvoy√© de token d\'acc√®s.',
            'access_token manquant dans la r√©ponse'
          );
        }

        // üíæ Stockage des tokens
        console.log('‚úÖ Access token re√ßu, stockage...');
        
        localStorage.setItem('canva_access_token', data.access_token);
        
        if (data.refresh_token) {
          localStorage.setItem('canva_refresh_token', data.refresh_token);
          console.log('‚úÖ Refresh token stock√©');
        }
        
        if (data.expires_in) {
          const expiresAt = Date.now() + (data.expires_in * 1000);
          localStorage.setItem('canva_token_expiry', expiresAt.toString());
          localStorage.setItem('canva_expires_at', expiresAt.toString());
          console.log(`‚úÖ Token expire dans ${Math.floor(data.expires_in / 60)} minutes`);
        }

        // Nettoyage du code_verifier (usage unique)
        sessionStorage.removeItem('pkce_code_verifier');
        localStorage.removeItem('canva_pkce_verifier');
        localStorage.removeItem('pkce_code_verifier');
        localStorage.removeItem('code_verifier');

        console.log('üéâ Authentification r√©ussie !');
        
        // Affichage du succ√®s et redirection
        renderSuccessAndRedirect();

      } catch (error) {
        console.error('‚ùå Erreur inattendue:', error);
        renderError(
          'Une erreur inattendue s\'est produite.',
          error.message || 'Voir la console pour plus de d√©tails'
        );
      }
    })();
  </script>
</body>
</html>
