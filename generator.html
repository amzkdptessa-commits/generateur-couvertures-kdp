<!DOCTYPE html>
<html translate="no" lang="en">

<head>
    <meta name="google" content="notranslate">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-fr="G√©n√©rateur KDP - Cr√©ez vos Gabarits Conformes | GabaritKDP"
        data-en="KDP Generator - Create Your Compliant Templates | GabaritKDP">KDP Generator - Create Your Compliant
        Templates | GabaritKDP</title>
    <link rel="icon" type="image/png" href="logo-gabarit-kdp-site-web.png">
    <meta name="description"
        data-fr="Outil professionnel pour cr√©er des couvertures KDP aux dimensions exactes Amazon. Interface fran√ßaise, calculs pr√©cis."
        data-en="Professional tool to create KDP covers with exact Amazon dimensions. French interface, precise calculations."
        content="Professional tool to create KDP covers with exact Amazon dimensions. French interface, precise calculations.">

    <link rel="icon" type="image/png" href="logo-gabarit-kdp-site-web.png">
<!-- üî§ GOOGLE FONTS (UI ONLY) -->
<!--
  ‚ö†Ô∏è Performance: on ne charge au d√©marrage que les polices de l‚Äôinterface.
  Les polices ‚Äúcover‚Äù sont charg√©es √† la demande via loadFontOnDemand() (voir plus bas).
-->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600;700&display=swap">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-MYG5JJM8EC"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-MYG5JJM8EC');
    </script>

    <link rel="stylesheet" crossorigin href="./dist-generator/assets/index-CkZaMbO5.css">
<link href="style.min.css" rel="stylesheet">
<style>
/* FIX: prevent React bundle/global CSS from making header nav text invisible */
header.header-nav .nav-links a,
header.header-nav .mobile-menu-links a,
header.header-nav .logo-nav,
header.header-nav .logo-nav span,
header.header-nav .nav-links span {
  color: #fff !important;
}
</style>


<script>
  // üî§ Google Fonts lazy-loader (covers/fonts)
  // - Charge uniquement la police choisie par l‚Äôutilisateur (au lieu de 40+ polices au d√©marrage).
  // - Conserve un cache pour √©viter les doublons.
  (function () {
    const SYSTEM_FONTS = new Set([
      'Arial','Helvetica','Verdana','Times New Roman','Georgia','Impact',
      '-apple-system','BlinkMacSystemFont','Segoe UI','sans-serif','serif'
    ]);

    // Certaines familles n‚Äôexposent pas l‚Äôaxe wght (ou pas 700). On demande donc la famille "simple".
    const NO_WGHT_AXIS = new Set([
      'Pacifico','Great Vibes','Satisfy','Sacramento','Allura','Alex Brush','Pinyon Script',
      'Berkshire Swash','Abril Fatface','Alfa Slab One','Bangers','Permanent Marker','Righteous',
      'Creepster','Nosifer','Metal Mania','Butcherman','Rubik Glitch','Press Start 2P','VT323'
    ]);

    const loaded = new Set();
    function toGoogleFamily(name) { return String(name || '').trim().replace(/\s+/g, '+'); }

    window.loadFontOnDemand = function loadFontOnDemand(fontName) {
      const name = String(fontName || '').trim();
      if (!name || SYSTEM_FONTS.has(name)) return Promise.resolve();

      // D√©j√† charg√© ?
      if (loaded.has(name)) return Promise.resolve();
      if (document.fonts && document.fonts.check && document.fonts.check(`1em "${name}"`)) {
        loaded.add(name);
        return Promise.resolve();
      }

      const family = toGoogleFamily(name);
      const href = NO_WGHT_AXIS.has(name)
        ? `https://fonts.googleapis.com/css2?family=${family}&display=swap`
        : `https://fonts.googleapis.com/css2?family=${family}:wght@400;700&display=swap`;

      // √âvite de r√©-injecter le m√™me <link>
      const existing = document.querySelector(`link[data-gkdp-font="${CSS.escape(name)}"]`);
      if (existing) return Promise.resolve();

      return new Promise((resolve) => {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        link.setAttribute('data-gkdp-font', name);
        link.onload = () => { loaded.add(name); resolve(); };
        link.onerror = () => resolve(); // on ne bloque jamais l‚ÄôUI
        document.head.appendChild(link);

        // Fallback: si on ne re√ßoit pas onload (rare), on r√©sout quand m√™me rapidement.
        setTimeout(() => resolve(), 1500);
      });
    };

    // Optionnel : attendre explicitement que la police soit pr√™te avant un rendu canvas/export.
    window.ensureFontLoaded = async function ensureFontLoaded(fontName) {
      await window.loadFontOnDemand(fontName);
      if (document.fonts && document.fonts.load) {
        try { await document.fonts.load(`16px "${fontName}"`); } catch (_) {}
      }
    };
  })();
</script>



    <!-- üé¨ THREE.JS pour Mockup 3D -->
    <!-- üõí MARKETPLACE EARLY CAPTURE - DOIT √äTRE AVANT TOUT AUTRE SCRIPT -->
    <script>
    (function captureTemplateParamEarly() {
        try {
            const params = new URLSearchParams(window.location.search);
            const t = params.get("template") || params.get("img");
            if (t) {
                // Sauvegarder AVANT que OAuth ne nettoie l'URL
                sessionStorage.setItem("gkdp_template_url", t);
                window.__GKDP_TEMPLATE_URL__ = t;
                console.log("üõí [MARKETPLACE][EARLY] ‚úÖ Captured:", t);
            } else {
                console.log("üõí [MARKETPLACE][EARLY] No template param in URL");
            }
        } catch (e) {
            console.error("üõí [MARKETPLACE][EARLY] Error:", e);
        }
    })();
    </script>
    <script>
  // ‚úÖ Lazy-load Three.js : charg√© uniquement quand n√©cessaire
  window.ensureThree = function () {
    return new Promise((resolve, reject) => {
      if (window.THREE) return resolve(window.THREE);

      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
      s.async = true;
      s.onload = () => resolve(window.THREE);
      s.onerror = () => reject(new Error('Failed to load Three.js'));
      document.head.appendChild(s);
    });
  };
</script>
<script>
/**
 * ‚úÖ Lazy loader utilities (hybrid HTML + React)
 * - Loads heavy optional scripts only when user uses the feature.
 */
(function() {
  function loadScriptOnce(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector('script[data-gkdp-src="' + src + '"]')) return resolve(true);
      const s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.dataset.gkdpSrc = src;
      s.onload = () => resolve(true);
      s.onerror = () => reject(new Error('Failed to load ' + src));
      document.head.appendChild(s);
    });
  }

  window.GKDP = window.GKDP || {};

  // üìö Canva Designs grid (optional)
  window.GKDP.loadCanvaDesigns = async function() {
    // Afficher le container
    const container = document.getElementById("canva-designs-container");
    if (container) container.style.display = "block";
    await loadScriptOnce('./canva-designs-fetcher.js');
    // If the script exposes an init function, call it safely
    if (window.CanvaDesigns && typeof window.CanvaDesigns.init === 'function') {
      try { window.CanvaDesigns.init(); } catch(e) { console.warn('‚ö†Ô∏è [CANVA] init error:', e); }
    }
    return true;
  };
})();
</script>


    <script>
    (function() {
      'use strict';
      
      // ‚öôÔ∏è Configuration
      const CANVA_CONFIG = {
        CLIENT_ID: 'OC-AZnaRLvMwpXk', // CLIENT ID MIS √Ä JOUR
        SITE_ORIGIN: window.location.origin,
        CALLBACK_PATH: '/auth/callback.html',
        OAUTH_URL: 'https://www.canva.com/api/oauth/authorize',
        SCOPES: ['design:meta:read', 'design:content:read', 'asset:read']
      };

      console.log('üöÄ Initialisation Canva OAuth...');
      console.log('üìç Origin:', CANVA_CONFIG.SITE_ORIGIN);

      // =========================================================================
      // Utilitaires PKCE
      // =========================================================================
      
      function generateRandomString(length = 43) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
        const values = new Uint8Array(length);
        crypto.getRandomValues(values);
        return Array.from(values).map(v => chars[v % chars.length]).join('');
      }

      async function sha256(plain) {
        const encoder = new TextEncoder();
        const data = encoder.encode(plain);
        return await crypto.subtle.digest('SHA-256', data);
      }

      function base64urlencode(arrayBuffer) {
        const bytes = new Uint8Array(arrayBuffer);
        let str = '';
        bytes.forEach(byte => str += String.fromCharCode(byte));
        return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      async function generateCodeChallenge(verifier) {
        const hashed = await sha256(verifier);
        return base64urlencode(hashed);
      }

      // =========================================================================
      // Objet CanvaAuth global
      // =========================================================================
      
      window.CanvaAuth = {
        config: CANVA_CONFIG,

        /**
         * V√©rifie si l'utilisateur est authentifi√©
         */
        isAuthenticated() {
          const token = localStorage.getItem('canva_access_token');
          const expiry = parseInt(localStorage.getItem('canva_token_expiry') || '0', 10);
          
          if (!token || !expiry) {
            console.log('‚ùå Pas de token ou expiry');
            return false;
          }
          
          const isValid = Date.now() < (expiry - 300000); // 5min de marge
          // Log supprim√© pour √©viter le spam console
          return isValid;
        },

        /**
         * Obtient le token actuel
         */
        getToken() {
          if (!this.isAuthenticated()) return null;
          return localStorage.getItem('canva_access_token');
        },

        /**
         * Lance le processus de connexion OAuth
         */
        async initiateConnection() {
          console.log('üéØ D√©but connexion OAuth Canva...');
          
          try {
            // V√©rifier la config
            if (!CANVA_CONFIG.CLIENT_ID) {
              alert('‚ö†Ô∏è CLIENT_ID Canva non configur√© ! V√©rifiez le script.');
              console.error('‚ùå CLIENT_ID manquant ou invalide');
              return;
            }

            // 1. G√©n√©rer PKCE
            console.log('üîë G√©n√©ration PKCE...');
            const codeVerifier = generateRandomString(43);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            console.log('‚úÖ Verifier g√©n√©r√©:', codeVerifier.substring(0, 10) + '...');
            console.log('‚úÖ Challenge g√©n√©r√©:', codeChallenge.substring(0, 10) + '...');

            // 2. Stocker le verifier
            sessionStorage.setItem('pkce_code_verifier', codeVerifier);
            localStorage.setItem('canva_pkce_verifier', codeVerifier);
            console.log('üíæ Verifier stock√© dans sessionStorage et localStorage');

            // 3. Construire l'URL
            const redirectUri = CANVA_CONFIG.SITE_ORIGIN + CANVA_CONFIG.CALLBACK_PATH;
            const state = generateRandomString(32);
            sessionStorage.setItem('oauth_state', state);

            const params = new URLSearchParams({
              client_id: CANVA_CONFIG.CLIENT_ID,
              redirect_uri: redirectUri,
              response_type: 'code',
              scope: CANVA_CONFIG.SCOPES.join(' '),
              code_challenge: codeChallenge,
              code_challenge_method: 'S256',
              state: state
            });

            const authUrl = `${CANVA_CONFIG.OAUTH_URL}?${params.toString()}`;
            
            console.log('üîó Redirect URI:', redirectUri);
            console.log('üåê URL OAuth compl√®te:', authUrl);
            console.log('üöÄ Redirection vers Canva...');

            // 4. Rediriger
            window.location.href = authUrl;

          } catch (error) {
            console.error('‚ùå Erreur initiation OAuth:', error);
            alert('Erreur lors de la connexion √† Canva: ' + error.message);
          }
        },

        /**
         * D√©connexion
         */
        logout() {
          console.log('üö™ D√©connexion Canva...');
          // Tokens OAuth (diff√©rents noms selon les scripts)
          localStorage.removeItem('canva_access_token');
          localStorage.removeItem('canva_refresh_token');
          localStorage.removeItem('canva_token_expiry');
          localStorage.removeItem('canva_expires_at');
          // PKCE / state
          localStorage.removeItem('canva_pkce_verifier');
          sessionStorage.removeItem('pkce_code_verifier');
          sessionStorage.removeItem('oauth_state');

          // Nettoyer l'UI Canva (si pr√©sente)
          try {
            const c = document.getElementById('canva-designs-container');
            if (c) c.innerHTML = '';
          } catch (_) {}

          console.log('‚úÖ D√©connexion compl√®te');
        },

        /**
         * Test de connexion
         */
        async testConnection() {
          const token = this.getToken();
          if (!token) {
            console.error('‚ùå Pas de token pour tester');
            return false;
          }

          try {
            console.log('üß™ Test de connexion API Canva...');
            const response = await fetch('https://api.canva.com/rest/v1/users/me', {
              headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
              const data = await response.json();
              console.log('‚úÖ Connexion OK, utilisateur:', data);
              return true;
            } else {
              console.error('‚ùå Connexion √©chou√©e:', response.status);
              return false;
            }
          } catch (error) {
            console.error('‚ùå Erreur test connexion:', error);
            return false;
          }
        }
      };

      console.log('‚úÖ window.CanvaAuth cr√©√© et pr√™t');
      console.log('üì± Utilisez window.CanvaAuth.initiateConnection() pour connecter');
      
      // Test au chargement
      if (window.CanvaAuth.isAuthenticated()) {
        console.log('‚úÖ Utilisateur d√©j√† authentifi√©');
      } else {
        console.log('‚ÑπÔ∏è Utilisateur non authentifi√©');
      }

    })();
    </script>

    <!-- üîê SUPABASE - V√©rification abonnement -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    (async function checkSubscriptionStatus() {
        const SUPABASE_URL = 'https://kucwdaicplajljpfkzhu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1Y3dkYWljcGxhamxqcGZremh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MzMxMjQsImV4cCI6MjA3NzUwOTEyNH0.0IDHysD84_0ghjb-a4K0UkNrJbzdQBKUjm5mQbSfro8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Exposer globalement
        window.supabaseClient = supabase;
        window.dispatchEvent(new Event('supabase:ready'));
        console.log('‚úÖ [SUPABASE] Client initialis√©');
        
        // üîß FONCTION GLOBALE: V√©rifier si l'utilisateur est connect√©
        window.isUserLoggedIn = function() {
            return !!localStorage.getItem('userEmail');
        };
        
        // üîß FONCTION GLOBALE: Obtenir les cr√©dits restants
        window.getExportCredits = function() {
            const isPro = localStorage.getItem('userProfile') === 'pro';
            if (isPro) return Infinity;
            return parseInt(localStorage.getItem('exportCredits') || '0', 10);
        };
        
        // üîß FONCTION GLOBALE: D√©compter un export (async)
        window.decrementExportCredit = async function() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session || !session.user) {
                    console.log('Pas de session ‚Üí pas de d√©cr√©ment');
                    return false;
                }
                
                const userId = session.user.id;
                
                // 1) R√©cup√©rer les cr√©dits actuels
                const { data: profile, error: fetchError } = await supabase
                    .from('user_profiles')
                    .select('exports_available, total_exports_used, is_pro')
                    .eq('id', userId)
                    .single();
                
                if (fetchError || !profile) {
                    console.error('Erreur r√©cup√©ration cr√©dits', fetchError);
                    return false;
                }
                
                // Si PRO, pas de d√©cr√©ment
                if (profile.is_pro) {
                    console.log('‚úÖ [EXPORT] Utilisateur PRO - exports illimit√©s');
                    return true;
                }
                
                if (profile.exports_available <= 0) {
                    console.log('Plus de cr√©dits disponibles');
                    return false;
                }
                
                // 2) D√©cr√©menter dans Supabase
                const { error: updateError } = await supabase
                    .from('user_profiles')
                    .update({
                        exports_available: profile.exports_available - 1,
                        total_exports_used: (profile.total_exports_used || 0) + 1
                    })
                    .eq('id', userId);
                
                if (updateError) {
                    console.error('Erreur d√©cr√©ment export', updateError);
                    return false;
                }
                
                // 3) Mettre √† jour localStorage pour l'UI
                const newCredits = profile.exports_available - 1;
                localStorage.setItem('exportCredits', newCredits.toString());
                console.log('‚úÖ [EXPORT] Cr√©dit d√©compt√©:', newCredits, 'restants');
                return true;
            } catch (e) {
                console.error('‚ùå [EXPORT] Erreur:', e);
                return false;
            }
        };
        
        // üîß FONCTION GLOBALE: Rafra√Æchir les cr√©dits depuis Supabase
        window.refreshExportCredits = async function() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session || !session.user) return 0;
                
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('exports_available, is_pro')
                    .eq('id', session.user.id)
                    .single();
                
                if (data) {
                    localStorage.setItem('exportCredits', data.exports_available.toString());
                    if (data.is_pro) localStorage.setItem('userProfile', 'pro');
                    return data.exports_available;
                }
            } catch (e) {
                console.error('‚ùå [REFRESH] Erreur:', e);
            }
            return 0;
        };
        
        try {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session && session.user) {
                console.log('üë§ [AUTH] Utilisateur connect√©:', session.user.email);
                
                // Chercher le profil par ID (plus fiable)
                let { data: userData, error } = await supabase
                    .from('user_profiles')
                    .select('is_pro, exports_available, subscription_type')
                    .eq('id', session.user.id)
                    .single();
                
                // Si pas de profil trouv√©, le cr√©er automatiquement (inscription sociale)
                if (error || !userData) {
                    console.log('üìù [AUTH] Cr√©ation profil FREE pour nouvel utilisateur social...');
                    
                    const { error: insertError } = await supabase
                        .from('user_profiles')
                        .insert({
                            id: session.user.id,
                            email: session.user.email,
                            is_pro: false,
                            exports_available: 3,
                            total_exports_used: 0
                        });
                    
                    if (insertError) {
                        console.error('‚ùå [AUTH] Erreur cr√©ation profil:', insertError);
                    } else {
                        console.log('‚úÖ [AUTH] Profil FREE cr√©√© avec 3 exports!');
                        userData = { is_pro: false, exports_available: 3, subscription_type: null };
                    }
                }
                
                console.log('üìä [AUTH] Donn√©es utilisateur:', userData);
                
                if (userData) {
                    if (userData.is_pro === true) {
                        localStorage.setItem('userProfile', 'pro');
                    } else {
                        localStorage.removeItem('userProfile');
                    }
                    if (userData.subscription_type) {
                        localStorage.setItem('subscription_type', userData.subscription_type);
                    }
                    localStorage.setItem('exportCredits', (userData.exports_available || 0).toString());
                    console.log('‚úÖ [AUTH] Cr√©dits exports:', userData.exports_available);
                }
                
                localStorage.setItem('userEmail', session.user.email);
            } else {
                console.log('‚ÑπÔ∏è [AUTH] Aucun utilisateur connect√©');
                localStorage.removeItem('userProfile');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('exportCredits');
            }
        } catch (err) {
            console.error('‚ùå [AUTH] Erreur:', err);
        }
    })();
    </script>

    <!-- üíæ DESIGN SAVE SYSTEM - Sauvegarde pour redirection inscription -->
    <script>
    (function() {
        'use strict';
        
        const STORAGE_KEY = 'gkdp_saved_design';
        const TEMP_STORAGE_KEY = 'gkdp_temp_design'; // Pour les non-connect√©s avant inscription
        const ACTIVE_TEMPLATE_KEY = 'gkdp_active_template_url'; // Template actuellement actif (Marketplace)
        const LIBRARY_KEY = 'gkdp_design_library_v1'; // Biblioth√®que de designs (local)

        // üéØ Template actif (permet d'√©viter de restaurer un ancien design sur un nouveau template)
        window.setActiveTemplateUrl = function(url) {
            try {
                if (!url) {
                    localStorage.removeItem(ACTIVE_TEMPLATE_KEY);
                    return;
                }
                localStorage.setItem(ACTIVE_TEMPLATE_KEY, url);
            } catch (e) {
                console.error('‚ùå [ACTIVE TEMPLATE] Error:', e);
            }
        };

        window.getActiveTemplateUrl = function() {
            try {
                return localStorage.getItem(ACTIVE_TEMPLATE_KEY) || null;
            } catch (e) {
                return null;
            }
        };

        // üìö Design Library (localStorage) ‚Äî CRUD
        function readLibrary() {
            try {
                const raw = localStorage.getItem(LIBRARY_KEY);
                const arr = raw ? JSON.parse(raw) : [];
                return Array.isArray(arr) ? arr : [];
            } catch (e) {
                console.error('‚ùå [LIBRARY] read error:', e);
                return [];
            }
        }

        function writeLibrary(items) {
            try {
                localStorage.setItem(LIBRARY_KEY, JSON.stringify(items || []));
                return true;
            } catch (e) {
                console.error('‚ùå [LIBRARY] write error:', e);
                return false;
            }
        }

        function genId() {
            try {
                return (crypto && crypto.randomUUID) ? crypto.randomUUID() : ('id_' + Date.now() + '_' + Math.random().toString(16).slice(2));
            } catch (e) {
                return 'id_' + Date.now() + '_' + Math.random().toString(16).slice(2);
            }
        }

        window.gkdpListDesigns = function() {
            const items = readLibrary();
            // Tri: r√©cemment utilis√©s d'abord
            return items.sort((a,b) => (b.lastUsedAt || b.updatedAt || b.createdAt || '').localeCompare(a.lastUsedAt || a.updatedAt || a.createdAt || ''));
        };

        window.gkdpGetDesign = function(id) {
            const items = readLibrary();
            return items.find(d => d && d.id === id) || null;
        };

        // Upsert: cr√©e si pas d'id, sinon update
        window.gkdpUpsertDesign = function(payload) {
            try {
                const items = readLibrary();
                const now = new Date().toISOString();
                const id = payload && payload.id ? payload.id : genId();

                const templateUrl = (payload && payload.templateUrl) || window.getActiveTemplateUrl?.() || null;
                const title = (payload && payload.title) || 'Untitled design';

                const designData = (payload && payload.designData) ? payload.designData : null;

                const existingIdx = items.findIndex(d => d && d.id === id);
                const record = {
                    id,
                    templateUrl,
                    title,
                    designData,
                    createdAt: existingIdx >= 0 ? (items[existingIdx].createdAt || now) : now,
                    updatedAt: now,
                    lastUsedAt: payload && payload.lastUsedAt ? payload.lastUsedAt : (existingIdx >= 0 ? (items[existingIdx].lastUsedAt || null) : null)
                };

                if (existingIdx >= 0) items[existingIdx] = { ...items[existingIdx], ...record };
                else items.unshift(record);

                writeLibrary(items);
                return record;
            } catch (e) {
                console.error('‚ùå [LIBRARY] upsert error:', e);
                return null;
            }
        };

        window.gkdpTouchDesign = function(id) {
            try {
                const items = readLibrary();
                const idx = items.findIndex(d => d && d.id === id);
                if (idx < 0) return null;
                const now = new Date().toISOString();
                items[idx] = { ...items[idx], lastUsedAt: now, updatedAt: now };
                writeLibrary(items);
                return items[idx];
            } catch (e) {
                return null;
            }
        };

        window.gkdpDeleteDesign = function(id) {
            try {
                const items = readLibrary();
                const next = items.filter(d => d && d.id !== id);
                writeLibrary(next);
                return true;
            } catch (e) {
                return false;
            }
        };

        
        // üíæ Sauvegarder le design TEMPORAIREMENT (avant redirection vers inscription)
        window.saveTempDesign = function(designData) {
            try {
                const dataToSave = {
                    ...designData,
                    templateUrl: (designData && designData.templateUrl) ? designData.templateUrl : (window.getActiveTemplateUrl ? window.getActiveTemplateUrl() : null),
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem(TEMP_STORAGE_KEY, JSON.stringify(dataToSave));
                console.log('üíæ [TEMP SAVE] ‚úÖ Design temporaire sauvegard√©!');
                return true;
            } catch (e) {
                console.error('üíæ [TEMP SAVE] Erreur:', e);
                return false;
            }
        };
        
        // üíæ Charger le design temporaire (apr√®s connexion)
        window.loadTempDesign = function() {
            try {
                const saved = localStorage.getItem(TEMP_STORAGE_KEY);
                if (!saved) return null;
                console.log('üíæ [TEMP LOAD] ‚úÖ Design temporaire trouv√©!');
                return JSON.parse(saved);
            } catch (e) {
                console.error('üíæ [TEMP LOAD] Erreur:', e);
                return null;
            }
        };
        
        // üíæ Effacer le design temporaire
        window.clearTempDesign = function() {
            localStorage.removeItem(TEMP_STORAGE_KEY);
            console.log('üíæ [TEMP CLEAR] Design temporaire effac√©');
        };
        
        // üíæ Sauvegarder le design permanent (pour utilisateurs connect√©s)
        window.saveDesignPermanent = function(designData) {
            if (!window.isUserLoggedIn || !window.isUserLoggedIn()) {
                return false;
            }
            try {
                const dataToSave = {
                    ...designData,
                    templateUrl: (designData && designData.templateUrl) ? designData.templateUrl : (window.getActiveTemplateUrl ? window.getActiveTemplateUrl() : null),
                    savedAt: new Date().toISOString(),
                    userEmail: localStorage.getItem('userEmail')
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                console.log('üíæ [PERM SAVE] ‚úÖ Design permanent sauvegard√©!');
                return true;
            } catch (e) {
                console.error('üíæ [PERM SAVE] Erreur:', e);
                return false;
            }
        };
        
        // üíæ Charger le design permanent
        window.loadPermanentDesign = function() {
            if (!window.isUserLoggedIn || !window.isUserLoggedIn()) {
                return null;
            }
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return null;
                const data = JSON.parse(saved);
                if (data.userEmail !== localStorage.getItem('userEmail')) {
                    return null;
                }
                console.log('üíæ [PERM LOAD] ‚úÖ Design permanent trouv√©!');
                return data;
            } catch (e) {
                console.error('üíæ [PERM LOAD] Erreur:', e);
                return null;
            }
        };
        
        // üíæ Sauvegarder le design actuel dans la biblioth√®que
        window.gkdpSaveCurrentDesign = function() {
            try {
                // R√©cup√©rer le design actuel depuis React
                if (!window.getCurrentDesignData) {
                    console.error('‚ùå [LIBRARY SAVE] getCurrentDesignData manquant');
                    alert('Erreur: impossible de r√©cup√©rer le design actuel');
                    return false;
                }

                const data = window.getCurrentDesignData();
                if (!data) {
                    console.error('‚ùå [LIBRARY SAVE] Aucun design √† sauvegarder');
                    alert('Aucun design √† sauvegarder');
                    return false;
                }

                // Demander un titre
                const title = prompt('Nom du design:', data.title || 'Mon design');
                if (!title) return false; // Annul√©

                // Cr√©er l'objet design
                const design = {
                    id: 'dsg_' + Date.now(),
                    title: title,
                    templateUrl: window.getActiveTemplateUrl?.() || null,
                    designData: data,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastUsedAt: new Date().toISOString()
                };

                // Ajouter √† la biblioth√®que
                const result = window.gkdpUpsertDesign(design);
                
                if (result) {
                    console.log('üíæ [LIBRARY SAVE] Design sauvegard√©:', result);
                    alert('‚úÖ Design sauvegard√© !');
                    return true;
                } else {
                    console.error('‚ùå [LIBRARY SAVE] √âchec de la sauvegarde');
                    alert('‚ùå Erreur lors de la sauvegarde');
                    return false;
                }

            } catch (e) {
                console.error('‚ùå [LIBRARY SAVE] Erreur:', e);
                alert('‚ùå Erreur: ' + e.message);
                return false;
            }
        };
        
        console.log('üíæ [DESIGN SAVE] Syst√®me initialis√©');
    })();
    </script>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
<script src="js/canva-integration.js" defer></script>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "t09tdy9nqm");
</script>
    <style>html, body {
    height: 100%;
    overflow-y: scroll; /* FIX JUMP: force consistent scrollbar to avoid layout shift */
}

        /* üíæ Animations pour les notifications */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInCenter {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        #kdp-generator-container {
            min-height: 90vh; /* R√©serve l'espace pour l'application React pendant son chargement pour √©viter le saut de page */
    display: flex;
    align-items: center;
    justify-content: center;}

  .language-selector {
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, .1);
    padding: 3px;
  }

  .lang-btn {
    padding: 6px 10px;
    border: none;
    background: transparent;
    border-radius: 16px;
    cursor: pointer;
    transition: .3s;
    font-weight: 500;
    font-size: .8rem;
  }

  .lang-btn.active {
    background: #FF9900;
    color: #fff
  }

        .header-nav {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 15px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-wrap: wrap;
        }

        .logo-nav {
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: white;
            flex-shrink: 0;
        }

        .logo-nav img {
            height: 40px;
            width: auto;
        }

        .logo-nav span {
            font-size: 1.3rem;
            font-weight: 700;
            color: #FF9900;
        }

        .nav-links {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 10px 14px;
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.95rem;
        }

        .nav-links a:hover {
            color: #FF9900;
            background: rgba(255, 153, 0, 0.1);
        }

        .express-nav-btn {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
            border-radius: 8px !important;
        }

        .express-nav-btn:hover {
            background: linear-gradient(135deg, #0d9488, #047857) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4) !important;
        }

        .f-exp-gene {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            padding: 8px 10px;
            border-radius: 5px;
        }

        .f-exp-gene:hover {
            background: linear-gradient(135deg, #0d9488, #047857) !important;
            color: #FFFFFF;
        }

        .express-nav-btn::before,
        .f-exp-gene::before {
            content: "‚ö°";
            margin-right: 4px;
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 999;
            padding: 80px 20px 20px;
            overflow-y: auto;
        }

        .mobile-menu.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .social-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .social-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .social-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .social-link.youtube {
            background: linear-gradient(135deg, #FF0000, #CC0000);
        }

        .social-link.facebook {
            background: linear-gradient(135deg, #1877F2, #0866D3);
        }

        .social-link.instagram {
            background: linear-gradient(135deg, #E4405F, #C13584, #8A2BE2);
        }

        .social-link.pinterest {
            background: linear-gradient(135deg, #BD081C, #E60023);
        }

        .social-link.tiktok {
            background: linear-gradient(135deg, #000000, #FF0050, #00F2EA);
        }

        .social-link.linkedin {
            background: linear-gradient(135deg, #0A66C2, #004182);
        }        

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mobile-menu-links {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
        }

        .mobile-menu-links a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            padding: 15px 20px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
        }

        .mobile-menu-links a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .mobile-menu-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
        }

         .generator-layout {
    display: grid;
    grid-template-columns: 340px 1fr 300px;
    gap: 20px;
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
}

        .preview-zone {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 600px;
            height: fit-content;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
            gap: 15px;
        }

        .preview-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .zoom-btn {
            background: #6b7280;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .zoom-btn:hover {
            background: #4b5563;
            transform: scale(1.05);
        }

        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 12px;
            padding: 40px 20px;
            overflow: visible;
            position: relative;
            min-height: 400px;
        }

        .canvas-4k {
            border: 3px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            background: white;
            transition: all 0.3s ease;
        }

        .canvas-4k:hover {
            box-shadow: 0 15px 60px rgba(0, 0, 0, 0.25);
            transform: scale(1.02);
        }

        .position-labels {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 40px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 20px;
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            font-weight: 600;
            font-size: 0.875rem;
            color: #374151;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .dimensions-overlay {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            backdrop-filter: blur(5px);
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            height: fit-content;
            max-height: none;
            overflow-y: visible;
        }

        

        /* UX: Left sidebar stays visible while scrolling */
        .sticky-left-panel {
            position: sticky;
            top: 95px; /* adjust if header height changes */
            align-self: start;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }
.sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quality-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 3px 15px rgba(139, 92, 246, 0.4);
        }

        .validation-smart {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .validation-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .validation-score {
            padding: 16px 20px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .score-excellent {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .score-tres-bon {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .score-acceptable {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .score-problematique {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .validation-alerts {
            padding: 16px 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .alert-excellent {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: #065f46;
        }

        .alert-good {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: #1e3a8a;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            color: #92400e;
        }

        .alert-critical {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #991b1b;
        }

        .alert-info {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            color: #3730a3;
        }

        .alert-icon {
            font-size: 1rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .validation-tips {
            background: #f8fafc;
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
        }

        .tips-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tip-item {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .no-analysis {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        /* Canva Spinners */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        .spinner-small {
            animation: spin 1s linear infinite;
        }

        .format-alert-critical {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            border: 2px solid #b91c1c;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.3);
        }

        .format-alert-critical .alert-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .format-alert-critical .alert-content {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        @media (max-width: 1400px) {
            .generator-layout {
                grid-template-columns: 300px 1fr 280px;
                gap: 15px;
                padding: 15px;
            }
        }

        @media (max-width: 1250px) {
            .generator-layout {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px;
            }

            .preview-zone {
                min-height: 500px;
                order: 2;
            }

            .sidebar {
                max-height: none;
                order: 1;
            }

            .sidebar:last-child {
                order: 3;
            }
        
            .sticky-left-panel {
                position: static;
                max-height: none;
                overflow: visible;
            }
}

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
    .language-selector {
      top: 22.5px;
      right: 60px
    }

            .nav-links {
                display: none;
            }

            .mobile-menu-toggle {
                display: block;
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 8px;
                margin-left: auto;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-toggle {
                display: none;
            }
        }
        .feedback-section {
            width: 100%;
            padding: 4rem 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }
        .feedback-section h3 {
            color: #1e293b;
            font-weight: 900;
            font-size: 48px;
            line-height: 1;
        }
        .feedback-section p {
            margin-top: 16px;
            font-size: 18px;
            color: #4B5563;
        }
        .feedback-section button {
            background: #10B981;
            color: #FFFFFF;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            max-width: 250px;
            width: 100%;
            font-weight: 600;
            margin-top: 40px;
            transition: 0.3s;
        }
        .feedback-section button:hover {
            background: #16A34A;
        }
        @media(max-width:769px) {
            .feedback-section h3 {
            color: #1e293b;
            font-weight: 900;
            font-size: 36px;
            line-height: 1;
        }
        }        
    
.notranslate { unicode-bidi: plaintext; }
/* ============================================================
   STYLES POUR L'IMPORT CANVA DESIGNS
   ============================================================ */

/* Conteneur de la grille de designs */
#canva-designs-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
  max-height: 600px;
  overflow-y: auto;
  padding: 0.5rem;
}

/* Scrollbar personnalis√©e */
#canva-designs-container::-webkit-scrollbar {
  width: 8px;
}

#canva-designs-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

#canva-designs-container::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}

#canva-designs-container::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* Carte de design */
.canva-design-item {
  border: 2px solid #e5e7eb;
  border-radius: 0.5rem;
  padding: 1rem;
  transition: all 0.2s ease;
  cursor: pointer;
  background: white;
}

.canva-design-item:hover {
  border-color: #3b82f6;
  box-shadow: 0 4px 12px -1px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.canva-design-item.selected {
  border-color: #10b981;
  background-color: #f0fdf4;
}

/* Zone de pr√©visualisation */
.canva-design-preview {
  width: 100%;
  height: 150px;
  background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
  border-radius: 0.375rem;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 0.75rem;
}

.canva-design-preview img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

/* Info du design */
.canva-design-info {
  margin-top: 0.75rem;
}

.canva-design-title {
  font-weight: 600;
  font-size: 0.875rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: #1f2937;
  margin-bottom: 0.25rem;
}

.canva-design-size {
  font-size: 0.75rem;
  color: #6b7280;
  margin-bottom: 0.75rem;
}

/* Boutons d'import */
.btn-import-design {
  font-size: 0.75rem;
  padding: 0.375rem 0.75rem;
  border-radius: 0.375rem;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
  font-weight: 500;
}

.btn-import-design:hover {
  transform: scale(1.05);
}

.btn-import-design:active {
  transform: scale(0.95);
}

.btn-import-design:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* Animation de chargement */
@keyframes pulse-loading {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.animate-pulse {
  animation: pulse-loading 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* ========================================
   RESPONSIVE DESIGN COMPLET
   ======================================== */



/* Tablettes */
@media (max-width: 992px) {
    /* .generator-layout {
        grid-template-columns: 280px 1fr;
        gap: 15px;
    }
     */
    .preview-zone {
        padding: 15px;
    }
    
    .preview-title {
        font-size: 1.25rem;
    }
}

/* Mobile - Portrait */
@media (max-width: 768px) {
    /* .generator-layout {
        grid-template-columns: 1fr;
        gap: 15px;
        padding: 10px;
    }
     */
    /* Sidebars en pleine largeur sur mobile */
    .sidebar {
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 0;
    }
    
    .sidebar-section {
        padding: 15px;
    }
    
    .sidebar-title {
        font-size: 1rem;
    }
    
    .preview-zone {
        padding: 15px;
        min-height: auto;
    }
    
    .preview-title {
        font-size: 1.1rem;
    }
    
    .preview-controls {
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .zoom-btn {
        width: 32px;
        height: 32px;
        font-size: 25px;
    }
    
    .canvas-container {
        min-height: 300px;
        padding: 10px;
    }
    
    /* Ajuster les formulaires sur mobile */
    input[type="text"],
    input[type="number"],
    select,
    textarea {
        font-size: 16px !important; /* √âvite le zoom iOS */
        padding: 10px;
        width: 100%;
    }
    
    button {
        min-height: 44px; /* Taille tactile optimale */
        padding: 10px 16px;
    }
    
    /* Guide rapide - texte plus petit sur mobile */
    .sidebar-section .text-sm {
        font-size: 0.875rem;
    }
    
    .sidebar-section .text-xs {
        font-size: 0.75rem;
    }
    
    /* Canvas settings */
    .canvas-settings {
        padding: 12px;
    }
    
    .canvas-settings h3 {
        font-size: 1rem;
    }
    
    /* Espacements r√©duits sur mobile */
    .space-y-4 > * + * {
        margin-top: 0.75rem;
    }
    
    .space-y-3 > * + * {
        margin-top: 0.5rem;
    }
}

/* Petit mobile */
@media (max-width: 480px) {
    .generator-layout {
        padding: 8px;
        gap: 12px;
    }
    
    .sidebar-section {
        padding: 12px;
    }
    
    .sidebar-title {
        font-size: 0.95rem;
    }
    
    .preview-zone {
        padding: 12px;
        border-radius: 8px;
    }
    
    .preview-title {
        font-size: 1rem;
        flex-direction: column;
        gap: 5px;
        align-items: flex-start;
    }
    
    .preview-controls {
        width: 100%;
        justify-content: space-between;
    }
    
    .canvas-container {
        min-height: 250px;
    }
    
    /* Textes plus petits */
    body {
        font-size: 14px;
    }
    
    h1 {
        font-size: 1.5rem;
    }
    
    h2 {
        font-size: 1.25rem;
    }
    
    h3 {
        font-size: 1.1rem;
    }
    
    /* Select et inputs plus grands pour tactile */
    select,
    input[type="text"],
    input[type="number"] {
        font-size: 16px !important;
        padding: 12px;
        min-height: 44px;
    }
    
    /* Boutons empil√©s et plus grands */
    .button-group {
        flex-direction: column;
        width: 100%;
    }
    
    .button-group button {
        width: 100%;
        min-height: 44px;
    }
    
    /* Am√©liorer l'espacement du guide */
    .sidebar-section .space-y-3 > * + * {
        margin-top: 0.75rem;
    }
    
    /* Texte du guide plus lisible */
    .sidebar-section p {
        line-height: 1.5;
    }
}

/* Tr√®s petit mobile */
@media (max-width: 360px) {
    .generator-layout {
        padding: 5px;
    }
    
    .sidebar-section {
        padding: 10px;
    }
    
    .preview-zone {
        padding: 10px;
    }
    
    .preview-title {
        font-size: 0.9rem;
    }
    
    input[type="text"],
    input[type="number"],
    select {
        font-size: 14px !important;
        padding: 10px;
    }
    
    button {
        padding: 8px 12px;
        font-size: 14px;
    }
    
    /* Texte encore plus compact */
    .sidebar-section .text-sm {
        font-size: 0.8125rem;
    }
    
    .sidebar-section .text-xs {
        font-size: 0.6875rem;
    }
}

/* Pr√©venir les d√©bordements sur tous les √©crans */
* {
    box-sizing: border-box;
}

img {
    max-width: 100%;
    height: auto;
}

/* Gestion du d√©bordement de texte */
.sidebar-section p,
.sidebar-section div {
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
}

/* Am√©lioration tactile globale */
@media (hover: none) and (pointer: coarse) {
    /* Appareils tactiles */
    button,
    select,
    input,
    a {
        min-height: 44px;
        min-width: 44px;
    }
    
    /* Espacements plus g√©n√©reux pour le tactile */
    .sidebar-section {
        padding: 16px;
    }
    
    /* √âviter les hover effects sur tactile */
    button:hover,
    a:hover {
        transform: none;
    }
}

/* Responsive */
@media (max-width: 768px) {
  #canva-designs-container {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.75rem;
    max-height: 400px;
  }
  
  .canva-design-preview {
    height: 120px;
  }
  
  .canva-design-title {
    font-size: 0.8125rem;
  }
}

@media (max-width: 480px) {
  #canva-designs-container {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* üìö MOCKUP 3D STYLES */
.mockup-3d-container {
    perspective: 1500px;
    perspective-origin: center center;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
    background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
    border-radius: 12px;
    padding: 40px;
    position: relative;
    overflow: hidden;
}

.mockup-3d-container::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    height: 40%;
    background: radial-gradient(ellipse at center, rgba(255,255,255,0.1) 0%, transparent 70%);
    pointer-events: none;
}

.book-3d {
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.5s ease;
}

.book-3d.perspective {
    transform: rotateY(-25deg) rotateX(5deg);
}

.book-3d.flat {
    transform: rotateY(-5deg) rotateX(2deg);
}

.book-3d.standing {
    transform: rotateY(-35deg) rotateX(10deg);
}

.book-3d:hover {
    transform: rotateY(-15deg) rotateX(3deg);
}

.book-front {
    position: relative;
    box-shadow: 
        5px 5px 20px rgba(0,0,0,0.4),
        inset -2px 0 10px rgba(0,0,0,0.2);
    border-radius: 0 3px 3px 0;
    overflow: hidden;
    backface-visibility: hidden;
}

.book-spine {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    transform-origin: left center;
    transform: rotateY(-90deg);
    background: linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
}

.book-spine-text {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    color: white;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-height: 90%;
    padding: 10px 5px;
}

.book-back {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    transform: translateZ(-20px);
    background: #1a1a1a;
    border-radius: 3px 0 0 3px;
}

.mockup-3d-controls {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    background: rgba(255,255,255,0.1);
    padding: 8px 12px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
}

.mockup-3d-controls button {
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
}

.mockup-3d-controls button.active {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.mockup-3d-controls button:not(.active) {
    background: rgba(255,255,255,0.1);
    color: white;
}

.mockup-3d-controls button:hover:not(.active) {
    background: rgba(255,255,255,0.2);
}

.view-toggle {
    display: flex;
    background: #e5e7eb;
    border-radius: 8px;
    padding: 3px;
    gap: 2px;
}

.view-toggle button {
    padding: 6px 16px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}

.view-toggle button.active {
    background: white;
    color: #1f2937;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.view-toggle button:not(.active) {
    background: transparent;
    color: #6b7280;
}

.view-toggle button:hover:not(.active) {
    color: #374151;
}

@media (max-width:480px) {
    .language-selector {
      right: 60px;
      padding: 2px;
      top: 27px
    }

    .lang-btn {
      padding: 4px 8px;
      font-size: .7rem
    }
}

</style>
<!-- ‚úÖ Canva designs fetcher is now lazy-loaded (see GKDP.loadCanvaDesigns) -->
<!-- React App CSS -->

</head>

<body>
 <header class="header-nav notranslate">
  <div class="nav-container">

    <!-- Logo -->
    <a href="./index.html" class="logo-nav">
      <img src="logo-gabarit-kdp-site-web.png" alt="GabaritKDP Logo">
      <span>GabaritKDP</span>
    </a>

    <!-- Menu Hamburger - Mobile -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Language Selector -->
    <div class="language-selector">
      <button class="lang-btn" data-lang="fr" onclick="switchLanguage('fr')">FR</button>
      <button class="lang-btn active" data-lang="en" onclick="switchLanguage('en')">US</button>
    </div>

    <!-- Navigation Desktop -->
    <nav class="nav-links">
      <a href="./index.html" data-fr="üè† Accueil" data-en="üè† Home">üè† Home</a>

      <a href="./dashboard.html"
         data-fr="üìä Tableau de bord"
         data-en="üìä Dashboard">üìä Dashboard</a>

      <a href="./generator.html"
   class="express-nav-btn"
   data-fr=" G√©n√©rateur Express"
   data-en=" Express Generator">
   Express Generator
</a>

      <a href="./generator-magic.html"
         data-fr="ü™Ñ G√©n√©rateur Magique"
         data-en="ü™Ñ Magic Generator">ü™Ñ Magic Generator</a>

      <a href="./marketplace.html"
         data-fr="üìö Templates"
         data-en="üìö Templates">üìö Templates</a>

      <a href="./inscription.html"
         data-fr="üìù Inscription"
         data-en="üìù Sign Up">üìù Sign Up</a>

      <a href="./connexion.html"
         data-fr="üîê Connexion"
         data-en="üîê Login">üîê Login</a>
    </nav>
  </div>

  <!-- Menu Mobile -->
  <div class="mobile-menu" id="mobileMenu">
    <button class="mobile-menu-close" onclick="toggleMobileMenu()">
      <i class="fas fa-times"></i>
    </button>

    <div class="mobile-menu-links">
      <a href="./index.html" data-fr="üè† Accueil" data-en="üè† Home">üè† Home</a>
      <a href="./dashboard.html" data-fr="üìä Tableau de bord" data-en="üìä Dashboard">üìä Dashboard</a>
      <a href="./generator.html" data-fr="G√©n√©rateur Express" data-en="Express Generator">Express Generator</a>
      <a href="./generator-magic.html" data-fr="ü™Ñ G√©n√©rateur Magique" data-en="ü™Ñ Magic Generator">ü™Ñ Magic Generator</a>
      <a href="./marketplace.html" data-fr="üìö Templates" data-en="üìö Templates">üìö Templates</a>
      <a href="./inscription.html" data-fr="üìù Inscription" data-en="üìù Sign Up">üìù Sign Up</a>
      <a href="./connexion.html" data-fr="üîê Connexion" data-en="üîê Login">üîê Login</a>
    </div>
  </div>
  <style>
  /* Safety defaults: desktop shows nav-links; mobile menu hidden */
  .mobile-menu { display: none; }
  .mobile-menu-toggle { display: none; }

  /* Mobile breakpoint */
  @media (max-width: 768px) {
    .nav-links { display: none !important; }
    .mobile-menu-toggle { display: inline-flex !important; }
  }

  /* When opened via JS */
  .mobile-menu.open { display: block; }
</style>

<script>
  function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    if (!menu) return;
    menu.classList.toggle('open');
  }
</script>

</header>

<!-- React Generator -->
<div id="kdp-react-root"></div>

<!-- üé® Bouton pour charger Canva -->
<div style="margin: 20px; text-align: center;">
  <button onclick="loadCanvaDesignsOnDemand()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
    üé® Load Canva Designs
  </button>
</div>

<script>
async function loadCanvaDesignsOnDemand() {
  if (window.GKDP && window.GKDP.loadCanvaDesigns) {
    await window.GKDP.loadCanvaDesigns();
    console.log("‚úÖ Canva loaded");
  }
}
</script>

<!-- üé® Container Canva (en dehors de React pour compatibilit√© legacy) -->
<div id="canva-designs-container" style="display: none; min-height: 150px; margin: 20px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
  <!-- La grille Canva sera inject√©e ici par canva-designs-fetcher.js -->
</div>



<!-- ‚ùå Removed legacy in-browser Babel generator (migrated to React/Vite) -->

<script id="lang-switch-module">
(function(){
  const DEFAULT='en'; const VALID=new Set(['en','fr']);
  function getSavedLang(){
    return (localStorage.getItem('preferredLanguage')||document.documentElement.lang||DEFAULT).toLowerCase();
  }
  function setLang(lang){
    lang=(lang||'').toLowerCase(); if(!VALID.has(lang)) lang=DEFAULT;
    document.documentElement.setAttribute('lang',lang);
    try{localStorage.setItem('preferredLanguage',lang);}catch(_){}
    const nodes=document.querySelectorAll('[data-fr],[data-en]');
    nodes.forEach(el=>{
      const val=el.getAttribute('data-'+lang); if(val==null) return;
      if(el.tagName==='META') el.setAttribute('content',val);
      else if(el.tagName==='TITLE') el.textContent=val;
      else if(/[<&]/.test(val)) el.innerHTML=val;
      else el.textContent=val;
    });
    document.querySelectorAll('.lang-btn').forEach(btn=>{
      const b=(btn.getAttribute('data-lang')||'').toLowerCase();
      btn.classList.toggle('active', b===lang);
    });
    window.currentLanguage=lang;
    if(typeof window.reactSetLanguage==='function'){ try{ window.reactSetLanguage(lang); }catch(e){} }
  }
  window.switchLanguage=setLang; window.applyLanguage=setLang;
  document.addEventListener('DOMContentLoaded',function(){
    setLang(getSavedLang());
    document.querySelectorAll('.lang-btn').forEach(btn=>{
      btn.addEventListener('click',function(){ setLang(this.getAttribute('data-lang')||DEFAULT); });
    });
  });
})();
</script>


<script>
(function () {
  window.showFeedbackPrompt = function (lang) {
    try {
      const isEN = (lang || '').toLowerCase().startsWith('en');
      const TALLY_EN = 'https://tally.so/r/3yB7pd';
      const TALLY_FR = 'https://tally.so/r/mY2DJN';
      const redirectUrl = isEN ? TALLY_EN : TALLY_FR;
      const L = isEN
        ? { title: 'How was your export?', subtitle: 'Give us a quick 1‚Äì5 star rating', later: 'Maybe later', send: 'Send rating' }
        : { title: 'Votre export s‚Äôest bien pass√© ?', subtitle: 'Donnez-nous une note rapide 1‚Äì5 √©toiles', later: 'Plus tard', send: 'Envoyer la note' };
      const style = document.createElement('style');
      style.textContent = '.gkdp-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999}.gkdp-modal{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);max-width:520px;width:92%;padding:24px}.gkdp-title{font-weight:800;font-size:20px;color:#111827}.gkdp-sub{margin-top:6px;color:#6B7280;font-size:14px}.gkdp-stars{display:flex;gap:8px;justify-content:center;align-items:center;margin:18px 0}.gkdp-star{cursor:pointer;font-size:28px;line-height:1;transition:transform .15s ease}.gkdp-star:hover{transform:scale(1.1)}.gkdp-actions{display:flex;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap}.gkdp-btn{border-radius:10px;padding:10px 14px;font-weight:600;border:1px solid #e5e7eb;cursor:pointer}.gkdp-btn-primary{background:#10B981;color:#fff;border-color:#10B981}.gkdp-btn-primary:disabled{opacity:.6;cursor:not-allowed}.gkdp-footer{margin-top:10px;text-align:center;color:#9CA3AF;font-size:12px}';
      document.head.appendChild(style);
      const root = document.createElement('div');
      root.className = 'gkdp-modal-backdrop';
      root.innerHTML = '<div class="gkdp-modal" role="dialog" aria-modal="true" aria-label="feedback">'
        + '<div class="gkdp-title">'+L.title+'</div>'
        + '<div class="gkdp-sub">'+L.subtitle+'</div>'
        + '<div class="gkdp-stars" aria-label="rating">'
        + [1,2,3,4,5].map(n=>'<span class="gkdp-star" data-value="'+n+'" aria-label="'+n+'">‚òÜ</span>').join('')
        + '</div>'
        + '<div class="gkdp-actions">'
        + '<button type="button" class="gkdp-btn" data-action="later">'+L.later+'</button>'
        + '<button type="button" class="gkdp-btn gkdp-btn-primary" data-action="send" disabled>'+L.send+'</button>'
        + '</div>'
        + '<div class="gkdp-footer">GabaritKDP</div>'
        + '</div>';
      document.body.appendChild(root);
      const stars = Array.from(root.querySelectorAll('.gkdp-star'));
      const btnSend = root.querySelector('[data-action="send"]');
      const btnLater = root.querySelector('[data-action="later"]');
      let current = 0;
      const paint = (n)=>{ stars.forEach((s,i)=>{ s.textContent = i<n ? '‚òÖ' : '‚òÜ'; s.style.color = i<n ? '#F59E0B' : '#9CA3AF'; }); btnSend.disabled = n===0; };
      stars.forEach(s=>{
        s.addEventListener('mouseenter',()=>paint(+s.dataset.value));
        s.addEventListener('mouseleave',()=>paint(current));
        s.addEventListener('click',()=>{ current=+s.dataset.value; paint(current); });
      });
      function cleanup(){ try{ root.remove(); style.remove(); }catch(_){} }
      btnLater.addEventListener('click', cleanup);
      btnSend.addEventListener('click', ()=>{ cleanup(); window.open(redirectUrl,'_blank','noopener,noreferrer'); });
    } catch(e) { console.warn('Feedback modal error', e); }
  };
})();
</script>

<script>
  // URL de ton Worker Cloudflare (garde bien ton sous-domaine exact)
  window.WORKER_BASE = window.WORKER_BASE || "https://canva-token.amzkdptessa.workers.dev"; 
// <- adapte si besoin

  function getStored() {
    return {
      access: localStorage.getItem("canva_access_token"),
      refresh: localStorage.getItem("canva_refresh_token"),
      exp: parseInt(localStorage.getItem("canva_expires_at") || "0", 10),
    };
  }
  function storeTokens(data) {
    if (data.access_token) localStorage.setItem("canva_access_token", data.access_token);
    if (data.refresh_token) localStorage.setItem("canva_refresh_token", data.refresh_token);
    if (data.expires_in) localStorage.setItem("canva_expires_at", (Date.now() + data.expires_in * 1000).toString());
  }

  async function refreshIfNeeded() {
    const { access, refresh, exp } = getStored();
    if (!access || !refresh || !exp) throw new Error("Not authenticated");

    const soon = Date.now() + 60_000; // marge 60s
    if (exp > soon) return access;     // encore valide ‚Üí OK

    // Expir√© (ou bient√¥t) ‚Üí refresh c√¥t√© Worker
    const r = await fetch(`${WORKER_BASE}/refresh`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refresh_token: refresh }),
      credentials: "include"
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data?.error || "Refresh failed");
    // Canva renvoie souvent un NOUVEAU refresh_token
    storeTokens(data);
    return data.access_token;
  }

  // A utiliser avant chaque appel √† l‚ÄôAPI Canva
  async function getValidToken() {
    try {
      return await refreshIfNeeded();
    } catch (e) {
      console.error(e);
      alert("Session Canva expir√©e. Merci de vous reconnecter.");
      throw e;
    }
  }

  // Exemple d'usage (facultatif) :
  // async function testCanvaMe() {
  //   const token = await getValidToken();
  //   const res = await fetch("https://api.canva.com/rest/v1/me", {
  //     headers: { Authorization: `Bearer ${token}` }
  //   });
  //   console.log(await res.json());
  // }
</script>
<script>
  // URL de votre Worker Cloudflare (adapt√©e √† votre compte)
  window.WORKER_BASE = window.WORKER_BASE || "https://canva-token.amzkdptessa.workers.dev";
function getStored() {
    return {
      access: localStorage.getItem("canva_access_token"),
      refresh: localStorage.getItem("canva_refresh_token"),
      exp: parseInt(localStorage.getItem("canva_expires_at") || "0", 10),
    };
  }
  function storeTokens(data) {
    if (data.access_token) localStorage.setItem("canva_access_token", data.access_token);
    if (data.refresh_token) localStorage.setItem("canva_refresh_token", data.refresh_token);
    if (data.expires_in) localStorage.setItem("canva_expires_at", (Date.now() + data.expires_in * 1000).toString());
  }

  async function refreshIfNeeded() {
    const { access, refresh, exp } = getStored();
    if (!access || !refresh || !exp) throw new Error("Not authenticated");

    const soon = Date.now() + 60_000; // marge 60s
    if (exp > soon) return access;     // encore valide ‚Üí OK

    // Expir√© (ou bient√¥t) ‚Üí refresh c√¥t√© Worker
    const r = await fetch(`${WORKER_BASE}/refresh`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refresh_token: refresh }),
      credentials: "include"
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data?.error || "Refresh failed");
    // Canva renvoie souvent un NOUVEAU refresh_token
    storeTokens(data);
    return data.access_token;
  }

  // A utiliser avant chaque appel √† l‚ÄôAPI Canva
  async function getValidToken() {
    try {
      return await refreshIfNeeded();
    } catch (e) {
      console.error(e);
      alert("Session Canva expir√©e. Merci de vous reconnecter.");
      throw e;
    }
  }

  // Expose pour d'autres scripts si besoin
  window.getValidToken = getValidToken;
</script>
<script>
(function () {
  if (window.__kdp_canva_refresh_init) return;
  window.__kdp_canva_refresh_init = true;

  window.WORKER_BASE = window.WORKER_BASE || "https://canva-token.amzkdptessa.workers.dev";
function getStored() {
    return {
      access: localStorage.getItem("canva_access_token"),
      refresh: localStorage.getItem("canva_refresh_token"),
      exp: parseInt(localStorage.getItem("canva_expires_at") || "0", 10),
    };
  }
  function storeTokens(data) {
    if (data && typeof data === "object") {
      if (data.access_token) localStorage.setItem("canva_access_token", data.access_token);
      if (data.refresh_token) localStorage.setItem("canva_refresh_token", data.refresh_token);
      if (data.expires_in) localStorage.setItem("canva_expires_at", (Date.now() + data.expires_in * 1000).toString());
    }
  }

  async function refreshIfNeeded() {
    const { access, refresh, exp } = getStored();
    if (!access || !refresh || !exp) throw new Error("Not authenticated");

    const soon = Date.now() + 60_000;
    if (exp > soon) return access;

    const r = await fetch(`${window.WORKER_BASE}/refresh`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refresh_token: refresh }),
      credentials: "include"
    });
    let data;
    try { data = await r.json(); } catch (_) { data = {}; }
    if (!r.ok) throw new Error((data && data.error) || "Refresh failed");
    storeTokens(data);
    return data.access_token;
  }

  window.getValidToken = async function () {
    try {
      return await refreshIfNeeded();
    } catch (e) {
      console.error(e);
      alert("Session Canva expir√©e. Merci de vous reconnecter.");
      throw e;
    }
  };
})();
</script>
<script>
(function(){
  if (window.__kdp_canva_automap_init) return;
  window.__kdp_canva_automap_init = true;

  function dispatchChange(el){ try{ el.dispatchEvent(new Event('change', {bubbles:true})); }catch(_){} }

  function findFrontInput(){
    return document.querySelector('#frontImageInput, input[name="frontImage"], input[id*="front"][type="url"], input[id*="front"][type="text"], input[id*="front"][type="hidden"]');
  }
  function findBackInput(){
    return document.querySelector('#backImageInput, input[name="backImage"], input[id*="back"][type="url"], input[id*="back"][type="text"], input[id*="back"][type="hidden"]');
  }

  function findFrontPreview(){
    return document.querySelector('#frontPreview, img#front, img[id*="front"], img[alt*="front" i], [data-role="frontPreview"] img, [data-front-preview]');
  }
  function findBackPreview(){
    return document.querySelector('#backPreview, img#back, img[id*="back"], img[alt*="back" i], [data-role="backPreview"] img, [data-back-preview]');
  }

  function setFront(url){
    const inp = findFrontInput(); if (inp){ inp.value = url; dispatchChange(inp); }
    const img = findFrontPreview(); if (img){ img.src = url; img.loading='eager'; img.decoding='async'; }
    console.log('[Canva] Front set ‚Üí', url);
  }
  function setBack(url){
    const inp = findBackInput(); if (inp){ inp.value = url; dispatchChange(inp); }
    const img = findBackPreview(); if (img){ img.src = url; img.loading='eager'; img.decoding='async'; }
    console.log('[Canva] Back set ‚Üí', url);
  }

  window.__kdp_setCanvaFront = setFront;
  window.__kdp_setCanvaBack = setBack;

  if (!window.__kdp_canva_onSelected) {
    window.__kdp_canva_onSelected = function(side, url){
      if (!url) return;
      if (side === 'back') setBack(url); else setFront(url);
    };
  }
})();
</script>

<script>
// ============================================================
// SCRIPT D'INT√âGRATION CANVA DESIGNS
// ============================================================
(function() {
  'use strict';
  
  // Mettre √† jour l'UI quand la connexion change
  function updateCanvaUI() {
    const notConnectedHelp = document.getElementById('canva-not-connected-help');
    const isConnected = window.CanvaDesigns && window.CanvaDesigns.isConnected();
    
    if (notConnectedHelp) {
      notConnectedHelp.style.display = isConnected ? 'none' : 'block';
    }
  }
  
  // √âcouter les changements dans localStorage (connexion/d√©connexion)
  window.addEventListener('storage', (e) => {
    if (e.key === 'canva_access_token') {
      updateCanvaUI();
      if (window.CanvaDesigns) {
        window.CanvaDesigns.updateStatus();
      }
    }
  });
  
  // Init apr√®s chargement
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updateCanvaUI);
  } else {
    updateCanvaUI();
  }
  
  // Afficher un indicateur de chargement lors de l'export
  document.addEventListener('canva:export-start', () => {
    const loader = document.getElementById('canva-export-loading');
    if (loader) loader.classList.remove('hidden');
  });
  
  document.addEventListener('canva:export-end', () => {
    const loader = document.getElementById('canva-export-loading');
    if (loader) loader.classList.add('hidden');
  });
  
  // √âcouter l'√©v√©nement d'import de design Canva
  document.addEventListener('canva:design-imported', async (event) => {
    console.log('üé® [CANVA] Design import√©!', event.detail);

    const { imageUrl, action, designId } = (event && event.detail) ? event.detail : {};
    if (!imageUrl) {
      console.error('‚ùå [CANVA] Aucun imageUrl dans event.detail');
      return;
    }

    // Normaliser l'action (compatibilit√© si le fetcher utilise d'autres libell√©s)
    const a = String(action || 'front').toLowerCase().trim();
    let target = 'front';
    if (['back', 'verso', 'rear'].includes(a)) target = 'back';
    if (['spine', 'tranche'].includes(a)) target = 'spine';
    if (['front', 'cover', 'face', 'couverture'].includes(a)) target = 'front';

    try {
      console.log('üì• [CANVA] Chargement image:', imageUrl, '->', target);

      const img = new Image();
      img.crossOrigin = 'anonymous';

      img.onload = () => {
        console.log('‚úÖ [CANVA] Image charg√©e:', img.naturalWidth, 'x', img.naturalHeight);

        const imageData = {
          url: imageUrl,
          naturalWidth: img.naturalWidth,
          naturalHeight: img.naturalHeight,
          file: null,
          source: 'canva'
        };

        // 1) Voie directe React (si expos√©e)
        const setters = {
          front: window.reactSetFrontImage,
          back: window.reactSetBackImage,
          spine: window.reactSetSpineImage
        };

        if (typeof setters[target] === 'function') {
          console.log(`üìå [CANVA] Import React direct -> ${target.toUpperCase()}`);
          setters[target](imageData);
          return;
        }

        // 2) Fallback via handler global (t√©l√©charge + convertit en dataURL)
        if (typeof window.__kdp_handleCanvaUpload === 'function') {
          console.log(`üìå [CANVA] Import via __kdp_handleCanvaUpload -> ${target.toUpperCase()}`);
          window.__kdp_handleCanvaUpload(imageUrl, target);
          return;
        }

        console.error(`‚ùå [CANVA] Aucune fonction d'import disponible pour ${target}`);
        alert("Erreur: import Canva indisponible. Rechargez la page.");
      };

      img.onerror = (error) => {
        console.error('‚ùå [CANVA] Erreur chargement image:', error);
        alert("Erreur lors du chargement de l'image depuis Canva");
      };

      img.src = imageUrl;

    } catch (error) {
      console.error('‚ùå [CANVA] Erreur import:', error);
      alert('Erreur lors de l\'import: ' + error.message);
    }
  });
  
  console.log('‚úÖ Int√©gration Canva Designs initialis√©e');
})();
</script>

<!-- Syst√®me Beta 100 Founding Testers -->
<!-- Beta system d√©sactiv√© pour le lancement -->
<!-- <script src="beta-system.js"></script> -->

<!-- üî¥ Widget activit√© en temps r√©el - TEMPORAIREMENT D√âSACTIV√â -->
<!-- <script defer src="realtime-activity-widget.js"></script> -->

<!-- üé¨ THREE.JS BOOK 3D MOCKUP (Version D√©coupe Full Cover) -->
<script>
/**
 * ‚úÖ Lazy Book3D (Three.js full cover)
 * - Book3D code was inline and executed on page load.
 * - Now it is injected only when requested (e.g. when user opens 3D preview).
 */
window.GKDP = window.GKDP || {};
window.GKDP.loadBook3D = (function() {
  let loaded = false;
  const code = "\n(function() {\n    'use strict';\n    \n    // Variables globales\n    let scene, camera, renderer, book, orbit, ground;\n    let currentContainer = null;\n    let animationId = null;\n    let currentConfig = null;\n    \n    // Param\u00e8tres fixes\n    const RENDER_SCALE = 1.5;\n    const SHADOW_MAP_SIZE = 2048;\n    const PAGE_COLOR = '#fdfbf7';\n    const BLEED_MM = 3.175;\n\n    // \ud83c\udfae CONTROLES ORBITAUX MAISON\n    class SimpleOrbit {\n        constructor(cam, domElement) {\n            this.cam = cam;\n            this.dom = domElement;\n            this.rotX = -0.2;\n            this.rotY = -0.6;\n            this.distance = 550;\n            this.target = new THREE.Vector3(0, 0, 0);\n            \n            this.dragging = false;\n            this.lastX = 0;\n            this.lastY = 0;\n            \n            this._onStart = this._onStart.bind(this);\n            this._onMove = this._onMove.bind(this);\n            this._onEnd = this._onEnd.bind(this);\n            this._onWheel = this._onWheel.bind(this);\n            \n            domElement.addEventListener('mousedown', this._onStart);\n            domElement.addEventListener('touchstart', this._onStart, {passive: false});\n            window.addEventListener('mousemove', this._onMove);\n            window.addEventListener('touchmove', this._onMove, {passive: false});\n            window.addEventListener('mouseup', this._onEnd);\n            window.addEventListener('touchend', this._onEnd);\n            domElement.addEventListener('wheel', this._onWheel, {passive: false});\n            \n            domElement.style.cursor = 'grab';\n        }\n        \n        _onStart(e) {\n            this.dragging = true;\n            this.lastX = e.clientX || e.touches[0].clientX;\n            this.lastY = e.clientY || e.touches[0].clientY;\n            this.dom.style.cursor = 'grabbing';\n        }\n        \n        _onMove(e) {\n            if (!this.dragging) return;\n            const clientX = e.clientX || (e.touches && e.touches[0].clientX);\n            const clientY = e.clientY || (e.touches && e.touches[0].clientY);\n            \n            if (clientX === undefined) return;\n\n            const dx = clientX - this.lastX;\n            const dy = clientY - this.lastY;\n            \n            this.rotY -= dx * 0.005;\n            this.rotX -= dy * 0.005;\n            this.rotX = Math.max(-1.4, Math.min(0.1, this.rotX));\n            \n            this.lastX = clientX;\n            this.lastY = clientY;\n            \n            if (e.preventDefault) e.preventDefault();\n        }\n        \n        _onEnd() {\n            this.dragging = false;\n            this.dom.style.cursor = 'grab';\n        }\n        \n        _onWheel(e) {\n            e.preventDefault();\n            this.distance += e.deltaY * 0.5;\n            this.distance = Math.max(200, Math.min(900, this.distance));\n        }\n        \n        update() {\n            const phi = Math.PI / 2 - this.rotX;\n            const theta = this.rotY;\n            \n            this.cam.position.x = this.distance * Math.sin(phi) * Math.sin(theta);\n            this.cam.position.y = this.distance * Math.cos(phi);\n            this.cam.position.z = this.distance * Math.sin(phi) * Math.cos(theta);\n            \n            this.cam.lookAt(this.target);\n        }\n        \n        setPreset(name) {\n            const presets = {\n                'perspective': { rx: -0.25, ry: -0.6, d: 550 },\n                'flat': { rx: 0, ry: 0, d: 480 },\n                'standing': { rx: -0.1, ry: -0.8, d: 580 }\n            };\n            if(presets[name]) {\n                this.rotX = presets[name].rx;\n                this.rotY = presets[name].ry;\n                this.distance = presets[name].d;\n            }\n        }\n        \n        dispose() {\n            this.dom.removeEventListener('mousedown', this._onStart);\n            this.dom.removeEventListener('touchstart', this._onStart);\n            window.removeEventListener('mousemove', this._onMove);\n            window.removeEventListener('touchmove', this._onMove);\n            window.removeEventListener('mouseup', this._onEnd);\n            window.removeEventListener('touchend', this._onEnd);\n            this.dom.removeEventListener('wheel', this._onWheel);\n        }\n    }\n\n    // \ud83d\udee0\ufe0f FONCTION MAGIQUE : D\u00e9coupe du Full Cover\n    function sliceFullCover(image, bookW_mm, bookH_mm, spine_mm) {\n        const bleed = BLEED_MM;\n        const imgW = image.naturalWidth;\n        const imgH = image.naturalHeight;\n        \n        const totalMM = (bleed * 2) + (bookW_mm * 2) + spine_mm;\n        const pxPerMM = imgW / totalMM;\n        \n        const bleedPx = bleed * pxPerMM;\n        const widthPx = bookW_mm * pxPerMM;\n        const spinePx = spine_mm * pxPerMM;\n        \n        // 1. FACE (Front) - Partie droite\n        const frontC = document.createElement('canvas');\n        frontC.width = widthPx;\n        frontC.height = imgH;\n        const frontOffset = bleedPx + widthPx + spinePx;\n        frontC.getContext('2d').drawImage(image, frontOffset, 0, widthPx, imgH, 0, 0, widthPx, imgH);\n        \n        // 2. DOS (Back) - Partie gauche\n        const backC = document.createElement('canvas');\n        backC.width = widthPx;\n        backC.height = imgH;\n        backC.getContext('2d').drawImage(image, bleedPx, 0, widthPx, imgH, 0, 0, widthPx, imgH);\n        \n        // 3. TRANCHE (Spine) - Partie centrale\n        const spineC = document.createElement('canvas');\n        spineC.width = spinePx;\n        spineC.height = imgH;\n        const spineOffset = bleedPx + widthPx;\n        spineC.getContext('2d').drawImage(image, spineOffset, 0, spinePx, imgH, 0, 0, spinePx, imgH);\n        \n        return {\n            front: new THREE.CanvasTexture(frontC),\n            back: new THREE.CanvasTexture(backC),\n            spine: new THREE.CanvasTexture(spineC)\n        };\n    }\n\n    // Texture proc\u00e9durale pour les pages\n    function createPagesTexture() {\n        const c = document.createElement('canvas');\n        c.width = 128; c.height = 128;\n        const ctx = c.getContext('2d');\n        ctx.fillStyle = PAGE_COLOR;\n        ctx.fillRect(0,0,128,128);\n        ctx.fillStyle = '#e8e6e1';\n        for(let i=0; i<128; i+=2) ctx.fillRect(i,0,1,128);\n        \n        const tex = new THREE.CanvasTexture(c);\n        tex.wrapS = tex.wrapT = THREE.RepeatWrapping;\n        return tex;\n    }\n\n    // \ud83d\ude80 INITIALISATION\n    window.initBook3D = function(container, config) {\n        if (!container || !THREE) {\n            console.error('\u274c Three.js ou container non disponible');\n            return;\n        }\n        if (currentContainer === container) {\n            window.updateBook3D(config);\n            return;\n        }\n        \n        window.cleanupBook3D();\n        currentContainer = container;\n        currentConfig = config;\n        \n        const W = container.clientWidth;\n        const H = container.clientHeight;\n        \n        // SCENE\n        scene = new THREE.Scene();\n        scene.background = new THREE.Color(0x0d0f14);\n        \n        // CAMERA\n        camera = new THREE.PerspectiveCamera(35, W/H, 10, 2000);\n        \n        // RENDERER\n        renderer = new THREE.WebGLRenderer({ \n            antialias: true, \n            alpha: true, \n            preserveDrawingBuffer: true\n        });\n        renderer.setSize(W, H);\n        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));\n        renderer.shadowMap.enabled = true;\n        renderer.shadowMap.type = THREE.PCFSoftShadowMap;\n        container.appendChild(renderer.domElement);\n        \n        // CONTROLES\n        orbit = new SimpleOrbit(camera, renderer.domElement);\n        \n        // LUMIERES\n        const ambient = new THREE.AmbientLight(0xffffff, 0.6);\n        scene.add(ambient);\n        \n        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);\n        dirLight.position.set(150, 200, 100);\n        dirLight.castShadow = true;\n        dirLight.shadow.mapSize.width = SHADOW_MAP_SIZE;\n        dirLight.shadow.mapSize.height = SHADOW_MAP_SIZE;\n        dirLight.shadow.bias = -0.0001;\n        scene.add(dirLight);\n        \n        const backLight = new THREE.SpotLight(0xffffff, 0.4);\n        backLight.position.set(-100, 100, -200);\n        scene.add(backLight);\n        \n        // SOL\n        const planeGeo = new THREE.PlaneGeometry(2000, 2000);\n        const planeMat = new THREE.ShadowMaterial({ opacity: 0.2 });\n        ground = new THREE.Mesh(planeGeo, planeMat);\n        ground.rotation.x = -Math.PI / 2;\n        ground.receiveShadow = true;\n        scene.add(ground);\n        \n        // Construction du livre\n        buildBookGeometry(config);\n        \n        // Boucle de rendu\n        const animate = () => {\n            animationId = requestAnimationFrame(animate);\n            orbit.update();\n            renderer.render(scene, camera);\n        };\n        animate();\n        \n        // Resize handler\n        const onResize = () => {\n            if(!container) return;\n            const w = container.clientWidth;\n            const h = container.clientHeight;\n            camera.aspect = w/h;\n            camera.updateProjectionMatrix();\n            renderer.setSize(w,h);\n        };\n        window.addEventListener('resize', onResize);\n        container._resizeHandler = onResize;\n        \n        console.log('\u2705 Book3D initialis\u00e9 avec Three.js');\n    };\n    \n    // Construction de la g\u00e9om\u00e9trie\n    function buildBookGeometry(cfg) {\n        if(book) {\n            scene.remove(book);\n            book.geometry.dispose();\n        }\n        \n        const scale = 1.5;\n        const w = cfg.bookWidth * scale;\n        const h = cfg.bookHeight * scale;\n        // \u00c9paisseur plus g\u00e9n\u00e9reuse pour un vrai look livre\n        const d = Math.max(35, cfg.spineWidth * scale * 2.5);\n        \n        if(ground) ground.position.y = -h/2 - 2;\n        \n        const geometry = new THREE.BoxGeometry(w, h, d);\n        \n        const pagesTex = createPagesTexture();\n        const pageMat = new THREE.MeshStandardMaterial({ map: pagesTex, roughness: 0.9 });\n        const whiteMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.5 });\n        \n        // Faces: [Right, Left, Top, Bottom, Front, Back]\n        const materials = [\n            pageMat,  // 0: Right (Pages)\n            whiteMat, // 1: Left (Spine)\n            pageMat,  // 2: Top (Pages)\n            pageMat,  // 3: Bottom (Pages)\n            whiteMat, // 4: Front\n            whiteMat  // 5: Back\n        ];\n        \n        const loader = new THREE.TextureLoader();\n        loader.crossOrigin = 'anonymous';\n        \n        // Cas 1 : FULL COVER (D\u00e9coupe)\n        if (cfg.isFullCover && cfg.coverUrl) {\n            console.log('\ud83c\udfa8 Mode Full Cover - D\u00e9coupe en cours...');\n            const img = new Image();\n            img.crossOrigin = 'anonymous';\n            img.src = cfg.coverUrl;\n            img.onload = () => {\n                console.log('\u2705 Image Full Cover charg\u00e9e:', img.naturalWidth, 'x', img.naturalHeight);\n                const textures = sliceFullCover(img, cfg.bookWidth, cfg.bookHeight, cfg.spineWidth);\n                \n                [textures.front, textures.back, textures.spine].forEach(t => {\n                    t.colorSpace = THREE.SRGBColorSpace;\n                    if(renderer) t.anisotropy = renderer.capabilities.getMaxAnisotropy();\n                });\n                \n                materials[4] = new THREE.MeshStandardMaterial({ map: textures.front, roughness: 0.4 });\n                materials[5] = new THREE.MeshStandardMaterial({ map: textures.back, roughness: 0.4 });\n                materials[1] = new THREE.MeshStandardMaterial({ map: textures.spine, roughness: 0.5 });\n                \n                book.material = materials;\n                console.log('\u2705 Textures Full Cover appliqu\u00e9es !');\n            };\n            img.onerror = (err) => console.error('\u274c Erreur chargement Full Cover:', err);\n        } \n        // Cas 2 : Images s\u00e9par\u00e9es\n        else {\n            if (cfg.coverUrl) {\n                loader.load(cfg.coverUrl, (tex) => {\n                    tex.colorSpace = THREE.SRGBColorSpace;\n                    materials[4] = new THREE.MeshStandardMaterial({ map: tex, roughness: 0.4 });\n                    book.material = materials;\n                });\n            }\n            if (cfg.backUrl) {\n                loader.load(cfg.backUrl, (tex) => {\n                    tex.colorSpace = THREE.SRGBColorSpace;\n                    materials[5] = new THREE.MeshStandardMaterial({ map: tex, roughness: 0.4 });\n                    book.material = materials;\n                });\n            } else {\n                materials[5] = new THREE.MeshStandardMaterial({ color: 0x222222 });\n            }\n            materials[1] = new THREE.MeshStandardMaterial({ color: cfg.spineColor || 0x222222 });\n        }\n        \n        book = new THREE.Mesh(geometry, materials);\n        book.castShadow = true;\n        book.receiveShadow = true;\n        scene.add(book);\n    }\n\n    // Mise \u00e0 jour\n    window.updateBook3D = function(newConfig) {\n        if (!scene) return;\n        buildBookGeometry({ ...currentConfig, ...newConfig });\n        currentConfig = { ...currentConfig, ...newConfig };\n    };\n\n    // Presets\n    window.setBook3DPreset = function(preset) {\n        if (orbit) orbit.setPreset(preset);\n    };\n    \n    // Export PNG\n    window.exportBook3DPNG = function() {\n        if (!renderer) {\n            alert('Mockup 3D non initialis\u00e9');\n            return;\n        }\n        renderer.render(scene, camera);\n        const data = renderer.domElement.toDataURL('image/png');\n        const a = document.createElement('a');\n        a.href = data;\n        a.download = 'book-mockup-3d.png';\n        a.click();\n        console.log('\u2705 Export PNG r\u00e9ussi');\n    };\n    \n    // Nettoyage\n    window.cleanupBook3D = function() {\n        if (animationId) cancelAnimationFrame(animationId);\n        if (currentContainer && currentContainer._resizeHandler) {\n            window.removeEventListener('resize', currentContainer._resizeHandler);\n        }\n        if (renderer) {\n            renderer.dispose();\n            if(renderer.domElement.parentNode) renderer.domElement.parentNode.removeChild(renderer.domElement);\n        }\n        if (orbit) orbit.dispose();\n        \n        scene = null;\n        camera = null;\n        renderer = null;\n        book = null;\n        orbit = null;\n        ground = null;\n        currentContainer = null;\n        currentConfig = null;\n    };\n    \n    console.log('\u2705 Script Book3D Three.js (Full Cover) charg\u00e9');\n})();\n";
  return async function loadBook3D() {
    if (loaded) return true;
    loaded = true;
    try {
      if (typeof window.ensureThree === "function") {
        await window.ensureThree();
      }
    } catch (e) {
      console.warn("‚ö†Ô∏è [BOOK3D] ensureThree failed:", e);
    }
    const s = document.createElement("script");
    s.type = "text/javascript";
    s.text = code;
    document.head.appendChild(s);
    console.log("‚úÖ [BOOK3D] Lazy code injected");
    return true;
  };
})();
</script>

<script src="./logout-button.js" defer></script>

<!-- ‚úÖ Auto-scroll vers l'aper√ßu (sans toucher √† React/Canva) -->
<script>
(function () {
  if (window.__GKDP_AUTO_SCROLL_PREVIEW__) return;
  window.__GKDP_AUTO_SCROLL_PREVIEW__ = true;

  function getHeaderOffset(){
    const header = document.querySelector('.header-nav');
    const h = header ? header.getBoundingClientRect().height : 0;
    return Math.max(70, Math.round(h));
  }

  function scrollToPreviewIfHidden(){
    const preview = document.querySelector('.preview-zone');
    if (!preview) return;

    const rect = preview.getBoundingClientRect();
    const topSafe = getHeaderOffset() + 20;
    const bottomSafe = 40;
    const isVisible = rect.top >= topSafe && rect.bottom <= (window.innerHeight - bottomSafe);

    if (isVisible) return;

    const y = rect.top + window.pageYOffset - getHeaderOffset();
    window.scrollTo({ top: y, behavior: 'smooth' });
  }

  let t = null;
  function schedule(){
    if (t) clearTimeout(t);
    t = setTimeout(scrollToPreviewIfHidden, 120);
  }

  // On capte les saisies dans le g√©n√©rateur (inputs, textarea, select)
  document.addEventListener('input', (e) => {
    const el = e.target;
    if (!el) return;
    if (!el.closest || !el.closest('#kdp-generator-container')) return;
    if (el.matches('input, textarea, select')) schedule();
  }, true);

  // On capte aussi les changements (select / range)
  document.addEventListener('change', (e) => {
    const el = e.target;
    if (!el) return;
    if (!el.closest || !el.closest('#kdp-generator-container')) return;
    if (el.matches('input, textarea, select')) schedule();
  }, true);
})();
</script>

</body>
<!-- ‚úÖ Auto-scroll vers l'aper√ßu (sans toucher √† React/Canva) -->
<script>
(function () {
  if (window.__GKDP_AUTO_SCROLL_PREVIEW__) return;
  window.__GKDP_AUTO_SCROLL_PREVIEW__ = true;

  function getHeaderOffset(){
    const header = document.querySelector('.header-nav');
    const h = header ? header.getBoundingClientRect().height : 0;
    return Math.max(70, Math.round(h));
  }

  function scrollToPreviewIfHidden(){
    const preview = document.querySelector('.preview-zone');
    if (!preview) return;

    const rect = preview.getBoundingClientRect();
    const topSafe = getHeaderOffset() + 20;
    const bottomSafe = 40;
    const isVisible = rect.top >= topSafe && rect.bottom <= (window.innerHeight - bottomSafe);

    if (isVisible) return;

    const y = rect.top + window.pageYOffset - getHeaderOffset();
    window.scrollTo({ top: y, behavior: 'smooth' });
  }

  let t = null;
  function schedule(){
    if (t) clearTimeout(t);
    t = setTimeout(scrollToPreviewIfHidden, 120);
  }

  // On capte les saisies dans le g√©n√©rateur (inputs, textarea, select)
  document.addEventListener('input', (e) => {
    const el = e.target;
    if (!el) return;
    if (!el.closest || !el.closest('#kdp-generator-container')) return;
    if (el.matches('input, textarea, select')) schedule();
  }, true);

  // On capte aussi les changements (select / range)
  document.addEventListener('change', (e) => {
    const el = e.target;
    if (!el) return;
    if (!el.closest || !el.closest('#kdp-generator-container')) return;
    if (el.matches('input, textarea, select')) schedule();
  }, true);
})();
</script>


<script type="module" crossorigin src="./dist-generator/assets/index-C-1XqDNo.js"></script>


<!-- Listener pour init Canva apr√®s mount React -->
<script>
  window.addEventListener('gkdp:react-mounted', function() {
    console.log('‚úÖ [HTML] React mounted - Canva UI peut s attacher');
    
    // Si vous avez une fonction d init Canva, appelez-la ici
    if (window.CanvaDesigns && window.CanvaDesigns.init) {
      window.CanvaDesigns.init();
    }
    
    // Ou forcer un refresh de l UI Canva si n√©cessaire
    if (window.CanvaIntegration && window.CanvaIntegration.refresh) {
      window.CanvaIntegration.refresh();
    }
  });
</script>

</body>
</html>
