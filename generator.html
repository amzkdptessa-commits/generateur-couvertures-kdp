<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GabaritKDP Generator</title>

<link rel="stylesheet" href="/dist/assets/index-CkZaMb05.css"/>

<style>
html,body{margin:0;height:100%}
#kdp-react-root{min-height:100vh}
</style>
</head>

<body>
<div id="kdp-react-root"></div>

<script>
(function(){
  const WORKER_BASE = "https://canva-token.amzkdptessa.workers.dev";
  const CALLBACK_URL = "https://gabaritkdp.com/auth/callback.html";
  const CANVA_CLIENT_ID = "OC-AZnaRLvMwpXk";

  const SCOPES = [
    "profile:read",
    "asset:read",
    "asset:write",
    "design:meta:read",
    "design:content:read",
    "folder:read"
  ].join(" ");

  function base64UrlEncode(bytes){
    const bin = Array.from(bytes,b=>String.fromCharCode(b)).join("");
    return btoa(bin).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");
  }
  function randomString(len=64){
    const bytes = new Uint8Array(len);
    crypto.getRandomValues(bytes);
    return base64UrlEncode(bytes);
  }
  async function sha256(str){
    const data = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest("SHA-256",data);
    return base64UrlEncode(new Uint8Array(hash));
  }

  async function initiateConnection(){
    const verifier = randomString(96);
    const challenge = await sha256(verifier);
    const state = randomString(48);

    sessionStorage.setItem("pkce_code_verifier",verifier);
    sessionStorage.setItem("oauth_state",state);

    const url = new URL("https://www.canva.com/api/oauth/authorize");
    url.searchParams.set("response_type","code");
    url.searchParams.set("client_id",CANVA_CLIENT_ID);
    url.searchParams.set("scope",SCOPES);
    url.searchParams.set("state",state);
    url.searchParams.set("redirect_uri",CALLBACK_URL);
    url.searchParams.set("code_challenge",challenge);
    url.searchParams.set("code_challenge_method","S256");

    window.location.href = url.toString();
  }

  async function refreshIfNeeded(){
    const access = localStorage.getItem("canva_access_token");
    const refresh = localStorage.getItem("canva_refresh_token");
    const exp = Number(localStorage.getItem("canva_expires_at")||"0");
    if(!access || !refresh) return false;
    if(Date.now() < exp-60000) return true;

    const r = await fetch(`${WORKER_BASE}/refresh`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({refresh_token:refresh})
    });
    const data = await r.json().catch(()=>({}));
    if(!r.ok || !data.access_token) return false;

    localStorage.setItem("canva_access_token",data.access_token);
    if(data.refresh_token) localStorage.setItem("canva_refresh_token",data.refresh_token);
    if(data.expires_in) localStorage.setItem("canva_expires_at",String(Date.now()+data.expires_in*1000));
    return true;
  }

  function isAuthenticated(){
    const access = localStorage.getItem("canva_access_token");
    const exp = Number(localStorage.getItem("canva_expires_at")||"0");
    return !!access && Date.now()<exp;
  }

  window.CanvaAuth={ initiateConnection, refreshIfNeeded, isAuthenticated, WORKER_BASE };
})();
</script>

<script type="module" src="/dist/assets/index-Bx0G2ThJ.js"></script>
</body>
</html>
