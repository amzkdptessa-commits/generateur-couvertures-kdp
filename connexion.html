<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-en="Login - GabaritKDP" data-fr="Connexion - GabaritKDP">Login - GabaritKDP</title>
    
    <link rel="icon" type="image/png" href="LOGO GABARIT KDP POUR SITE WEB.png">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MYG5JJM8EC"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-MYG5JJM8EC');
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "t09tdy9nqm");
    </script>
    
    <style>
        /* ... (styles conservés - pas de changement) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .main-content {
            min-height: calc(100vh - 80px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-container {
            background: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 100%;
        }
        .form-input {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
        }
        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #FF9900, #FFB84D);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .message {
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .error {
            background: #fee2e2;
            color: #b91c1c;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
        }
    </style>
</head>

<body>
    <header>
        <!-- Header conservé tel quel -->
    </header>
    
    <main class="main-content">
        <section class="login-container">
            <div class="login-header">
                <h1>Welcome back!</h1>
                <p>Log in to access your tools</p>
            </div>
            <div class="form-body">
                <div id="messageContainer"></div>
                
                <!-- ✅ FIX CHATGPT : method="post" action="#" -->
                <form id="loginForm" method="post" action="#">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" class="form-input" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" class="form-input" required placeholder="Your password">
                        <div class="text-right mt-2">
                            <a href="#" onclick="resetPassword(event)" class="forgot-password">Forgot password?</a>
                        </div>
                    </div>
                    <button type="submit" class="login-btn">Sign in</button>
                </form>
                
                <div class="divider"><span>or</span></div>
                
                <div class="social-login flex flex-col gap-3">
                    <a href="#" onclick="loginWithProvider('google')" class="social-btn">
                        <i class="fab fa-google"></i>
                        <span>Continue with Google</span>
                    </a>
                </div>
                
                <div class="signup-link text-center mt-8">
                    <p>Don't have an account? <a href="./inscription.html">Sign up for free</a></p>
                </div>
            </div>
        </section>
    </main>
    
    <footer>
        <!-- Footer conservé tel quel -->
    </footer>

    <!-- ✅ FIX CHATGPT COMPLET -->
    <script>
(() => {
  // 0) Nettoyage immédiat si quelqu'un arrive avec ?email=...&password=...
  if (window.location.search) {
    window.history.replaceState({}, document.title, window.location.pathname);
  }

  // 1) Configuration
  const SUPABASE_URL = 'https://kucwdaicplajljpfkzhu.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1Y3dkYWljcGxhamxqcGZremh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MzMxMjQsImV4cCI6MjA3NzUwOTEyNH0.0IDHysD84_0ghjb-a4K0UkNrJbzdQBKUjm5mQbSfro8';

  // 2) Crée l'instance une seule fois, SANS créer de variable globale "supabase"
  if (!window.supabaseClient) {
    if (!window.supabase || !window.supabase.createClient) {
      console.error("Supabase SDK non chargé.");
      return;
    }
    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }
  const sb = window.supabaseClient; // sb = alias local, aucun conflit

  // 3) Langue
  let currentLang = localStorage.getItem('selectedLanguage') || 'en';

  function showMessage(message, type = 'error') {
    const container = document.getElementById('messageContainer');
    container.innerHTML = `<div class="message ${type}">${message}</div>`;
  }

  async function handleEmailLogin(e) {
    e.preventDefault();
    const form = e.currentTarget;
    const email = form.email.value.trim();
    const password = form.password.value;
    const loginBtn = form.querySelector('.login-btn');
    const originalText = loginBtn.textContent;
    
    loginBtn.disabled = true;
    loginBtn.textContent = currentLang === 'fr' ? 'Connexion...' : 'Signing in...';

    try {
      const { data, error } = await sb.auth.signInWithPassword({ email, password });

      if (error) {
        showMessage(currentLang === 'fr' ? 'Email ou mot de passe invalide.' : 'Invalid email or password.');
        loginBtn.disabled = false;
        loginBtn.textContent = originalText;
        return;
      }

      // Créer profil si besoin
      if (data?.user?.email) {
        const { data: existingProfile } = await sb
          .from('user_profiles')
          .select('id')
          .eq('email', data.user.email)
          .maybeSingle();

        if (!existingProfile) {
          await sb.from('user_profiles').insert({
            id: data.user.id,
            email: data.user.email,
            is_pro: false,
            exports_available: 3,
            total_exports_used: 0
          });
          console.log('✅ Profil user_profiles créé');
        }
      }

      showMessage(currentLang === 'fr' ? 'Connexion réussie ! Redirection...' : 'Login successful! Redirecting...', 'success');
      window.location.href = 'generator.html';
    } catch (err) {
      console.error(err);
      showMessage(currentLang === 'fr' ? "Erreur inattendue." : "Unexpected error.");
      loginBtn.disabled = false;
      loginBtn.textContent = originalText;
    }
  }

  async function loginWithProvider(provider) {
    await sb.auth.signInWithOAuth({
      provider,
      options: { redirectTo: `${window.location.origin}/generator.html` },
    });
  }
  window.loginWithProvider = loginWithProvider;

  async function resetPassword(e) {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    if (!email) {
      showMessage(currentLang === 'fr' ? 'Veuillez entrer votre email.' : 'Please enter your email.');
      return;
    }

    const { error } = await sb.auth.resetPasswordForEmail(email, {
      redirectTo: `${window.location.origin}/update-password.html`,
    });

    if (error) {
      showMessage(currentLang === 'fr' ? "Erreur lors de l'envoi." : "Error sending reset email.");
    } else {
      showMessage(`Email de réinitialisation envoyé à ${email}.`, 'success');
    }
  }
  window.resetPassword = resetPassword;

  document.addEventListener('DOMContentLoaded', async () => {
    const form = document.getElementById('loginForm');
    form.addEventListener('submit', handleEmailLogin);

    const { data: { session } } = await sb.auth.getSession();
    if (session) {
      window.location.href = './generator.html';
    }
  });
})();
</script>
</body>
</html>
