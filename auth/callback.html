<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Connexion √† Canva - GabaritKDP</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    }
    .card {
      width:100%; max-width:560px; background:#fff; border-radius:14px;
      padding:36px; box-shadow: 0 20px 50px rgba(0,0,0,0.25); text-align:center;
    }
    .spinner {
      width:56px; height:56px; margin:0 auto 18px; border-radius:50%;
      border:4px solid #f3f4f6; border-top-color:#667eea;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    h2 { font-size:1.25rem; color:#111827; margin-bottom:8px; }
    p { color:#6b7280; margin-bottom:12px; }
    .success { font-size:48px; color:#10b981; margin-bottom:10px; }
    .error-icon { font-size:48px; color:#ef4444; margin-bottom:10px; }
    .btn {
      display:inline-block; margin-top:14px; padding:10px 18px;
      background:#667eea; color:#fff; border-radius:10px;
      text-decoration:none; font-weight:600;
    }
  </style>
</head>
<body>
  <main class="card" id="card">
    <div class="spinner"></div>
    <h2>Connexion √† Canva en cours...</h2>
    <p>Veuillez patienter pendant la finalisation.</p>
  </main>

  <script>
    (async function () {
      const REDIRECT_URI = "https://gabaritkdp.com/auth/callback.html";
      const FINAL_REDIRECT = "/generator.html";
      const WORKER_URL = "https://canva-token.amzkdptessa.workers.dev/exchange";
      const CLIENT_ID = "OC-AZnaRLvMwpXk";

      const card = document.getElementById("card");

      function renderError(message) {
        card.innerHTML = `
          <div class="error-icon">‚úó</div>
          <h2>Erreur lors de l'authentification</h2>
          <p>${message}</p>
          <a class="btn" href="${FINAL_REDIRECT}">Retour au g√©n√©rateur</a>
        `;
      }

      function renderSuccess() {
        card.innerHTML = `
          <div class="success">‚úì</div>
          <h2>Connexion r√©ussie !</h2>
          <p>Redirection vers le g√©n√©rateur‚Ä¶</p>
        `;
        setTimeout(() => { window.location.href = FINAL_REDIRECT; }, 1500);
      }

      try {
        console.log("üöÄ D√©but callback Canva");

        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        const state = params.get("state");
        const error = params.get("error");

        if (error) return renderError("Acc√®s refus√© √† Canva.");
        if (!code) return renderError("Code d'autorisation manquant.");

        // Chercher le verifier - strat√©gie 1: cl√©s exactes
        let verifier = 
          localStorage.getItem('canva_pkce_verifier') ||
          sessionStorage.getItem('canva_pkce_verifier');

        // Strat√©gie 2: chercher toute cl√© qui COMMENCE par 'canva_pkce_verifier'
        if (!verifier) {
          const allKeys = Object.keys(localStorage);
          const verifierKey = allKeys.find(k => k.startsWith('canva_pkce_verifier'));
          if (verifierKey) {
            verifier = localStorage.getItem(verifierKey);
            console.log("‚úÖ Verifier trouv√© avec cl√©:", verifierKey);
          }
        }

        // Strat√©gie 3: extraire depuis le state parameter
        if (!verifier && state) {
          try {
            const stateData = JSON.parse(atob(state));
            verifier = stateData.v || stateData.verifier;
            console.log("‚úÖ Verifier r√©cup√©r√© depuis state");
          } catch(e) {}
        }

        console.log("Verifier trouv√©:", !!verifier);

        if (!verifier) {
          return renderError("Session expir√©e. Relancez la connexion.");
        }

        // √âchanger le code contre un token
        const resp = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            grant_type: "authorization_code",
            client_id: CLIENT_ID,
            redirect_uri: REDIRECT_URI,
            code: code,
            code_verifier: verifier
          })
        });

        const text = await resp.text();
        let data = {};
        try { data = JSON.parse(text); } catch (e) {}

        if (!resp.ok) {
          return renderError(`√âchec √©change token (${resp.status}): ${data.error || text}`);
        }

        if (!data.access_token) {
          return renderError("Token manquant dans la r√©ponse.");
        }

        // Sauvegarder le token
        localStorage.setItem("canva_access_token", data.access_token);
        if (data.refresh_token) localStorage.setItem("canva_refresh_token", data.refresh_token);
        if (data.expires_in) {
          localStorage.setItem("canva_token_expiry",
            String(Date.now() + (data.expires_in * 1000)));
        }

        // Nettoyer TOUS les verifiers
        Object.keys(localStorage)
          .filter(k => k.startsWith('canva_pkce'))
          .forEach(k => localStorage.removeItem(k));

        renderSuccess();

      } catch (err) {
        console.error(err);
        renderError("Erreur: " + (err.message || String(err)));
      }
    })();
  </script>
</body>
</html>
