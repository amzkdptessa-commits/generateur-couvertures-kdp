<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KDP Tracker v4 - B√¢tis Ton Empire KDP | GabaritKDP [BETA]</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Chart.js (for stats visualizations) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>

  <!-- Supabase (optional: only used if you connect auth/data) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  
  <style>
    :root {
      --brand-primary: #FF9900;
      --brand-secondary: #FF6600;
      --brand-dark: #1a1a1a;
      --brand-darker: #0f0f0f;
      --brand-light: #2d2d2d;
      --brand-lighter: #3a3a3a;
      --text-primary: #ffffff;
      --text-secondary: #aaaaaa;
      --border: rgba(255, 153, 0, 0.3);
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --green: #0c8f3a;
      --orange: #e6a700;
      --red: #c0392b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--brand-dark) 0%, var(--brand-light) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 50px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* HEADER */
    .hero-header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      padding: 60px 30px;
      text-align: center;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,.4);
      position: relative;
      overflow: hidden;
    }

    .hero-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, var(--brand-primary) 0%, transparent 100%);
      opacity: 0.1;
      pointer-events: none;
    }

    .hero-title {
      font-size: 48px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 15px;
      position: relative;
    }

    .hero-subtitle {
      font-size: 22px;
      color: var(--text-secondary);
      max-width: 800px;
      margin: 0 auto 30px;
      line-height: 1.6;
      position: relative;
    }

    .hero-intro {
      font-size: 18px;
      color: var(--text-primary);
      max-width: 900px;
      margin: 0 auto;
      line-height: 1.8;
      padding: 25px;
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      border: 1px solid rgba(255,153,0,0.2);
      position: relative;
    }

    /* DISCLAIMER */
    .disclaimer {
      background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
      color: #1a1a1a;
      padding: 25px 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      border-left: 5px solid #f57c00;
      box-shadow: 0 6px 20px rgba(255,193,7,0.3);
    }

    .disclaimer-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .disclaimer-content {
      line-height: 1.8;
      font-size: 15px;
    }

    .disclaimer-content p {
      margin-bottom: 12px;
    }

    .disclaimer-phases {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid rgba(0,0,0,0.1);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .phase-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      background: rgba(0,0,0,0.15);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    /* GUIDE STEPS */
    .guide-steps {
      background: var(--brand-light);
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
    }

    .guide-title {
      font-size: 24px;
      margin-bottom: 20px;
      color: var(--brand-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .steps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    .step-card {
      background: var(--brand-lighter);
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid var(--brand-primary);
      transition: transform 0.3s;
    }

    .step-card:hover {
      transform: translateY(-5px);
    }

    .step-number {
      width: 40px;
      height: 40px;
      background: var(--brand-primary);
      color: var(--brand-dark);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      margin-bottom: 12px;
    }

    .step-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .step-description {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* FILTERS */
    .filters-section {
      background: var(--brand-light);
      padding: 25px 30px;
      border-radius: 15px;
      margin-bottom: 25px;
      border: 1px solid var(--border);
    }

    .filters-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--brand-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .filter-select {
      padding: 12px 15px;
      background: var(--brand-lighter);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-select:hover, .filter-select:focus {
      border-color: var(--brand-primary);
      outline: none;
    }

    .filter-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: var(--brand-lighter);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-checkbox:hover {
      background: rgba(255,153,0,0.1);
    }

    .filter-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--brand-primary);
    }

    .filter-checkbox label {
      cursor: pointer;
      font-size: 15px;
      flex: 1;
    }

    .filter-stats {
      background: rgba(255,153,0,0.1);
      padding: 15px 20px;
      border-radius: 10px;
      margin-top: 15px;
      font-size: 15px;
      text-align: center;
      color: var(--brand-primary);
      font-weight: 600;
    }

    /* NICHES TABLE */
    .niches-section {
      background: var(--brand-light);
      padding: 30px;
      border-radius: 15px;
      border: 1px solid var(--border);
      margin-bottom: 30px;
    }

    .niches-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .niches-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--brand-primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .motivational-message {
      background: rgba(255,153,0,0.1);
      padding: 15px 20px;
      border-radius: 10px;
      border-left: 4px solid var(--brand-primary);
      margin-bottom: 20px;
      font-size: 15px;
      line-height: 1.6;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .niches-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--brand-lighter);
    }

    .niches-table thead {
      background: var(--brand-dark);
    }

    .niches-table th {
      padding: 16px 20px;
      text-align: left;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--brand-primary);
      border-bottom: 2px solid var(--brand-primary);
    }

    .niches-table td {
      padding: 18px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 15px;
    }

    .niches-table tbody tr {
      transition: all 0.3s;
    }

    .niches-table tbody tr:hover {
      background: rgba(255,153,0,0.05);
    }

    .niche-name {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
    }

    .niche-emoji {
      font-size: 24px;
      margin-right: 8px;
    }

    .badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-hot {
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      color: white;
    }

    .badge-good {
      background: linear-gradient(135deg, #51cf66, #37b24d);
      color: white;
    }

    .badge-stable {
      background: linear-gradient(135deg, #ffd93d, #f59e0b);
      color: #1a1a1a;
    }

    .badge-trend {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      margin-left: 8px;
    }

    .badge-low-comp {
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      color: white;
      margin-left: 8px;
    }

    .badge-gem {
      background: linear-gradient(135deg, #ec4899, #db2777);
      color: white;
      margin-left: 8px;
    }

    .score-cell {
      text-align: center;
      font-weight: 700;
      font-size: 18px;
    }

    .score-green {
      color: var(--green);
    }

    .score-orange {
      color: var(--orange);
    }

    .score-red {
      color: var(--red);
    }

    /* CTA SECTION */
    .cta-section {
      background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
      padding: 50px 40px;
      border-radius: 20px;
      text-align: center;
      margin-top: 40px;
      box-shadow: 0 10px 40px rgba(255,153,0,0.3);
    }

    .cta-title {
      font-size: 36px;
      font-weight: 800;
      margin-bottom: 20px;
      color: var(--brand-dark);
    }

    .cta-text {
      font-size: 18px;
      color: var(--brand-dark);
      margin-bottom: 35px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.8;
    }

    .cta-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .action-step {
      background: rgba(0,0,0,0.2);
      padding: 20px 30px;
      border-radius: 12px;
      min-width: 200px;
    }

    .action-number {
      font-size: 28px;
      font-weight: 700;
      color: var(--brand-dark);
      margin-bottom: 8px;
    }

    .action-text {
      font-size: 15px;
      color: var(--brand-darker);
      font-weight: 600;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .hero-title {
        font-size: 32px;
      }

      .hero-subtitle {
        font-size: 18px;
      }

      .hero-intro {
        font-size: 16px;
        padding: 20px;
      }

      .steps-grid {
        grid-template-columns: 1fr;
      }

      .filters-grid {
        grid-template-columns: 1fr;
      }

      .table-container {
        border-radius: 8px;
      }

      .niches-table th,
      .niches-table td {
        padding: 12px 15px;
        font-size: 13px;
      }

      .cta-title {
        font-size: 28px;
      }

      .cta-text {
        font-size: 16px;
      }
    }
  

    /* =============================
       KDP TRACKER (extension + stats)
       ============================= */
/* SYNC STATUS BANNER */
    .sync-banner {
      background: linear-gradient(135deg, var(--brand-light), var(--brand-lighter));
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }

    .sync-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .sync-icon {
      width: 50px;
      height: 50px;
      background: var(--brand-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .sync-details h3 {
      font-size: 18px;
      margin-bottom: 5px;
    }

    .sync-time {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .sync-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-sync {
      background: var(--brand-primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-sync:hover {
      background: var(--brand-secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 153, 0, 0.3);
    }

    .btn-sync:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: transparent;
      color: var(--text-primary);
      border: 2px solid var(--border);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      border-color: var(--brand-primary);
      color: var(--brand-primary);
    }

    /* STATS CARDS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--brand-light), var(--brand-lighter));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 25px;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary));
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border-color: var(--brand-primary);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-icon {
      font-size: 24px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--brand-primary);
      margin-bottom: 8px;
    }

    .stat-change {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--error);
    }

    /* CHARTS SECTION */
    .charts-section {
      margin-bottom: 40px;
    }

    .chart-container {
      background: linear-gradient(135deg, var(--brand-light), var(--brand-lighter));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .chart-title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-btn:hover {
      border-color: var(--brand-primary);
      color: var(--brand-primary);
    }

    .filter-btn.active {
      background: var(--brand-primary);
      color: white;
      border-color: var(--brand-primary);
    }

    .chart-canvas {
      position: relative;
      height: 350px;
    }

    /* BOOKS TABLE */
    .books-section {
      background: linear-gradient(135deg, var(--brand-light), var(--brand-lighter));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search-box {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .search-input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 14px;
      min-width: 250px;
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    .books-table {
      width: 100%;
      border-collapse: collapse;
      overflow-x: auto;
    }

    .books-table thead th {
      text-align: left;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border);
    }

    .books-table tbody tr {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s;
    }

    .books-table tbody tr:hover {
      background: rgba(255, 153, 0, 0.05);
    }

    .books-table tbody td {
      padding: 18px 15px;
      font-size: 14px;
    }

    .book-title {
      font-weight: 600;
      color: var(--text-primary);
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .marketplace-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(255, 153, 0, 0.2);
      color: var(--brand-primary);
    }

    .performance-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .performance-indicator.high {
      color: var(--success);
    }

    .performance-indicator.medium {
      color: var(--warning);
    }

    .performance-indicator.low {
      color: var(--error);
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .empty-description {
      color: var(--text-secondary);
      font-size: 16px;
      margin-bottom: 30px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    /* LOADING */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      gap: 10px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 153, 0, 0.1);
      border-top-color: var(--brand-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    

    /* ===== GabaritKDP Tracker ‚Äî BETA badge + Help ===== */
    .gkdp-beta-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:28px;
      padding:0 10px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:1px;
      font-size:12px;
      color:#111;
      background:rgba(255, 255, 255, 0.85);
      border:1px solid rgba(255,255,255,0.35);
      box-shadow:0 6px 20px rgba(0,0,0,0.25);
      margin-left:10px;
      text-transform:uppercase;
      cursor:default;
      user-select:none;
    }
    .gkdp-help-btn{
      height:38px;
      padding:0 14px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.35);
      color:#fff;
      font-weight:700;
      margin-left:10px;
      cursor:pointer;
      transition:transform .12s ease, background .12s ease, border-color .12s ease;
      white-space:nowrap;
    }
    .gkdp-help-btn:hover{ transform:translateY(-1px); background:rgba(0,0,0,0.45); border-color:rgba(255,255,255,0.35); }
    .gkdp-help-btn:active{ transform:translateY(0px); }

    /* Help modal */
    .gkdp-modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.65);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99999;
      padding:18px;
    }
    .gkdp-modal{
      width:min(980px, 100%);
      max-height:85vh;
      overflow:auto;
      background:rgba(20,20,20,0.98);
      border:1px solid rgba(255,255,255,0.18);
      border-radius:18px;
      box-shadow:0 20px 80px rgba(0,0,0,0.55);
      padding:22px 22px 18px;
    }
    .gkdp-modal h2{
      margin:0 0 6px;
      font-size:22px;
      letter-spacing:0.2px;
    }
    .gkdp-modal .sub{
      margin:0 0 16px;
      opacity:0.85;
      line-height:1.35;
    }
    .gkdp-modal .cols{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
    }
    @media (min-width: 900px){
      .gkdp-modal .cols{ grid-template-columns:1fr 1fr; }
    }
    .gkdp-card{
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      padding:14px;
    }
    .gkdp-card h3{
      margin:0 0 8px;
      font-size:16px;
    }
    .gkdp-card ol, .gkdp-card ul{
      margin:0;
      padding-left:18px;
      line-height:1.45;
      opacity:0.92;
    }
    .gkdp-card code{
      background:rgba(255,255,255,0.08);
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.10);
    }
    .gkdp-modal-footer{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      padding-top:14px;
    }
    .gkdp-close-btn{
      height:40px;
      padding:0 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.20);
      background:rgba(255,255,255,0.08);
      color:#fff;
      font-weight:800;
      cursor:pointer;
    }

</style>
</head>
<body>

  <!-- TOP NAV TABS -->
  <div id="topTabs" style="position:sticky;top:0;z-index:9999;background:#0b0b0b;backdrop-filter:blur(6px);padding:12px 16px;border-bottom:1px solid rgba(255,215,0,0.25);">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <button class="gkdp-tab-btn active" data-target="dashboardSection" type="button">Dashboard</button>
      <button class="gkdp-tab-btn" data-target="bestsellersSection" type="button">Bestsellers (Top 30)</button>
      <span class="gkdp-beta-badge" title="Fonctionnalit√© en cours d\'am√©lioration">BETA</span>
      <button id="gkdpHelpBtn" class="gkdp-help-btn" type="button">Mode d\'emploi</button>
      <span style="margin-left:auto;color:#c9c9c9;font-size:12px;">Astuce: ouvre la page via un serveur local pour que le CSV se charge.</span>
    </div>
  </div>

  <style>
    .gkdp-tab-btn{
      background: rgba(255,165,0,0.12);
      border: 1px solid rgba(255,165,0,0.35);
      color: #ffd27a;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: .3px;
    }
    .gkdp-tab-btn:hover{ background: rgba(255,165,0,0.18); }
    .gkdp-tab-btn.active{
      background: rgba(255,165,0,0.28);
      border-color: rgba(255,215,0,0.55);
      color: #fff2cc;
      box-shadow: 0 0 0 2px rgba(255,215,0,0.10) inset;
    }
    .gkdp-section{ display:none; }
    .gkdp-section.active{ display:block; }
  </style>


  <!-- ===== Help / Mode d'emploi (BETA) ===== -->
  <div id="gkdpHelpOverlay" class="gkdp-modal-overlay" aria-hidden="true">
    <div class="gkdp-modal" role="dialog" aria-modal="true" aria-labelledby="gkdpHelpTitle">
      <h2 id="gkdpHelpTitle">GabaritKDP Tracker ‚Äî Mode d'emploi <span style="opacity:.75;font-weight:700;">(BETA)</span></h2>
      <p class="sub">
        Objectif : analyser rapidement les <strong>Top 30 Bestsellers Amazon</strong> par sous-cat√©gories (2 niveaux) et d√©tecter des niches. 
        Cette version est en BETA : la structure Amazon change parfois, donc certaines cat√©gories peuvent √©voluer.
      </p>

      <div class="cols">
        <div class="gkdp-card">
          <h3>1) Mettre √† jour les donn√©es (CSV)</h3>
          <ol>
            <li>Lance ton script Scrapy (celui que tu as ex√©cut√© dans <code>D:\kdp_trends</code>).</li>
            <li>Il g√©n√®re le fichier : <code>fr_books_top30_2levels.csv</code> (Top 30 par cat√©gorie).</li>
            <li>Copie ce CSV dans le <strong>m√™me dossier</strong> que le fichier HTML du tracker.</li>
          </ol>
        </div>

        <div class="gkdp-card">
          <h3>2) Ouvrir le tracker correctement</h3>
          <ol>
            <li>√âvite le mode <code>file://</code> si ton navigateur bloque le chargement du CSV.</li>
            <li>Le plus simple : lancer un petit serveur local dans le dossier du tracker :</li>
            <ul>
              <li>Windows (PowerShell) : <code>python -m http.server 8000</code></li>
              <li>Puis ouvre : <code>http://localhost:8000/</code></li>
            </ul>
            <li>Tu verras les onglets en haut : <strong>Dashboard</strong> et <strong>Bestsellers</strong>.</li>
          </ol>
        </div>

        <div class="gkdp-card">
          <h3>3) Onglet ‚ÄúBestsellers (Top 30)‚Äù</h3>
          <ul>
            <li>Affiche les <strong>Top 30</strong> par <strong>Level 1</strong> + <strong>Level 2</strong>.</li>
            <li>Si tu veux ‚ÄúRomans‚Äù : il faut que ton CSV contienne une ligne o√π <code>level1_category</code> = Romans (ou √©quivalent).</li>
            <li>Si Amazon renvoie ‚ÄúRomans et litt√©rature‚Äù ou ‚ÄúRomance et litt√©rature sentimentale‚Äù, on les harmonisera via un mapping (prochaine it√©ration).</li>
          </ul>
        </div>

        <div class="gkdp-card">
          <h3>4) Bon r√©flexe de debug</h3>
          <ul>
            <li>V√©rifie que le CSV n‚Äôest pas vide : taille &gt; 0 et pr√©sence d‚Äôen-t√™tes.</li>
            <li>Ouvre le CSV et confirme les colonnes :
              <code>marketplace</code>, <code>level1_category</code>, <code>level2_category</code>, <code>rank</code>, <code>title</code>, <code>author</code>, <code>rating</code>, <code>reviews</code>, <code>price</code>, <code>url</code>.
            </li>
            <li>Si tu ne vois pas certaines familles (ex. Romans) : soit l‚ÄôURL de cat√©gorie n‚Äôest pas dans ta liste, soit la navigation Amazon renvoie une autre arborescence.</li>
          </ul>
        </div>
      </div>

      <div class="gkdp-modal-footer">
        <button id="gkdpHelpClose" class="gkdp-close-btn" type="button">Fermer</button>
      </div>
    </div>
  </div>


  <div id="dashboardSection" class="gkdp-section active">


  <div class="container">
    
    <!-- Hero Header -->
    <div class="hero-header">
      <h1 class="hero-title">üöÄ B√¢tis Ton Empire KDP, Une Niche Rentable √† la Fois</h1>
      <p class="hero-subtitle">Tu n'as pas besoin de chance, tu as besoin d'un plan. Ici, tu rep√®res les niches intelligentes et tu passes √† l'action, aujourd'hui.</p>
      <div class="hero-intro">
        <strong>Bienvenue dans ton laboratoire de niches KDP.</strong><br>
        Chaque ligne ici peut devenir un livre, et chaque livre peut devenir une nouvelle source de revenus. Tu n'as pas √† tout faire d'un coup : avance une niche, un livre, un palier de revenus √† la fois.
      </div>
    </div>


    <!-- Extension + Ventes (Tracker) -->
    <div class="sync-banner" style="margin-top: 10px;">
      <div class="sync-info">
        <div class="sync-icon">üîÑ</div>
        <div class="sync-details">
          <h3 id="syncStatus">Extension GabaritKDP Connect√©e</h3>
          <div class="sync-time">
            <span>Derni√®re synchronisation:</span>
            <span id="lastSyncTime">--:--</span>
          </div>
        </div>
      </div>
      <div class="sync-actions">
        <button class="btn-sync" id="refreshBtn" onclick="refreshData()">
          <i class="fas fa-sync-alt"></i>
          <span>Actualiser</span>
        </button>
        <button class="btn-secondary" onclick="openExtensionGuide()">
          <i class="fas fa-question-circle"></i>
          <span>Aide</span>
        </button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Revenus Total</span>
          <span class="stat-icon">üí∞</span>
        </div>
        <div class="stat-value" id="totalRevenue">‚Ç¨0.00</div>
        <div class="stat-change positive" id="revenueChange">
          <i class="fas fa-arrow-up"></i><span>+0%</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Ventes Totales</span>
          <span class="stat-icon">üìö</span>
        </div>
        <div class="stat-value" id="totalSales">0</div>
        <div class="stat-change positive" id="salesChange">
          <i class="fas fa-arrow-up"></i><span>+0%</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Livres Actifs</span>
          <span class="stat-icon">üìñ</span>
        </div>
        <div class="stat-value" id="activeBooks">0</div>
        <div class="stat-change"><span>Total publi√©</span></div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Top Performer</span>
          <span class="stat-icon">üî•</span>
        </div>
        <div class="stat-value" id="topBook" style="font-size: 18px; line-height: 1.3;">--</div>
        <div class="stat-change"><span id="topBookRevenue">‚Ç¨0</span></div>
      </div>
    </div>

    <div class="charts-section">
      <div class="chart-container">
        <div class="chart-header">
          <h2 class="chart-title"><i class="fas fa-chart-line"></i> √âvolution des Revenus</h2>
          <div class="chart-filters">
            <button class="filter-btn" onclick="updateChartPeriod('7d')">7 jours</button>
            <button class="filter-btn active" onclick="updateChartPeriod('30d')">30 jours</button>
            <button class="filter-btn" onclick="updateChartPeriod('90d')">90 jours</button>
            <button class="filter-btn" onclick="updateChartPeriod('1y')">1 an</button>
          </div>
        </div>
        <div class="chart-canvas"><canvas id="revenueChart"></canvas></div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h2 class="chart-title"><i class="fas fa-globe"></i> Ventes par Marketplace</h2>
        </div>
        <div class="chart-canvas" style="height: 300px;"><canvas id="marketplaceChart"></canvas></div>
      </div>
    </div>

    <div class="books-section" id="booksSection">
      <div class="section-header">
        <h2 class="section-title"><i class="fas fa-book"></i> Mes Livres</h2>
        <div class="search-box">
          <input type="text" class="search-input" id="searchInput" placeholder="Rechercher un livre..." />
        </div>
      </div>

      <div id="booksTableContainer">
        <div class="empty-state" id="booksEmptyState">
          <div class="empty-icon">üìâ</div>
          <div class="empty-title">Aucune donn√©e de ventes pour l‚Äôinstant</div>
          <div class="empty-description">
            Connecte l‚Äôextension <strong>GabaritKDP Tracker</strong> pour importer tes ventes (par marketplace), puis reviens ici.
            <br/>Ensuite, ce dashboard affichera automatiquement tes revenus, tes tendances et tes livres.
          </div>
          <button class="btn-sync" onclick="openExtensionGuide()">
            <i class="fas fa-plug"></i>
            Voir comment connecter l‚Äôextension
          </button>
        </div>
      </div>
    </div>

    <!-- Boussole 2026 : Rapport march√© 2025 ‚Üí Opportunit√©s 2026 -->
    <div class="books-section" style="margin-top: 30px;">
      <div class="section-header">
        <h2 class="section-title"><i class="fas fa-compass"></i> Boussole 2026 (bas√©e sur 2025)</h2>
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-bottom:18px;">
        <div>
          <div style="color:var(--text-secondary);font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px;">March√©</div>
          <select class="filter-select" id="marketReportSelect" onchange="renderMarketReport()" style="width:100%;">
            <option value="FR">üá´üá∑ France (Amazon.fr)</option>
            <option value="US">üá∫üá∏ USA (Amazon.com)</option>
            <option value="UK">üá¨üáß UK (Amazon.co.uk)</option>
            <option value="DE">üá©üá™ Allemagne (Amazon.de)</option>
            <option value="ES">üá™üá∏ Espagne (Amazon.es)</option>
            <option value="IT">üáÆüáπ Italie (Amazon.it)</option>
            <option value="NL">üá≥üá± Pays-Bas (Amazon.nl)</option>
            <option value="PL">üáµüá± Pologne (Amazon.pl)</option>
            <option value="SE">üá∏üá™ Su√®de (Amazon.se)</option>
            <option value="BE">üáßüá™ Belgique (Amazon.com.be)</option>
            <option value="IE">üáÆüá™ Irlande (Amazon.ie)</option>
            <option value="JP">üáØüáµ Japon (Amazon.co.jp)</option>
            <option value="CA">üá®üá¶ Canada (Amazon.ca)</option>
            <option value="AU">üá¶üá∫ Australie (Amazon.com.au)</option>
          </select>
          <div style="margin-top:10px;color:var(--text-secondary);font-size:13px;line-height:1.5;">
            Objectif : donner une <strong>direction 2026</strong> (pas des chiffres ‚Äúparfaits‚Äù). Tu peux mettre √† jour ces tendances 1 fois/an.
          </div>
        </div>

        <div style="background:rgba(255,153,0,0.08);border:1px solid var(--border);border-radius:12px;padding:14px 16px;">
          <div style="font-weight:800;color:var(--brand-primary);margin-bottom:6px;">L√©gendes</div>
          <div style="font-size:14px;line-height:1.6;color:var(--text-primary);">
            <div><strong>Volume</strong> : taille/activit√© g√©n√©rale du marketplace (rep√®re produit).</div>
            <div><strong>Confiance tendance</strong> : qualit√© des signaux utilis√©s (interne + signaux publics).</div>
            <div style="color:var(--text-secondary);margin-top:6px;">Aucune donn√©e ‚Äúvente globale KDP‚Äù officielle n‚Äôexiste : on travaille avec des signaux fiables et des synth√®ses.</div>
          </div>
        </div>
      </div>

      <div id="marketReportContainer"></div>
    </div>


    <!-- Disclaimer Beta -->
    <div class="disclaimer">
      <div class="disclaimer-title">
        <i class="fas fa-info-circle"></i>
        DASHBOARD EN BETA - Phase 1 : Donn√©es Estim√©es
      </div>
      <div class="disclaimer-content">
        <p><strong>Les niches et scores affich√©s sont bas√©s sur des analyses de march√© et tendances Amazon 2025.</strong></p>
        <p>‚úÖ <strong>Utilise-les pour EXPLORER</strong> des id√©es de niches rentables</p>
        <p>‚ö†Ô∏è <strong>V√©rifie toujours sur Amazon.com</strong> avant de publier ton livre</p>
        <p>üöÄ <strong>Donn√©es plus pr√©cises arrivent en Phase 2 & 3</strong> (signaux publics + import KDP + IA)</p>
        
        <div class="disclaimer-phases">
          <div class="phase-badge">
            <span>üìç Phase 1</span>
            <span>Donn√©es estim√©es (ACTUEL)</span>
          </div>
          <div class="phase-badge">
            <span>üìä Phase 2</span>
            <span>Signaux publics + m√©thodes pro</span>
          </div>
          <div class="phase-badge">
            <span>‚úÖ Phase 3</span>
            <span>Import KDP + synth√®se IA</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Guide Steps -->
    <div class="guide-steps">
      <h2 class="guide-title">
        <i class="fas fa-rocket"></i>
        Comment Utiliser Cette Page Pour Exploser Tes R√©sultats KDP
      </h2>
      <div class="steps-grid">
        <div class="step-card">
          <div class="step-number">1</div>
          <div class="step-title">Choisis Ton March√©</div>
          <div class="step-description">S√©lectionne USA ou France, et un type de livre (coloring book, journal, planner, roman, etc.)</div>
        </div>
        <div class="step-card">
          <div class="step-number">2</div>
          <div class="step-title">Filtre les Meilleures Niches</div>
          <div class="step-description">Utilise le score de niche pour rep√©rer celles avec forte demande et concurrence raisonnable</div>
        </div>
        <div class="step-card">
          <div class="step-number">3</div>
          <div class="step-title">Passe √† l'Action Aujourd'hui</div>
          <div class="step-description">Garde 3-5 id√©es et d√©cide d'une action concr√®te √† faire maintenant. M√™me un petit pas compte.</div>
        </div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <h3 class="filters-title">
        <i class="fas fa-filter"></i>
        Filtres d'Opportunit√©s - Trouve Ta P√©pite
      </h3>
      
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">March√©</label>
          <select class="filter-select" id="filterMarket" onchange="applyFilters()">
            <option value="">Tous les march√©s</option>
            <option value="US">üá∫üá∏ USA (Amazon.com)</option>
            <option value="UK">üá¨üáß UK (Amazon.co.uk)</option>
            <option value="DE">üá©üá™ Allemagne (Amazon.de)</option>
            <option value="FR">üá´üá∑ France (Amazon.fr)</option>
            <option value="ES">üá™üá∏ Espagne (Amazon.es)</option>
            <option value="IT">üáÆüáπ Italie (Amazon.it)</option>
            <option value="NL">üá≥üá± Pays-Bas (Amazon.nl)</option>
            <option value="PL">üáµüá± Pologne (Amazon.pl)</option>
            <option value="SE">üá∏üá™ Su√®de (Amazon.se)</option>
            <option value="BE">üáßüá™ Belgique (Amazon.com.be)</option>
            <option value="IE">üáÆüá™ Irlande (Amazon.ie)</option>
            <option value="JP">üáØüáµ Japon (Amazon.co.jp)</option>
            <option value="CA">üá®üá¶ Canada (Amazon.ca)</option>
            <option value="AU">üá¶üá∫ Australie (Amazon.com.au)</option>
    </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Type de Livre</label>
          <select class="filter-select" id="filterType" onchange="applyFilters()">
            <option value="">Tous les types</option>
            <option value="Coloring book">üé® Coloring Book</option>
            <option value="Journal">üìî Journal</option>
            <option value="Planner">üìÖ Planner</option>
            <option value="Activity book">üéØ Activity Book</option>
            <option value="Notebook">üìì Notebook</option>
            <option value="Roman">üìö Roman</option>
            <option value="Non-fiction">üìñ Non-Fiction</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Score Minimum</label>
          <select class="filter-select" id="filterScore" onchange="applyFilters()">
            <option value="0">Tous les scores</option>
            <option value="70">‚≠ê Opportunit√©s vertes (70+)</option>
            <option value="40">üí° √Ä creuser (40+)</option>
          </select>
        </div>
      </div>

      <div class="filter-checkbox">
        <input type="checkbox" id="filterLowComp" onchange="applyFilters()">
        <label for="filterLowComp">üå± Afficher uniquement les niches √† faible concurrence (parfait pour d√©buter)</label>
      </div>

      <div class="filter-stats" id="filterStats">
        Toutes les niches affich√©es
      </div>
    </div>

    <!-- Niches Section -->
    <div class="niches-section">
      <div class="niches-header">
        <h2 class="niches-title">
          <i class="fas fa-gem"></i>
          Niches Rentables KDP
        </h2>
      </div>

      <div class="motivational-message" id="motivationalMsg">
        üí° <strong>Chaque ligne est une opportunit√©.</strong> Ta mission : rep√©rer celles qui te donnent envie de cr√©er‚Ä¶ et ne plus les laisser dormir dans un tableau.
      </div>

      <div class="table-container">
        <table class="niches-table" id="nichesTable">
          <thead>
            <tr>
              <th>Niche</th>
              <th>March√©</th>
              <th>Type</th>
              <th>Demande</th>
              <th>Concurrence</th>
              <th>BSR Moyen</th>
              <th>Score Niche</th>
              <th>Badges</th>
            </tr>
          </thead>
          <tbody id="nichesBody">
            <!-- Les niches seront ins√©r√©es ici par JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- CTA Section -->
    <div class="cta-section">
      <h2 class="cta-title">Tu as Trouv√© Une Niche Qui Te Donne Envie ?</h2>
      <p class="cta-text">
        Ne la laisse pas dans le tableau. Note 3 id√©es de titres, ouvre ton logiciel d'√©criture et commence. Ton futur toi te remerciera d'avoir cliqu√© sur "Publier" aujourd'hui, pas dans six mois.
      </p>
      <div class="cta-actions">
        <div class="action-step">
          <div class="action-number">1Ô∏è‚É£</div>
          <div class="action-text">Choisis 1-2 niches vertes</div>
        </div>
        <div class="action-step">
          <div class="action-number">2Ô∏è‚É£</div>
          <div class="action-text">V√©rifie les couvertures sur Amazon</div>
        </div>
        <div class="action-step">
          <div class="action-number">3Ô∏è‚É£</div>
          <div class="action-text">Liste 10 id√©es de titres</div>
        </div>
        <div class="action-step">
          <div class="action-number">4Ô∏è‚É£</div>
          <div class="action-text">Commence TON livre aujourd'hui</div>
        </div>
      </div>
    </div>

  </div>


  <script>
    // =============================
    // Tracker (extension + ventes)
    // =============================
    let revenueChart = null;
    let marketplaceChart = null;
    let currentPeriod = '30d';

    function formatCurrencyEUR(value) {
      try {
        return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(value || 0);
      } catch (e) {
        return `‚Ç¨${(value || 0).toFixed(2)}`;
      }
    }

    function setSyncTimeNow() {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      document.getElementById('lastSyncTime').textContent = `${hh}:${mm}`;
    }

    function checkExtensionStatus() {
      // On page web, we can't guarantee Chrome extension API access.
      // We show "connected" if we have local cached data.
      const hasCache = !!localStorage.getItem('gkdp_sales_cache_v1');
      const statusEl = document.getElementById('syncStatus');
      if (!statusEl) return;

      if (hasCache) {
        statusEl.innerHTML = 'Extension GabaritKDP Connect√©e <i class="fas fa-check-circle" style="color:#10b981;margin-left:6px;"></i>';
      } else {
        statusEl.innerHTML = 'Extension non d√©tect√©e (donn√©es manquantes) <i class="fas fa-exclamation-triangle" style="color:#f59e0b;margin-left:6px;"></i>';
      }
    }

    function openExtensionGuide() {
      alert("Connexion extension (exemple) :\n\n1) Installe l‚Äôextension GabaritKDP Tracker\n2) Ouvre KDP Reports\n3) Clique 'Sync' dans l‚Äôextension\n4) Reviens sur ce dashboard et clique 'Actualiser'\n\nEnsuite : tes ventes, revenus et livres s‚Äôaffichent automatiquement.");
    }

    function initializeCharts() {
      const revenueCtx = document.getElementById('revenueChart');
      const marketCtx = document.getElementById('marketplaceChart');
      if (!revenueCtx || !marketCtx || typeof Chart === 'undefined') return;

      if (revenueChart) revenueChart.destroy();
      if (marketplaceChart) marketplaceChart.destroy();

      revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Revenus', data: [], tension: 0.35 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#aaaaaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
            y: { ticks: { color: '#aaaaaa' }, grid: { color: 'rgba(255,255,255,0.05)' } }
          }
        }
      });

      marketplaceChart = new Chart(marketCtx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'Ventes', data: [] }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#aaaaaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
            y: { ticks: { color: '#aaaaaa' }, grid: { color: 'rgba(255,255,255,0.05)' } }
          }
        }
      });
    }

    function mockDataForPeriod(period) {
      // Simple placeholder data. Replace by real data from your tracker/backend.
      const now = new Date();
      let points = 30;
      if (period === '7d') points = 7;
      if (period === '90d') points = 12;
      if (period === '1y') points = 12;

      const labels = [];
      const values = [];
      for (let i = points-1; i >= 0; i--) {
        const d = new Date(now);
        if (period === '1y' || period === '90d') d.setMonth(now.getMonth() - i);
        else d.setDate(now.getDate() - i);
        labels.push(period === '1y' || period === '90d'
          ? d.toLocaleDateString('fr-FR', { month: 'short' })
          : d.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit' })
        );
        values.push(0);
      }
      const marketplace = {
        labels: ['US','UK','DE','FR','ES','IT','CA','AU','JP'],
        values: [0,0,0,0,0,0,0,0,0]
      };
      return { labels, values, marketplace };
    }

    function updateChartsWith(data) {
      if (revenueChart) {
        revenueChart.data.labels = data.labels;
        revenueChart.data.datasets[0].data = data.values;
        revenueChart.update();
      }
      if (marketplaceChart) {
        marketplaceChart.data.labels = data.marketplace.labels;
        marketplaceChart.data.datasets[0].data = data.marketplace.values;
        marketplaceChart.update();
      }
    }

    function updateChartPeriod(period) {
      currentPeriod = period;
      document.querySelectorAll('.chart-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
      // Activate clicked button (best-effort)
      const btns = Array.from(document.querySelectorAll('.chart-filters .filter-btn'));
      const map = { '7d': 0, '30d': 1, '90d': 2, '1y': 3 };
      if (btns[map[period]]) btns[map[period]].classList.add('active');

      const data = loadFromCacheOrMock(period);
      updateChartsWith(data);
    }

    function loadFromCacheOrMock(period) {
      // Cache format (example):
      // { totals:{ revenueEUR, sales, activeBooks, topBookTitle, topBookRevenueEUR },
      //   revenueSeries:{ labels:[], values:[] },
      //   marketplace:{ labels:[], values:[] },
      //   books:[{title, marketplace, revenueEUR, sales, performance}] }
      try {
        const raw = localStorage.getItem('gkdp_sales_cache_v1');
        if (raw) {
          const parsed = JSON.parse(raw);
          // KPI
          if (parsed.totals) {
            document.getElementById('totalRevenue').textContent = formatCurrencyEUR(parsed.totals.revenueEUR);
            document.getElementById('totalSales').textContent = parsed.totals.sales ?? 0;
            document.getElementById('activeBooks').textContent = parsed.totals.activeBooks ?? 0;
            document.getElementById('topBook').textContent = parsed.totals.topBookTitle || '--';
            document.getElementById('topBookRevenue').textContent = formatCurrencyEUR(parsed.totals.topBookRevenueEUR || 0);
          }
          // Books
          if (Array.isArray(parsed.books) && parsed.books.length) {
            renderBooksTable(parsed.books);
          }
          // Series
          const labels = parsed.revenueSeries?.labels || mockDataForPeriod(period).labels;
          const values = parsed.revenueSeries?.values || mockDataForPeriod(period).values;
          const marketplace = parsed.marketplace || mockDataForPeriod(period).marketplace;

          return { labels, values, marketplace };
        }
      } catch (e) {
        console.warn('cache parse error', e);
      }
      return mockDataForPeriod(period);
    }

    function renderBooksTable(books) {
      const container = document.getElementById('booksTableContainer');
      const empty = document.getElementById('booksEmptyState');
      if (empty) empty.style.display = 'none';

      const rows = books.map(b => {
        const perf = (b.performance || 'medium').toLowerCase();
        const perfLabel = perf === 'high' ? 'üî• Fort' : perf === 'low' ? '‚ö†Ô∏è Faible' : '‚úÖ Moyen';
        return `
          <tr>
            <td><div class="book-title" title="${(b.title || '').replace(/"/g,'&quot;')}">${b.title || '--'}</div></td>
            <td><span class="marketplace-badge">${b.marketplace || '--'}</span></td>
            <td>${formatCurrencyEUR(b.revenueEUR || 0)}</td>
            <td>${b.sales ?? 0}</td>
            <td>
              <div class="performance-indicator ${perf}">
                <i class="fas fa-chart-line"></i>
                <span>${perfLabel}</span>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="books-table">
          <thead>
            <tr>
              <th>Livre</th>
              <th>Marketplace</th>
              <th>Revenus</th>
              <th>Ventes</th>
              <th>Performance</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', () => {
          const q = searchInput.value.toLowerCase();
          container.querySelectorAll('tbody tr').forEach(tr => {
            const title = (tr.querySelector('.book-title')?.textContent || '').toLowerCase();
            tr.style.display = title.includes(q) ? '' : 'none';
          });
        });
      }
    }

    function refreshData() {
      const btn = document.getElementById('refreshBtn');
      if (btn) btn.disabled = true;

      // In real life: fetch your backend endpoint that your extension updates
      // Example: GET /api/kdp/summary (authenticated)
      // For now: just reload from cache.
      setTimeout(() => {
        checkExtensionStatus();
        setSyncTimeNow();
        const data = loadFromCacheOrMock(currentPeriod);
        updateChartsWith(data);
        if (btn) btn.disabled = false;
      }, 300);
    }

    // =============================
    // Boussole 2026 (market reports)
    // =============================
    const marketReports = {
      FR: {
        volume: "√âlev√©",
        confidence: "Moyenne",
        winners: ["Dark Romance", "Romantasy", "Essais & politique", "Bien‚Äë√™tre cibl√©"],
        angles: ["S√©ries (tomes)", "Tropes + promesse claire", "Couvertures tr√®s codifi√©es", "Optimisation mots-cl√©s longue tra√Æne"],
        keywords: ["dark romance", "romantasy", "thriller politique", "essai politique", "journal guid√©", "planner", "gratitude"],
        next: ["Identifier 3 sous‚Äëniches", "Analyser 20 couvertures best-sellers", "D√©finir 30 mots-cl√©s longue tra√Æne", "Pr√©parer 1 couverture + 1 int√©rieur"]
      },
      US: {
        volume: "Tr√®s √©lev√©",
        confidence: "Moyenne",
        winners: ["Romance (tropes)", "Fantasy / Romantasy", "Self‚Äëhelp niche", "Journals / planners"],
        angles: ["Couverture orient√©e trope", "Titre tr√®s explicite", "S√©ries + rapid release", "Ads: test auto ‚Üí manuel"],
        keywords: ["romantasy", "sports romance", "college romance", "gratitude journal", "prompt journal", "guided journal"],
        next: ["Choisir 1 niche", "Cr√©er 3 variations de couvertures", "Lister 50 keywords", "Lancer 1 campagne auto (petit budget)"]
      }
      // Ajoute DE/UK/ES‚Ä¶ au fur et √† mesure
    };

    function renderMarketReport() {
      const sel = document.getElementById('marketReportSelect');
      const container = document.getElementById('marketReportContainer');
      if (!sel || !container) return;

      const key = sel.value;
      const r = marketReports[key] || {
        volume: "√Ä d√©finir",
        confidence: "Faible",
        winners: ["√Ä renseigner"],
        angles: ["√Ä renseigner"],
        keywords: ["√Ä renseigner"],
        next: ["√Ä renseigner"]
      };

      container.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;">
          <div style="background:linear-gradient(135deg,var(--brand-light),var(--brand-lighter));border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:18px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <div style="font-weight:800;">R√©sum√© 2025</div>
              <div style="font-size:13px;color:var(--text-secondary);">Volume: <strong style="color:var(--brand-primary);">${r.volume}</strong></div>
            </div>
            <div style="color:var(--text-secondary);font-size:13px;margin-bottom:10px;">Confiance tendance: <strong style="color:var(--brand-primary);">${r.confidence}</strong></div>
            <div style="font-weight:700;margin-bottom:8px;">Ce qui a port√© le march√©</div>
            <ul style="margin-left:18px;line-height:1.7;color:var(--text-primary);">
              ${r.winners.map(x => `<li>${x}</li>`).join('')}
            </ul>
          </div>

          <div style="background:linear-gradient(135deg,var(--brand-light),var(--brand-lighter));border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:18px;">
            <div style="font-weight:800;margin-bottom:10px;">Angles gagnants (KDP)</div>
            <ul style="margin-left:18px;line-height:1.7;color:var(--text-primary);">
              ${r.angles.map(x => `<li>${x}</li>`).join('')}
            </ul>
            <div style="margin-top:12px;color:var(--text-secondary);font-size:13px;">
              Astuce : ces angles servent √† choisir <strong>couvertures</strong>, <strong>int√©rieurs</strong>, <strong>mots-cl√©s</strong> et <strong>Ads</strong>.
            </div>
          </div>

          <div style="background:linear-gradient(135deg,var(--brand-light),var(--brand-lighter));border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:18px;">
            <div style="font-weight:800;margin-bottom:10px;">Mots-cl√©s √† travailler</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px;">
              ${r.keywords.map(k => `<span style="padding:6px 10px;border-radius:999px;background:rgba(255,153,0,0.12);border:1px solid var(--border);color:var(--brand-primary);font-weight:700;font-size:12px;">${k}</span>`).join('')}
            </div>
            <div style="margin-top:12px;font-size:13px;color:var(--text-secondary);">
              Objectif : constituer une liste longue tra√Æne (30‚Äì80) puis tester en titres/sous-titres/Ads.
            </div>
          </div>

          <div style="background:linear-gradient(135deg,var(--brand-light),var(--brand-lighter));border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:18px;">
            <div style="font-weight:800;margin-bottom:10px;">Plan d‚Äôaction 2026</div>
            <ol style="margin-left:18px;line-height:1.7;color:var(--text-primary);">
              ${r.next.map(x => `<li>${x}</li>`).join('')}
            </ol>
          </div>
        </div>
      `;
    }

    document.addEventListener('DOMContentLoaded', () => {
      checkExtensionStatus();
      setSyncTimeNow();
      initializeCharts();
      const data = loadFromCacheOrMock(currentPeriod);
      updateChartsWith(data);
      renderMarketReport();
    });
  </script>


  <script>
    // üéØ DONN√âES MOCK√âES - PHASE 1
    // Ces donn√©es sont des estimations bas√©es sur analyses de march√© 2025
    const nichesData = [
      {
        emoji: 'üìî',
        name: 'Planners 2025',
        market: 'USA',
        type: 'Planner',
        demand: 85,
        competition: 65,
        bsr: 15000,
        isLowComp: false
      },
      {
        emoji: 'üé®',
        name: 'Dog Coloring Books',
        market: 'USA',
        type: 'Coloring book',
        demand: 78,
        competition: 45,
        bsr: 28000,
        isLowComp: true
      },
      {
        emoji: 'üìì',
        name: 'Gratitude Journals',
        market: 'USA',
        type: 'Journal',
        demand: 82,
        competition: 70,
        bsr: 22000,
        isLowComp: false
      },
      {
        emoji: 'üå∏',
        name: 'Floral Activity Books',
        market: 'USA',
        type: 'Activity book',
        demand: 65,
        competition: 35,
        bsr: 45000,
        isLowComp: true
      },
      {
        emoji: 'üìñ',
        name: 'Bullet Journals',
        market: 'USA',
        type: 'Journal',
        demand: 88,
        competition: 75,
        bsr: 18000,
        isLowComp: false
      },
      {
        emoji: 'üéØ',
        name: 'Goal Setting Planners',
        market: 'USA',
        type: 'Planner',
        demand: 75,
        competition: 55,
        bsr: 32000,
        isLowComp: false
      },
      {
        emoji: 'üê±',
        name: 'Cat Coloring Books',
        market: 'USA',
        type: 'Coloring book',
        demand: 72,
        competition: 40,
        bsr: 35000,
        isLowComp: true
      },
      {
        emoji: '‚úçÔ∏è',
        name: 'Writing Journals',
        market: 'USA',
        type: 'Journal',
        demand: 68,
        competition: 50,
        bsr: 38000,
        isLowComp: false
      },
      {
        emoji: 'üå∫',
        name: 'Mandala Coloring',
        market: 'USA',
        type: 'Coloring book',
        demand: 80,
        competition: 60,
        bsr: 25000,
        isLowComp: false
      },
      {
        emoji: 'üìÖ',
        name: 'Daily Planners',
        market: 'USA',
        type: 'Planner',
        demand: 90,
        competition: 80,
        bsr: 12000,
        isLowComp: false
      },
      {
        emoji: 'üìî',
        name: 'Planners 2025',
        market: 'France',
        type: 'Planner',
        demand: 70,
        competition: 45,
        bsr: 35000,
        isLowComp: true
      },
      {
        emoji: 'üé®',
        name: 'Coloriages Adultes',
        market: 'France',
        type: 'Coloring book',
        demand: 75,
        competition: 50,
        bsr: 28000,
        isLowComp: false
      },
      {
        emoji: 'üìì',
        name: 'Carnets de Gratitude',
        market: 'France',
        type: 'Journal',
        demand: 65,
        competition: 35,
        bsr: 42000,
        isLowComp: true
      },
      {
        emoji: 'üìñ',
        name: 'Bullet Journals FR',
        market: 'France',
        type: 'Journal',
        demand: 72,
        competition: 55,
        bsr: 32000,
        isLowComp: false
      },
      {
        emoji: 'üå∏',
        name: 'Coloriages Fleurs',
        market: 'France',
        type: 'Coloring book',
        demand: 68,
        competition: 40,
        bsr: 38000,
        isLowComp: true
      },
      {
        emoji: 'üìö',
        name: 'Romance Contemporaine',
        market: 'France',
        type: 'Roman',
        demand: 85,
        competition: 75,
        bsr: 18000,
        isLowComp: false
      },
      {
        emoji: 'üîÆ',
        name: 'Fantasy Romance',
        market: 'France',
        type: 'Roman',
        demand: 78,
        competition: 60,
        bsr: 25000,
        isLowComp: false
      },
      {
        emoji: 'üíº',
        name: 'D√©veloppement Personnel',
        market: 'France',
        type: 'Non-fiction',
        demand: 80,
        competition: 65,
        bsr: 22000,
        isLowComp: false
      },
      {
        emoji: 'üéØ',
        name: 'Objectifs & Motivation',
        market: 'France',
        type: 'Non-fiction',
        demand: 70,
        competition: 45,
        bsr: 35000,
        isLowComp: true
      },
      {
        emoji: 'üåü',
        name: 'Kids Story Books',
        market: 'USA',
        type: 'Activity book',
        demand: 82,
        competition: 70,
        bsr: 20000,
        isLowComp: false
      }
    ];

    // Fonction de calcul du score de niche
    function calculateNicheScore(demand, competition, bsr) {
      // Normalisation des valeurs
      const demandScore = Math.min(Math.max(demand, 0), 100);
      const competitionScore = 100 - Math.min(Math.max(competition, 0), 100);
      
      // Normalisation BSR (plus bas = mieux)
      const bsrNormalized = Math.max(10000, Math.min(bsr, 1000000));
      const bsrScore = 100 - ((bsrNormalized - 10000) / (1000000 - 10000)) * 100;

      // Calcul pond√©r√©
      const score = (0.4 * demandScore) + (0.3 * competitionScore) + (0.3 * bsrScore);
      
      return Math.round(Math.min(Math.max(score, 0), 100));
    }

    // Fonction pour d√©terminer les badges automatiques
    function getNicheBadges(score, demand, competition, isLowComp) {
      const badges = [];
      
      if (score >= 80) {
        badges.push({ text: 'üî• Tendance', class: 'badge-trend' });
      }
      
      if (isLowComp) {
        badges.push({ text: 'üå± Faible Concurrence', class: 'badge-low-comp' });
      }
      
      if (demand >= 80 && competition <= 50) {
        badges.push({ text: 'üíé P√©pite', class: 'badge-gem' });
      }
      
      return badges;
    }

    // Fonction pour afficher les niches
    function displayNiches(nichesToDisplay) {
      const tbody = document.getElementById('nichesBody');
      tbody.innerHTML = '';

      nichesToDisplay.forEach(niche => {
        const score = calculateNicheScore(niche.demand, niche.competition, niche.bsr);
        const badges = getNicheBadges(score, niche.demand, niche.competition, niche.isLowComp);
        
        // D√©terminer la couleur du score
        let scoreClass = 'score-red';
        let statusBadge = '<span class="badge badge-hot">‚ö†Ô∏è Satur√©</span>';
        if (score >= 70) {
          scoreClass = 'score-green';
          statusBadge = '<span class="badge badge-hot">üî• Opportunit√©</span>';
        } else if (score >= 40) {
          scoreClass = 'score-orange';
          statusBadge = '<span class="badge badge-good">üí° √Ä Creuser</span>';
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="niche-name">
              <span class="niche-emoji">${niche.emoji}</span>
              ${niche.name}
            </div>
          </td>
          <td>${niche.market === 'USA' ? 'üá∫üá∏ USA' : 'üá´üá∑ France'}</td>
          <td>${niche.type}</td>
          <td>${niche.demand >= 75 ? '√âlev√©e' : niche.demand >= 50 ? 'Moyenne' : 'Faible'}</td>
          <td>${niche.competition >= 70 ? 'Forte' : niche.competition >= 40 ? 'Moyenne' : 'Faible'}</td>
          <td>${niche.bsr.toLocaleString()}</td>
          <td class="score-cell ${scoreClass}">${score}/100</td>
          <td>
            ${statusBadge}
            ${badges.map(b => `<span class="badge ${b.class}">${b.text}</span>`).join('')}
          </td>
        `;
        tbody.appendChild(row);
      });

      updateMotivationalMessage(nichesToDisplay.length);
    }

    // Fonction pour mettre √† jour le message motivant
    function updateMotivationalMessage(count) {
      const msgDiv = document.getElementById('motivationalMsg');
      
      if (count === 0) {
        msgDiv.innerHTML = 'üîç <strong>Aucune niche trouv√©e avec ces crit√®res.</strong> Ajuste un peu tes filtres : la bonne niche n\'est jamais loin quand tu continues d\'explorer.';
      } else if (count >= 10) {
        msgDiv.innerHTML = 'üéâ <strong>Bien jou√©, tu viens de faire ressortir les niches les plus prometteuses.</strong> Tu n\'as pas besoin de toutes les exploiter. Une seule peut d√©j√† faire une √©norme diff√©rence.';
      } else if (count <= 5) {
        msgDiv.innerHTML = 'üíé <strong>Peu de r√©sultats, c\'est souvent peu de concurrence.</strong> Si une niche te parle, tu peux devenir la r√©f√©rence sur ce sujet.';
      } else {
        msgDiv.innerHTML = 'üí° <strong>Chaque ligne est une opportunit√©.</strong> Ta mission : rep√©rer celles qui te donnent envie de cr√©er‚Ä¶ et ne plus les laisser dormir dans un tableau.';
      }
    }

    // Fonction d'application des filtres
    function applyFilters() {
      const market = document.getElementById('filterMarket').value;
      const type = document.getElementById('filterType').value;
      const minScore = parseInt(document.getElementById('filterScore').value) || 0;
      const lowCompOnly = document.getElementById('filterLowComp').checked;

      let filtered = nichesData.filter(niche => {
        const score = calculateNicheScore(niche.demand, niche.competition, niche.bsr);
        
        if (market && niche.market !== market) return false;
        if (type && niche.type !== type) return false;
        if (score < minScore) return false;
        if (lowCompOnly && !niche.isLowComp) return false;
        
        return true;
      });

      displayNiches(filtered);
      updateFilterStats(filtered.length, nichesData.length);
    }

    // Fonction pour mettre √† jour les statistiques de filtrage
    function updateFilterStats(shown, total) {
      const statsDiv = document.getElementById('filterStats');
      
      if (shown === total) {
        statsDiv.innerHTML = `üìä Toutes les ${total} niches affich√©es`;
      } else {
        const greenCount = shown;
        statsDiv.innerHTML = `‚úÖ ${shown} niche${shown > 1 ? 's' : ''} trouv√©e${shown > 1 ? 's' : ''} sur ${total} ¬∑ ${greenCount} opportunit√©${greenCount > 1 ? 's' : ''} √† saisir`;
      }
    }

    // Initialisation au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
      displayNiches(nichesData);
      updateFilterStats(nichesData.length, nichesData.length);
    });
  </script>


  </div><!-- /#dashboardSection -->

  <!-- BESTSELLERS SECTION -->
  <div id="bestsellersSection" class="gkdp-section" style="padding: 24px 16px;">
    <div style="max-width:1200px;margin:0 auto;">
      <h2 style="margin:0 0 10px 0;color:#ffd27a;">Top Bestsellers par sous-cat√©gories (2 niveaux)</h2>
      <div style="color:#c9c9c9;font-size:13px;line-height:1.45;margin-bottom:14px;">
        Source: <code style="color:#fff2cc;">fr_books_top30_2levels.csv</code> (√† placer √† c√¥t√© du HTML).<br>
        Remarque: si tu ouvres en <code>file://</code>, Chrome bloque souvent le <code>fetch</code> du CSV. Utilise un petit serveur local (instructions ci-dessous).
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-bottom:14px;">
        <div>
          <div style="color:#c9c9c9;font-size:12px;margin-bottom:6px;">Niveau 1 (cat√©gorie)</div>
          <select id="bsLevel1" style="min-width:240px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,215,0,0.25);background:#111;color:#fff;"></select>
        </div>
        <div>
          <div style="color:#c9c9c9;font-size:12px;margin-bottom:6px;">Niveau 2 (sous-cat√©gorie)</div>
          <select id="bsLevel2" style="min-width:260px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,215,0,0.25);background:#111;color:#fff;"></select>
        </div>
        <div>
          <div style="color:#c9c9c9;font-size:12px;margin-bottom:6px;">Rechercher</div>
          <input id="bsSearch" placeholder="titre / auteur..." style="min-width:240px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,215,0,0.25);background:#111;color:#fff;" />
        </div>
        <button id="bsReload" type="button" style="padding:10px 14px;border-radius:12px;border:1px solid rgba(255,215,0,0.35);background:rgba(255,165,0,0.18);color:#fff2cc;font-weight:700;cursor:pointer;">
          Recharger CSV
        </button>
        <div id="bsStatus" style="margin-left:auto;color:#c9c9c9;font-size:12px;"></div>
      </div>

      <div style="overflow:auto;border:1px solid rgba(255,215,0,0.18);border-radius:14px;">
        <table id="bsTable" style="width:100%;border-collapse:collapse;min-width:980px;background:#0e0e0e;">
          <thead>
            <tr>
              <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,215,0,0.18);color:#fff2cc;">#</th>
              <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,215,0,0.18);color:#fff2cc;">Titre</th>
              <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,215,0,0.18);color:#fff2cc;">Auteur</th>
              <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,215,0,0.18);color:#fff2cc;">Note</th>
              <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,215,0,0.18);color:#fff2cc;">Avis</th>
              <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,215,0,0.18);color:#fff2cc;">Prix</th>
              <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,215,0,0.18);color:#fff2cc;">Lien</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:14px;color:#c9c9c9;font-size:13px;">
        <b>Serveur local (recommand√©)</b><br>
        1) Ouvre PowerShell dans le dossier o√π se trouvent le HTML + CSV<br>
        2) Lance: <code style="color:#fff2cc;">python -m http.server 8000</code><br>
        3) Ouvre: <code style="color:#fff2cc;">http://localhost:8000/TON_FICHIER.html</code>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // Tabs (Dashboard / Bestsellers)
    // ----------------------------
    (function(){
      function setActiveSection(id){
        document.querySelectorAll('.gkdp-section').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active');

        document.querySelectorAll('.gkdp-tab-btn').forEach(btn => {
          btn.classList.toggle('active', btn.getAttribute('data-target') === id);
        });
      }

      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.gkdp-tab-btn');
        if(!btn) return;
        const id = btn.getAttribute('data-target');
        setActiveSection(id);
        if(id === 'bestsellersSection') {
          // Lazy-load once
          if(!window.__BS_LOADED__) {
            window.__BS_LOADED__ = true;
            loadBestsellersCSV();
          }
        }
      });

      window.setActiveSection = setActiveSection;
    })();

    // ----------------------------
    // CSV parsing (RFC4180-ish)
    // ----------------------------
    function parseCSV(text){
      const rows = [];
      let i = 0, field = '', row = [], inQuotes = false;

      while(i < text.length){
        const c = text[i];

        if(inQuotes){
          if(c === '"'){
            if(text[i+1] === '"'){ field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          } else {
            field += c; i++; continue;
          }
        } else {
          if(c === '"'){ inQuotes = true; i++; continue; }
          if(c === ','){
            row.push(field); field=''; i++; continue;
          }
          if(c === '
'){
            row.push(field); rows.push(row);
            row = []; field=''; i++; continue;
          }
          if(c === '
'){ i++; continue; }
          field += c; i++; continue;
        }
      }
      // last field
      row.push(field);
      rows.push(row);
      return rows;
    }

    function clean(s){ return (s ?? '').toString().trim(); }

    // ----------------------------
    // Bestsellers loader + UI
    // ----------------------------
    let __bsRows = [];
    async function loadBestsellersCSV(){
      const status = document.getElementById('bsStatus');
      const file = 'fr_books_top30_2levels.csv';

      try{
        status.textContent = 'Chargement...';
        const res = await fetch(file, { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();

        const parsed = parseCSV(text);
        const header = parsed.shift().map(h => clean(h));
        const idx = Object.fromEntries(header.map((h, i) => [h, i]));

        const needed = ['marketplace','level1_category','level2_category','rank','title','author','rating','reviews','price','url'];
        for(const k of needed){
          if(!(k in idx)){
            throw new Error('CSV: colonne manquante: ' + k);
          }
        }

        __bsRows = parsed
          .filter(r => r.length >= header.length)
          .map(r => ({
            marketplace: clean(r[idx.marketplace]),
            level1: clean(r[idx.level1_category]) || '‚Äî',
            level2: clean(r[idx.level2_category]) || '‚Äî',
            rank: Number(clean(r[idx.rank]) || 0),
            title: clean(r[idx.title]),
            author: clean(r[idx.author]),
            rating: clean(r[idx.rating]),
            reviews: clean(r[idx.reviews]),
            price: clean(r[idx.price]),
            url: clean(r[idx.url]),
          }))
          .filter(x => x.title);

        buildBestsellersFilters();
        renderBestsellersTable();
        status.textContent = `OK ‚Äî ${__bsRows.length} lignes`;
      } catch(err){
        console.error(err);
        status.textContent = 'Erreur CSV: ' + (err?.message || err);
        const tbody = document.querySelector('#bsTable tbody');
        tbody.innerHTML = `<tr><td colspan="7" style="padding:14px;color:#ffb3b3;">Impossible de charger ${file}. Ouvre la page via http://localhost (serveur local) ou publie la page.</td></tr>`;
      }
    }

    function buildBestsellersFilters(){
      const level1Sel = document.getElementById('bsLevel1');
      const level2Sel = document.getElementById('bsLevel2');

      const level1Values = Array.from(new Set(__bsRows.map(r => r.level1))).sort((a,b)=>a.localeCompare(b,'fr'));
      level1Sel.innerHTML = ['<option value="">Toutes (niveau 1)</option>']
        .concat(level1Values.map(v => `<option value="${v.replace(/"/g,'&quot;')}">${v}</option>`))
        .join('');

      level2Sel.innerHTML = '<option value="">Toutes (niveau 2)</option>';

      function rebuildLevel2(){
        const l1 = level1Sel.value;
        const filtered = l1 ? __bsRows.filter(r => r.level1 === l1) : __bsRows;
        const level2Values = Array.from(new Set(filtered.map(r => r.level2))).sort((a,b)=>a.localeCompare(b,'fr'));
        level2Sel.innerHTML = ['<option value="">Toutes (niveau 2)</option>']
          .concat(level2Values.map(v => `<option value="${v.replace(/"/g,'&quot;')}">${v}</option>`))
          .join('');
      }

      level1Sel.addEventListener('change', () => { rebuildLevel2(); renderBestsellersTable(); });
      level2Sel.addEventListener('change', renderBestsellersTable);
      document.getElementById('bsSearch').addEventListener('input', renderBestsellersTable);
      document.getElementById('bsReload').addEventListener('click', loadBestsellersCSV);

      rebuildLevel2();
    }

    function renderBestsellersTable(){
      const tbody = document.querySelector('#bsTable tbody');
      const l1 = document.getElementById('bsLevel1')?.value || '';
      const l2 = document.getElementById('bsLevel2')?.value || '';
      const q  = (document.getElementById('bsSearch')?.value || '').toLowerCase();

      let rows = __bsRows.slice();
      if(l1) rows = rows.filter(r => r.level1 === l1);
      if(l2) rows = rows.filter(r => r.level2 === l2);
      if(q) rows = rows.filter(r => (r.title + ' ' + r.author).toLowerCase().includes(q));

      // group by (level1, level2) and keep top 30 by rank
      rows.sort((a,b)=> (a.rank||999) - (b.rank||999));

      const html = rows.map(r => `
        <tr>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);color:#fff2cc;">${r.rank || ''}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);color:#ffffff;">${escapeHtml(r.title)}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);color:#c9c9c9;">${escapeHtml(r.author || '')}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);color:#c9c9c9;">${escapeHtml(r.rating || '')}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);color:#c9c9c9;">${escapeHtml(r.reviews || '')}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);color:#c9c9c9;">${escapeHtml(r.price || '')}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);">
            ${r.url ? `<a href="${r.url}" target="_blank" rel="noopener" style="color:#ffd27a;">Amazon</a>` : ''}
          </td>
        </tr>
      `).join('');

      tbody.innerHTML = html || `<tr><td colspan="7" style="padding:14px;color:#c9c9c9;">Aucun r√©sultat.</td></tr>`;
    }

    function escapeHtml(s){
      return (s ?? '').toString()
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }
  
  // ===== Help / Mode d'emploi (BETA) =====
  (function(){
    const overlay = document.getElementById('gkdpHelpOverlay');
    const btn = document.getElementById('gkdpHelpBtn');
    const closeBtn = document.getElementById('gkdpHelpClose');

    function openHelp(){
      if(!overlay) return;
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden','false');
      // prevent background scroll
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
    }
    function closeHelp(){
      if(!overlay) return;
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden','true');
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
    }

    if(btn) btn.addEventListener('click', openHelp);
    if(closeBtn) closeBtn.addEventListener('click', closeHelp);

    if(overlay){
      overlay.addEventListener('click', (e)=>{
        if(e.target === overlay) closeHelp();
      });
    }
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && overlay && overlay.style.display === 'flex') closeHelp();
    });
  })();

</script>

</body>
</html>
